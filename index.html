<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spatial Cognition & Sign Language Research Study</title>
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --success: #059669;
      --success-light: #10b981;
      --warning: #d97706;
      --warning-light: #f59e0b;
      --info: #0891b2;
      --info-light: #06b6d4;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --text-primary: #111827;
      --text-secondary: #6b7280;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--gray-100);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
      color: var(--text-primary);
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header { background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%); color: white; padding: 40px; text-align: center; }
    .header h1 { font-size: 32px; margin-bottom: 10px; }
    .header p { font-size: 18px; opacity: 0.95; }

    .content { padding: 40px; }

    /* Screens */
    .screen { display: none; animation: fadeIn 0.3s ease-in; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Cards / banners */
    .card { background: var(--gray-50); border-radius: 12px; padding: 30px; margin: 20px 0; border: 2px solid var(--gray-200); transition: all 0.3s; }
    .card:hover { border-color: var(--primary-light); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); transform: translateY(-1px); }

    .info-box {
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .info-box .icon {
      font-size: 20px;
      margin-top: 2px;
      flex-shrink: 0;
    }
    .info-box.time { background: #eff6ff; border-color: var(--info); color: #1e3a8a; }
    .info-box.helpful { background: #f0fdf4; border-color: var(--success); color: #14532d; }
    .info-box.friendly-tip { background: #fef3c7; border-color: var(--warning); color: #92400e; }
    .info-box.important { background: #fef2f2; border-color: #ef4444; color: #991b1b; }

    /* Completion policy callout */
    .policy-callout {
      background: #fff8e1;
      border-left: 6px solid var(--warning);
      padding: 16px 20px;
      border-radius: 10px;
      margin: 12px 0 20px;
    }
    .policy-callout h3 { margin-bottom: 8px; font-size: 16px; letter-spacing: .3px; }
    .policy-callout ul { margin: 8px 0 0 20px; text-align: left; }

    /* Forms */
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
    .form-group input { width: 100%; padding: 12px; border: 2px solid var(--gray-300); border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
    .form-group input:focus { outline: none; border-color: var(--primary); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    /* Buttons */
    .button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 44px;
      text-decoration: none;
    }
    .button:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
    .button:disabled { opacity: 0.5; cursor: not-allowed; }
    .button.secondary { background: var(--gray-100); color: var(--text-primary); border: 1px solid var(--gray-300); }
    .button.secondary:hover:not(:disabled) { background: var(--gray-200); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .button.friendly { background: var(--info); }
    .button.friendly:hover:not(:disabled) { background: var(--info-light); }
    .button.success { background: var(--success); }
    .button.success:hover:not(:disabled) { background: var(--success-light); }
    .button.danger { background: #ef4444; }
    .button.danger:hover:not(:disabled) { background: #dc2626; }
    .button.optional { background: var(--info); }
    .button.optional:hover:not(:disabled) { background: var(--info-light); }
    .button.outline { background: white; color: var(--primary); border: 1px solid var(--primary); }
    .button.outline:hover:not(:disabled) { background: var(--primary-light); color: white; }
    .button-group { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; justify-content: center; }

    /* Session widget */
    .session-widget { background: linear-gradient(135deg, #2563eb20, #1d4ed820); border-radius: 10px; padding: 20px; margin-bottom: 30px; display: none; }
    .session-widget.active { display: block; }
    .session-widget h3 { color: var(--primary); margin-bottom: 15px; font-size: 18px; }
    .session-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .session-detail { background: white; padding: 10px 15px; border-radius: 8px; border-left: 3px solid var(--primary); }
    .session-detail label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    .session-detail .value { font-size: 16px; font-weight: bold; color: var(--text-primary); margin-top: 3px; }

    /* Code display */
    .code-display { background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%); color: white; padding: 30px; border-radius: 10px; text-align: center; margin: 20px 0; }
    .code-display .code { font-size: 36px; font-weight: bold; letter-spacing: 3px; margin: 15px 0; font-family: monospace; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }

    /* Consent grid */
    .consent-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    .consent-card { background: white; border: 2px solid var(--gray-200); border-radius: 10px; padding: 20px; text-align: center; transition: all 0.3s; position: relative; }
    #consent1-card { background:#f9f9ff; }
    #consent2-card { background:#f9f9f4; }
    .consent-card::after { content:'○'; position:absolute; top:10px; right:10px; font-size:24px; color:#bbb; }
    .consent-card.completed { border-color: var(--success); background: #f1f8f4; }
    .consent-card.completed::after { content:'✔'; color:var(--success); }
    .consent-card.declined { border-color: var(--warning); background: #fff9e6; }
    .consent-card.declined::after { content:'✖'; color:var(--warning); }
    .consent-card .status-icon { font-size: 48px; margin-bottom: 15px; }
    .consent-card h4 { color: var(--text-primary); margin-bottom: 10px; }
    .consent-card p { color: var(--text-secondary); font-size: 14px; margin-bottom: 15px; }
    .optional-info summary { cursor: pointer; font-weight: 600; }

    /* Tasks list */
    .task-list { list-style: none; margin: 20px 0; }
    .task-item { padding: 20px; margin: 12px 0; background: white; border-radius: 10px; border-left: 6px solid var(--gray-300); display: flex; align-items: center; justify-content: space-between; transition: all 0.3s; }
    .task-item:hover { box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    .task-item.completed { border-left-color: var(--success); background: #f1f8f4; }
    .task-item.current { border-left-color: var(--info); background: #e3f2fd; font-weight: bold; animation: pulse-blue 1.5s infinite; }
    .task-item.locked { opacity: 0.5; }
    @keyframes pulse-blue { 0%,100% { box-shadow: 0 0 0 0 rgba(33,150,243,0.4); } 50% { box-shadow: 0 0 10px 2px rgba(33,150,243,0.4); } }
    .task-info { flex: 1; }
    .task-name { font-size: 16px; color: var(--text-primary); margin-bottom: 5px; }
    .task-description { font-size: 13px; color: var(--text-secondary); }
    .task-badge { background: #eceff1; color: #444; border-radius: 20px; padding: 4px 10px; font-size: 12px; margin-left: 10px; }
    .task-status { font-size: 24px; margin-left: 20px; }

    /* Progress bar */
    .progress-bar { background: var(--gray-200); height: 30px; border-radius: 15px; overflow: hidden; margin: 20px 0; position: relative; }
    .progress-bar.sticky { position: sticky; top:0; z-index:100; }
    .progress-fill { background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%); height: 100%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; }
    .step-indicator { text-align: center; font-size: 14px; color: var(--text-secondary); margin-top: 8px; }
    .breadcrumbs { text-align:center; font-size:14px; color: var(--text-secondary); margin-top:4px; }

    /* Video section */
    .video-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0; }
    .video-panel { text-align: center; }
    .video-panel h3 { color: var(--text-primary); margin-bottom: 15px; }
    #video-preview, #recorded-video { width: 100%; max-width: 500px; height: 375px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: #000; }
    #video-preview { border: 2px solid var(--success); transform: scaleX(-1); }
    #recorded-video { border: 2px solid var(--info); }
    .recording-controls { margin-top: 20px; padding: 20px; background: var(--gray-50); border-radius: 10px; }
    .recording-status { margin: 15px 0; font-size: 18px; font-weight: bold; }
    .recording-status.ready { color: var(--text-secondary); }
    .recording-status.recording { color: #ef4444; animation: pulse 1.5s infinite; }
    .recording-status.recorded { color: var(--success); }
    @keyframes pulse { 0%,100% {opacity:1} 50% {opacity:.5} }

    /* Upload progress indicator */
    #upload-progress { margin: 15px 0; padding: 15px; background: var(--gray-100); border-radius: 8px; display: none; }
    .upload-progress-bar { background: var(--gray-200); height: 8px; border-radius: 4px; overflow: hidden; margin: 10px 0; }
    #upload-progress-fill { background: var(--primary); height: 100%; width: 0%; transition: width 0.3s; }

    /* Modals */
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background-color: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 500px; text-align: center; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Footer */
    .footer { background: var(--gray-50); padding: 30px; text-align: center; color: var(--text-secondary); }

    /* FAB */
    .fab { position: fixed; bottom: 30px; right: 30px; z-index: 1000; background: var(--warning); color: white; border: none; padding: 15px 25px; border-radius: 50px; font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: none; transition: all 0.3s; }
    .fab.active { display: block; }
    .fab:hover { transform: scale(1.05); }

    /* Embed shells */
    .embed-shell { background: #0b0b0b; border: 2px solid var(--gray-300); border-radius: 12px; overflow: hidden; margin-top: 16px; }
    .fs-toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; background:#111827; color:#e5e7eb; font-size:14px; }
    .fs-toolbar .actions { display:flex; gap:8px; }
    .embed-frame { width: 100%; height: 75vh; border: none; display: block; background: #000; }
    .embed-note { color: #6b7280; font-size: 12px; padding: 8px 12px; background: #0f172a; }
    .fs-shell:fullscreen .embed-frame { height: calc(100vh - 52px); }
    .fs-shell:-webkit-full-screen .embed-frame { height: calc(100vh - 52px); }

    /* Distraction-free fallback */
    html.df-mode, html.df-mode body { height:100%; }
    html.df-mode body { overflow:hidden; position:fixed; left:0; right:0; }
    html.df-mode .container { width:100vw; height:100vh; border-radius:0; box-shadow:none; }
    html.df-mode .header, html.df-mode .footer, html.df-mode #task-instructions { display:none !important; }
    html.df-mode .embed-frame { height: calc(100vh - 52px); }

    /* Responsive */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .container { border-radius: 0; margin: 0; }
      .header { padding: 20px; }
      .header h1 { font-size: 24px; }
      .header p { font-size: 16px; }
      .content { padding: 20px; }
      .card { padding: 20px; }
      .modal-content { padding: 20px; }
      .form-row, .consent-grid, .video-container { grid-template-columns: 1fr; }
      .session-details { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
      .button { width: 100%; }
      .embed-frame { height: 70vh; }
    }
  </style>

</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Spatial Cognition & Sign Language Research Study</h1>
      <p>Gallaudet University Research Project</p>
    </div>

    <div class="content">
      <div id="live-status" role="status" aria-live="polite" class="sr-only"></div>
      <div id="top-progress" class="progress-bar sticky"><div id="top-progress-fill" class="progress-fill" style="width:0%">0%</div></div>
      <div id="step-indicator" class="step-indicator"></div>
      <div id="breadcrumbs" class="breadcrumbs"></div>

      <!-- Session Widget -->
      <div class="session-widget" id="session-widget">
        <h3>📊 Your Session</h3>
        <div class="session-details">
          <div class="session-detail">
            <label>Resume Code</label>
            <div class="value" id="widget-code">-</div>
          </div>
          <div class="session-detail">
            <label>Progress</label>
            <div class="value" id="widget-progress">0/7</div>
          </div>
          <div class="session-detail">
            <label>Time Spent</label>
            <div class="value" id="widget-time">0 min</div>
          </div>
          <div class="session-detail">
            <label>Current Task</label>
            <div class="value" id="widget-current">-</div>
          </div>
        </div>
      </div>

      <!-- Welcome -->
      <div class="screen active" id="welcome-screen">
  <h2 style="text-align: center; margin-bottom: 24px; font-size: 28px; color: var(--text-primary);">
    Welcome! Let's Get Started
  </h2>

  <div class="info-box time">
    <div class="icon">⏱️</div>
    <div>
      <h4 style="margin-bottom: 8px; font-weight: 600;">About 45-60 minutes total</h4>
      <p style="margin: 0; color: inherit;">You can pause anytime and return later. Your progress saves automatically after each task.</p>
    </div>
  </div>

  <div class="info-box helpful">
    <div class="icon">💡</div>
    <div>
      <h4 style="margin-bottom: 8px; font-weight: 600;">How it works</h4>
      <ul style="margin: 8px 0 0 0; padding-left: 16px; color: inherit;">
        <li>Get your unique resume code to save progress</li>
        <li>Complete tasks at your own pace</li>
        <li>Return anytime using your code</li>
      </ul>
    </div>
  </div>

  <div class="info-box friendly-tip">
    <div class="icon">🤝</div>
    <div>
      <h4 style="margin-bottom: 8px; font-weight: 600;">Need help?</h4>
      <p style="margin: 0; color: inherit;">
        Having technical issues or need accommodations?
        <strong>We're here to help you succeed!</strong>
      </p>
      <div style="margin-top: 12px;">
        <button class="button secondary" onclick="openSupportEmail()" style="font-size: 14px; padding: 8px 16px;">
          📧 Email Technical Support
        </button>
      </div>
    </div>
  </div>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 32px;">
    <div class="card">
      <div style="text-align: center;">
        <div style="font-size: 48px; margin-bottom: 16px;">🆕</div>
        <h3 style="margin-bottom: 12px; font-size: 20px;">New Participant</h3>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
          Start fresh and get your unique session code
        </p>
        <button class="button" onclick="showScreen('new-participant')">
          Get Started →
        </button>
      </div>
    </div>

    <div class="card">
      <div style="text-align: center;">
        <div style="font-size: 48px; margin-bottom: 16px;">🔄</div>
        <h3 style="margin-bottom: 12px; font-size: 20px;">Returning Participant</h3>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
          Continue where you left off with your code
        </p>
        <button class="button secondary" onclick="showScreen('returning-participant')">
          Resume Session →
        </button>
      </div>
    </div>
  </div>

  <!-- EEG section - prominent but friendly -->
  <div class="card" style="margin-top: 32px; border: 2px solid var(--info); background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
    <div style="text-align: center;">
      <div style="font-size: 48px; margin-bottom: 16px;">🧠</div>
      <h3 style="margin-bottom: 12px; font-size: 22px; color: var(--primary-dark);">
        EEG Session
      </h3>
      <p style="color: var(--text-primary); margin-bottom: 16px; font-size: 16px;">
        <strong>DC/MD/VA area participants:</strong> We'd love to include you in our EEG component! EEG uses small sensors on your scalp to measure brain activity during tasks. The session takes about 30-45 minutes.
      </p>

      <div class="info-box helpful" style="text-align: left; background: rgba(255,255,255,0.7); margin: 16px 0;">
        <div class="icon">⭐</div>
        <div>
          <h4 style="margin-bottom: 8px; font-weight: 600;">Why EEG matters for this research</h4>
          <ul style="margin: 8px 0 0 0; padding-left: 16px; color: inherit;">
            <li>Captures real-time brain responses to spatial tasks</li>
            <li>Helps us understand how deaf and hearing brains process space differently</li>
            <li><strong>Compensation:</strong> $25 for the online portion and $25 for the EEG session (about $50 total), with additional pay if the EEG session runs longer than expected.</li>
            <li>ASL or spoken English available</li>
          </ul>
        </div>
      </div>

      <div class="info-box friendly-tip" style="text-align: left; background: rgba(255,255,255,0.7); margin: 16px 0;">
        <div class="icon">📅</div>
        <div>
          <h4 style="margin-bottom: 8px; font-weight: 600;">Scheduling update</h4>
          <p style="margin: 0; color: inherit;">
            Scheduling for EEG will reopen in late September, but we will keep you updated.
          </p>
        </div>
      </div>

      <div class="button-group" style="margin-top: 20px;">
        <button class="button optional" onclick="requestEEGReminder()">
          📧 Email Me When Scheduling Opens
        </button>
        <button class="button success" onclick="scheduleEEG()" style="font-size: 16px; padding: 14px 28px;">
          🗓️ Schedule My EEG Session
        </button>
        <button class="button friendly" onclick="markEEGScheduled()">
          ✓ I Already Scheduled
        </button>
      </div>

      <p style="margin-top: 12px; font-size: 14px; color: var(--text-secondary);">
        Not in the DC area? No problem! You can still participate in the online portion.
      </p>
    </div>
  </div>
</div>

      <!-- New Participant -->
      <div class="screen" id="new-participant">
        <h2>New Participant Registration</h2>
        <p style="color: var(--text-secondary); margin-bottom: 30px;">Create your unique session to track your progress</p>

        <div class="form-row">
          <div class="form-group">
            <label for="first-initial">First Name Initial</label>
            <input type="text" id="first-initial" maxlength="1" placeholder="J" />
          </div>
          <div class="form-group">
            <label for="last-initial">Last Name Initial</label>
            <input type="text" id="last-initial" maxlength="1" placeholder="D" />
          </div>
        </div>

        <div class="form-group">
          <label for="email">Email (optional - for reminders if you pause)</label>
          <input type="email" id="email" placeholder="your.email@example.com" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="hearing-status">Hearing Status</label>
            <select id="hearing-status">
              <option value="" selected disabled>Select</option>
              <option value="deaf">Deaf</option>
              <option value="hearing">Hearing</option>
            </select>
          </div>
          <div class="form-group">
            <label for="fluency">ASL Fluency</label>
            <select id="fluency">
              <option value="" selected disabled>Select</option>
              <option value="fluent">Fluent</option>
              <option value="non-fluent">Non-fluent</option>
              <option value="non-signer">Non-signer</option>
            </select>
          </div>
        </div>

        <div class="button-group">
          <button class="button primary" id="create-session-btn" onclick="createNewSession()" disabled>Create Session</button>
          <button class="button secondary" onclick="showScreen('welcome-screen')">Back</button>
        </div>
      </div>

      <!-- Returning Participant -->
      <div class="screen" id="returning-participant">
        <h2>Resume Your Session</h2>
        <p style="color: var(--text-secondary); margin-bottom: 30px;">Enter your 8-character code to continue</p>

        <div class="form-group">
          <label for="resume-code">Resume Code</label>
          <input type="text" id="resume-code" maxlength="8" placeholder="ABC12345" style="text-transform: uppercase; font-family: monospace; font-size: 24px; letter-spacing: 2px; text-align: center;" />
        </div>

        <div class="button-group">
          <button class="button primary" onclick="resumeSession()">Resume Session</button>
          <button class="button secondary" onclick="showScreen('welcome-screen')">Back</button>
        </div>
      </div>

      <!-- Session Created -->
      <div class="screen" id="session-created">
        <h2>✅ Session Created Successfully!</h2>
        <div class="code-display">
          <p>Your Resume Code:</p>
          <div class="code" id="display-code">ABC12345</div>
        <button class="button optional outline" onclick="copyCode(this)">📋 Copy Code</button>
          <p style="font-size: 14px; margin-top: 15px;">Save this code to resume anytime</p>
        </div>

        <div class="info-box important">
          <strong>⚠️ Important: Save Your Code!</strong>
          <ul style="margin: 10px 0 0 20px; text-align: left;">
            <li>Write down or screenshot your code</li>
            <li>Use this code to continue from any device</li>
            <li>Progress saves automatically after each task</li>
          </ul>
        </div>

        <button class="button primary" onclick="proceedToConsent()" style="display: block; margin: 20px auto;">
          I've Saved My Code - Continue
        </button>
      </div>

      <div class="screen" id="consent-screen">
  <h2> Consent Forms</h2>
<div class="info-box helpful" id="voluntary-consent-box" style="margin-top: 12px;">
  <strong>IMPORTANT: Please Read</strong>
  <ul style="margin: 8px 0 0 20px; text-align: left;">
    <li>Participation in this research study is <strong>VOLUNTARY</strong>.</li>
    <li>You can withdraw at any time without penalty.</li>
    <li>We aim to compensate all participants fairly for their time.</li>
    <li>We encourage completing all tasks for the best research data.</li>
    <li>Having technical issues or need accommodations? Email us!</li>
  </ul>
</div>

  <!-- NEW: prominent warning -->
  <div class="info-box important" style="margin: 12px 0 20px;">
    <strong>⚠️ IMPORTANT:</strong>
    <p style="margin-top: 8px;">
      You must actually complete these Qualtrics consent forms. Simply clicking “I completed this form”
      without submitting the form will <u>invalidate your participation and compensation</u>.
    </p>
  </div>

  <p style="color: var(--text-secondary); margin-bottom: 16px;">
    If you already completed these in the Qualtrics screener, you can verify with a code (optional) or affirm completion below.
  </p>

  <div class="consent-grid">
    <!-- Consent 1 -->
    <div class="consent-card" id="consent1-card">
      <div class="status-icon">📄</div>
      <h4>Research Consent</h4>
      <p>General study participation consent (required)</p>
      <div class="button-group" style="justify-content:center;">
        <button class="button optional" onclick="openConsent('CONSENT1')">Open Form</button>
        <!-- changed copy -->
        <button class="button outline" onclick="markConsentDone('consent1')">✅ I completed this form</button>
      </div>

      <!-- optional code verify -->
      <details class="optional-info" style="margin-top:12px; text-align:left;">
        <summary>Have a confirmation code?</summary>
        <div class="card" style="margin-top:12px; text-align:left;">
          <label for="consent1-code" style="display:block; font-weight:600; margin-bottom:6px;">Confirmation code (optional)</label>
          <input id="consent1-code" type="text" placeholder="Paste code from Qualtrics (e.g., last 6 of Response ID)"
                 style="width:100%; padding:10px; border:2px solid var(--gray-300); border-radius:8px;">
          <div class="button-group" style="justify-content:flex-start; margin-top:10px;">
            <button class="button secondary" onclick="verifyConsentCode('consent1')">Verify code</button>
          </div>
          <small id="consent1-verify-note" style="display:block; color:var(--text-secondary); margin-top:6px;"></small>
        </div>
      </details>
    </div>

    <!-- Consent 2 -->
    <div class="consent-card" id="consent2-card">
      <div class="status-icon">🎥</div>
      <h4>Video Consent</h4>
      <p>For the image description recording task (optional)</p>
      <div class="button-group" style="justify-content:center;">
        <button class="button optional" onclick="openConsent('CONSENT2')">Open Form</button>
        <!-- changed copy -->
        <button class="button outline" onclick="markConsentDone('consent2')">✅ I completed this form</button>
        <button class="button secondary" onclick="declineVideo()">Decline Video</button>
      </div>

      <!-- optional code verify -->
      <details class="optional-info" style="margin-top:12px; text-align:left;">
        <summary>Have a confirmation code?</summary>
        <div class="card" style="margin-top:12px; text-align:left;">
          <label for="consent2-code" style="display:block; font-weight:600; margin-bottom:6px;">Confirmation code (optional)</label>
          <input id="consent2-code" type="text" placeholder="Paste code from Qualtrics"
                 style="width:100%; padding:10px; border:2px solid var(--gray-300); border-radius:8px;">
          <div class="button-group" style="justify-content:flex-start; margin-top:10px;">
            <button class="button secondary" onclick="verifyConsentCode('consent2')">Verify code</button>
          </div>
          <small id="consent2-verify-note" style="display:block; color:var(--text-secondary); margin-top:6px;"></small>
        </div>
      </details>
    </div>
  </div>

  <div class="info-box helpful" style="margin-top: 10px;">
    <strong>Prefer automatic verification?</strong>
    <p style="margin-top:6px;">
      If your Qualtrics forms redirect back here with a confirmation parameter, we’ll auto-verify them.
      (You can also paste a code above.)
    </p>
  </div>

  <button class="button primary" id="continue-from-consent" onclick="proceedToTasks()" disabled
          style="display: block; margin: 20px auto;">
    Continue to Study Tasks
  </button>
</div>

      <!-- Progress -->
      <div class="screen" id="progress-screen">
        <h2>Your Study Progress</h2>
        <div class="policy-callout" id="completion-policy">
  <h3><strong>For full compensation</strong></h3>
  <ul>
    <li>Please complete all tasks shown below in the order listed.</li>
    <li>Estimated total time: <strong>45–60 minutes</strong>.</li>
    <li>You can pause and resume anytime with your code.</li>
    <li>If you run into any issues, <strong>email us</strong>—we're happy to help!</li>
    <li style="margin-top:6px; color:#444;"><em>Note:</em> If you <em>decline</em> the optional video consent, the video task won’t be required.</li>
  </ul>
</div>

        <div class="info-box friendly-tip" id="tech-vs-intent" style="margin-top: 12px;">
  <strong>🤝 Need help? We're here to help you succeed!</strong>
  <ul style="margin: 8px 0 0 20px; text-align: left;">
    <li>Try refreshing the page</li>
    <li>Try a different browser (Chrome/Firefox recommended)</li>
    <li><button class="button secondary" onclick="openSupportEmail()" style="font-size:14px; padding:6px 12px;">📧 Email Technical Support</button></li>
  </ul>
</div>
        
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"><span id="progress-text">0%</span></div>
        </div>
        <ul class="task-list" id="task-list"></ul>
        <div class="button-group">
          <button class="button primary" id="continue-task-btn" onclick="continueToCurrentTask()">Continue to Current Task</button>
          <button class="button secondary" onclick="pauseSession()">Save & Exit</button>
        </div>
      </div>

      <!-- Task Host -->
      <div class="screen" id="task-screen">
        <h2 id="task-title">Task Title</h2>
        <div id="task-instructions" style="margin: 20px 0;"></div>
        <div id="task-content"></div>
      </div>

      <!-- Recording -->
      <div class="screen" id="recording-screen">
        <h2>Image Description Task</h2>

        <div class="info-box important" id="recording-consent-check" style="display: none;">
          <strong>Video consent required</strong>
          <p>Please complete the video consent form to proceed with this task.</p>
          <div class="button-group" style="margin-top: 10px;">
            <button class="button optional" onclick="openConsent('CONSENT2')">Open Video Consent</button>
            <button class="button secondary" id="skip-recording-consent-btn">Skip Task</button>
          </div>
        </div>

        <div id="recording-content" style="display: none;">
          <div class="info-box helpful">
            <strong>Language for descriptions:</strong>
            <p>If you know ASL, please use ASL. Otherwise, spoken English is fine.</p>
          </div>

          <div style="text-align: center; margin: 20px 0;">
            <span style="background: var(--info); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold;">
              Image <span id="image-number">1</span> of 2
            </span>
          </div>

          <div class="video-container">
            <div class="video-panel">
              <h3>Image to Describe</h3>
              <img id="current-image" src="" alt="Image to describe" style="width: 100%; border-radius: 10px;" />
            </div>

            <div class="video-panel">
              <h3>Your Video</h3>
              <video id="video-preview" autoplay muted playsinline style="display: none;"></video>
              <video id="recorded-video" controls playsinline style="display: none;"></video>

              <div class="recording-controls">
                <div class="recording-status ready" id="recording-status">Ready to record</div>
                <div id="recording-timer" style="font-size: 24px; color: #ef4444; margin: 10px 0; display: none;">00:00</div>

                <!-- Upload Progress Indicator -->
                <div id="upload-progress">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="flex: 1;">
                      <div style="font-weight: bold; margin-bottom: 5px;">Uploading video to secure storage...</div>
                      <div class="upload-progress-bar">
                        <div id="upload-progress-fill"></div>
                      </div>
                    </div>
                    <div id="upload-status">0%</div>
                  </div>
                </div>

                <div class="button-group">
                  <button class="button danger" id="record-btn" onclick="toggleRecording()">Start Recording</button>
                  <button class="button secondary" id="rerecord-btn" onclick="reRecord()" style="display: none;">Re-record</button>
                  <button class="button success" id="save-recording-btn" onclick="saveRecording()" style="display: none;">Save & Continue</button>
                </div>
              </div>
            </div>
          </div>

          <div class="info-box helpful">
            <strong>What to describe (30–60 seconds):</strong>
            <ul style="margin: 10px 0 0 20px; text-align: left;">
              <li>Objects and people you see</li>
              <li>Where things are located</li>
              <li>What is happening in the image</li>
              <li>Spatial relationships between objects</li>
            </ul>
          </div>

          <div id="recording-error" class="info-box friendly-tip" style="display:none; margin-top: 15px;"></div>

          <div class="card" id="video-upload-fallback" style="margin-top: 15px; display:none;">
            <h3>Upload a short video instead</h3>
            <p>Record 30–60 seconds describing the image on your device, then upload the file here.</p>
            <input type="file" id="video-file-input" accept="video/*" />
            <div class="button-group">
              <button class="button success" id="upload-save-btn" style="display:none;">Use this upload</button>
            </div>
          </div>

          <button class="button secondary" id="skip-recording-btn" style="display: block; margin: 20px auto;">Skip This Task</button>
        </div>
      </div>

      <!-- Completion -->
      <div class="screen" id="completion-screen">
        <div style="text-align: center; padding: 50px;">
          <h2 style="color: var(--success); font-size: 36px; margin-bottom: 20px;">🎉 Study Complete!</h2>
          <p style="font-size: 20px; margin: 20px 0;">Thank you for participating in our research!</p>
          <div class="code-display">
            <p>Your session code was:</p>
            <div class="code" id="final-code">ABC12345</div>
          </div>
          <p style="margin-top: 20px;">Total time: <strong id="total-time">0</strong> minutes</p>
          <div class="button-group" style="margin-top:30px;">
            <button class="button success" id="mark-complete-btn" onclick="markComplete()">Mark Me Complete</button>
          </div>
          <p id="completion-message" style="display:none; margin-top:20px; color: var(--text-secondary);">
            ✅ Your participation has been recorded. You may now close this window.
          </p>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>For technical support: <a href="mailto:action.brain.lab@gallaudet.edu">action.brain.lab@gallaudet.edu</a></p>
      <p style="margin-top: 10px; font-size: 14px;">Your progress is automatically saved after each task.</p>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" id="pause-fab" onclick="pauseSession()">⏸️ Save & Exit</button>

  <!-- Pause Modal -->
  <div class="modal" id="pause-modal">
    <div class="modal-content">
      <h3>Session Saved!</h3>
      <p>Your progress has been saved.</p>
      <div class="code-display">
        <div class="code" id="modal-code">ABC12345</div>
      </div>
      <p style="font-size: 14px; color: var(--text-secondary); margin-top: 20px;">Return anytime to complete remaining tasks.</p>
      <button class="button" onclick="location.reload()">Exit Study</button>
    </div>
  </div>

  <!-- EEG Modal -->
  <div class="modal" id="eeg-modal">
    <div class="modal-content">
      <h3> Local EEG Add-On Information</h3>
      <div class="info-box helpful" style="margin: 20px 0;">
        <strong>Contact the Action Brain Lab:</strong>
        <p style="margin-top: 10px;">
          Email: <strong>action.brain.lab@gallaudet.edu</strong>
          <button class="button optional outline" onclick="copyEmail(this)" style="margin-left: 10px;">Copy Email</button>
        </p>
      </div>

      <div style="text-align: left; background: var(--gray-50); padding: 20px; border-radius: 10px; margin: 20px 0;">
        <strong>Include in your email:</strong>
        <ul style="margin: 10px 0 0 20px;">
          <li>Your session code: <strong id="eeg-session-code">TBD</strong></li>
          <li>That you're interested in the local EEG add-on</li>
          <li>Your preferred days/times for the visit</li>
          <li>Communication preference (ASL or English)</li>
        </ul>
      </div>

      <div class="button-group">
        <button class="button" onclick="tryMailto()">Open Email Client</button>
        <button class="button secondary" onclick="closeEEGModal()">Close</button>
      </div>
    </div>
  </div>
  
<!-- Skip Modal -->
<div class="modal" id="skip-modal">
  <div class="modal-content">
    <h3>⚠️ Before skipping <span id="skip-task-name">this task</span></h3>
    <p style="margin-top: 8px;">Having trouble? We'd love to help you complete it!</p>
    <ul style="text-align:left; margin: 12px 0 0 20px;">
      <li>Try refreshing or switching browsers first</li>
      <li>Email us for technical support</li>
      <li>Let us know about accessibility needs</li>
      <li>We can often find solutions together!</li>
    </ul>
    <div class="button-group" style="margin-top: 16px;">
      <button class="button outline" id="skip-help-btn">Get Help First</button>
      <button class="button secondary" id="skip-confirm-btn">Skip if Necessary</button>
    </div>
    <p style="margin-top:12px; color:#444;">
  <em>Note:</em> If you are skipping due to a technical issue, email us so we can help
</p>
    <button class="button" style="margin-top:10px;" id="skip-cancel-btn">Never mind</button>
  </div>
</div>

  <script>
    // ----- Configuration -----
    const CONFIG = {
  SHEETS_URL: 'https://script.google.com/macros/s/AKfycbxT4jpPNG6hTDbmpeo6utlOwHLPTrxBna_YjcG0yLNI9pO5hcI7yIJcTwgesvocSYSG4A/exec',
  IMAGE_1: 'images/description1.jpg',
  IMAGE_2: 'images/description2.jpg',
  ASLCT_ACCESS_CODE: 'DVCWHNABJ',
  EEG_CALENDLY_URL: 'https://calendly.com/action-brain-lab-gallaudet/spatial-cognition-eeg-only'
};
const CODE_REGEX = /^\d{6}$/; // six digits from Qualtrics code


    // ----- Tasks -----
    const TASKS = {
  'WIAT': { name:'Reading Comprehension (WIAT)', description:'Read passages and answer questions', type:'embed', embedUrl:'https://melodyfschwenk.github.io/readingcomp/', canSkip:true, estMinutes:15, requirements:'None' },
  'MRT': { name:'Mental Rotation Task', description:'Decide if two images are the same or not', type:'embed', embedUrl:'https://melodyfschwenk.github.io/mrt/', canSkip:true, estMinutes:6,  requirements:'Keyboard recommended' },
  'ASLCT': { name:'ASL Comprehension Test', description:'For ASL users only', url:'https://vl2portal.gallaudet.edu/assessment/', type:'external', canSkip:true, estMinutes:15, requirements:'ASL users; stable connection' },
  'VCN': { name:'Virtual Campus Navigation', description:'Virtual SILC Test of Navigation (SILCton)', url:'http://www.virtualsilcton.com/study/753798747', type:'external', canSkip:true, estMinutes:20, requirements:'Desktop/laptop; keyboard (WASD) & mouse' },
  'SN':  { name:'Spatial Navigation', description:'Choose the first step from the player to the stop sign (embedded below)', type:'embed', embedUrl:'https://melodyfschwenk.github.io/spatial-navigation-web/', canSkip:true, estMinutes:8, requirements:'Arrow keys' },
  'ID': {
  name: 'Image Description',
  description: 'Record two short videos describing images (or upload if recording is unavailable).',
  type: 'recording',
  canSkip: true,
  estMinutes: 2,
  requirements: 'Camera & microphone or video upload'
},
  'DEMO':{ name:'Demographics Survey', description:'Background information & payment', url:'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_8GJcoF3hkHoP8BU', type:'external', estMinutes:6, requirements:'None' }
};
    // Add this after TASKS definition
    function getStandardTaskName(taskCode) {
      const mapping = {
        'RC': 'Reading Comprehension Task',
        'MRT': 'Mental Rotation Task',
        'ASLCT': 'ASL Comprehension Test',
        'VCN': 'Virtual Campus Navigation',
        'SN': 'Spatial Navigation',
        'ID': 'Image Description',
        'DEMO': 'Demographics Survey'
      };
      return mapping[taskCode] || TASKS[taskCode]?.name || taskCode;
    }

    // ----- Consents -----
    const CONSENTS = {
      'CONSENT1': { name: 'Research Consent', url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_cGZEQDXQpUbGq1g' },
      'CONSENT2': { name: 'Video Consent', url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_5j0XhME387Kii8u' }
    };

    // ----- Task sequencing -----
    const DESKTOP_TASKS = ['WIAT', 'MRT', 'ASLCT', 'VCN', 'SN', 'ID'];
    const MOBILE_TASKS = ['WIAT', 'MRT', 'ASLCT', 'SN', 'ID'];

    function mulberry32(a) {
      return function() {
        a |= 0; a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t ^= t + Math.imul(t ^ t >>> 7, 61 | t);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }

    function shuffleWithSeed(array, seed) {
      const rng = mulberry32(seed);
      const a = array.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // Detect if mobile/tablet
    function isMobileDevice() {
      const hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);
      const mobileUA = /Android|webOS|iPhone|iPad|iPod|Mobile|Tablet/i.test(navigator.userAgent);
      const isSmallScreen = window.innerWidth <= 1024;
      return hasTouch && (mobileUA || isSmallScreen);
    }
function tryMailto() {
  const addr = 'action.brain.lab@gallaudet.edu';
  const subject = encodeURIComponent('[EEG Add-On] Scheduling — Session ' + (state.sessionCode || ''));
  const body = encodeURIComponent(`Hi Action Brain Lab,

I'd like to schedule the optional EEG visit.

Preferred dates/times:
Communication preference (ASL or English):

Thanks!
Session code: ${state.sessionCode || ''}`);
  window.location.href = `mailto:${addr}?subject=${subject}&body=${body}`;
}

function copyEmail(btn) {
  const addr = 'action.brain.lab@gallaudet.edu';
  navigator.clipboard.writeText(addr).then(() => {
    if (btn) { const t = btn.textContent; btn.textContent = '✅ Copied!'; setTimeout(()=>btn.textContent=t, 1500); }
  });
}

function closeEEGModal() {
  const m = document.getElementById('eeg-modal');
  if (m) m.classList.remove('active');
}
    // ----- State -----
    let state = {
  sessionCode: '',
  participantID: '',
  email: '',
  hearingStatus: '',
  fluency: '',
  sequenceIndex: -1,
  sequence: [],
  currentTaskIndex: 0,
  completedTasks: [],
  startTime: null,
  totalTimeSpent: 0,
  totalActiveTime: 0,
  lastActivity: null,
  currentTaskType: '',
  externalDepart: null,

  consentStatus: { consent1: false, consent2: false, videoDeclined: false },

  // ⬇️ ADD THIS INSIDE THE STATE OBJECT
  consentVerify: {
    consent1: { verified: false, method: null, note: '' },
    consent2: { verified: false, method: null, note: '' }
  },

  recording: {
    active: false, mediaRecorder: null, chunks: [], currentImage: 0, recordings: [],
    stream: null, currentBlob: null
  }
};

// Task timer to track active engagement
let taskTimer = {
  startTime: null,
  endTime: null,
  activeTime: 0,
  lastActivity: 0,
  isPaused: false,
  pauseReason: null,
  pauseCount: 0,
  inactivityTime: 0,
  lastTick: 0,
  intervalId: null,
  start() {
    this.startTime = Date.now();
    this.lastActivity = Date.now();
    this.lastTick = Date.now();
    this.activeTime = 0;
    this.inactivityTime = 0;
    this.pauseCount = 0;
    this.isPaused = false;
    this.intervalId = setInterval(() => this.tick(), 1000);
  },
  tick() {
    const now = Date.now();
    if (!document.hidden && !this.isPaused) {
      if (now - this.lastActivity > 120000) {
        this.pause('inactivity');
        showInactivityPrompt();
      } else {
        this.activeTime += now - this.lastTick;
      }
    } else if (this.isPaused && this.pauseReason === 'inactivity') {
      this.inactivityTime += now - this.lastTick;
    }
    this.lastTick = now;
  },
  recordActivity() {
    this.lastActivity = Date.now();
    if (this.isPaused && this.pauseReason === 'inactivity') this.resume();
  },
  pause(reason) {
    if (!this.isPaused) {
      this.isPaused = true;
      this.pauseReason = reason;
      this.pauseCount++;
      this.pauseStart = Date.now();
    }
  },
  resume() {
    if (this.isPaused) {
      if (this.pauseReason === 'inactivity' && this.pauseStart) {
        this.inactivityTime += Date.now() - this.pauseStart;
      }
      this.isPaused = false;
      this.pauseReason = null;
      this.lastActivity = Date.now();
    }
  },
  stop() {
    clearInterval(this.intervalId);
    if (this.isPaused && this.pauseReason === 'inactivity' && this.pauseStart) {
      this.inactivityTime += Date.now() - this.pauseStart;
    }
    this.endTime = Date.now();
  },
  getSummary() {
    const elapsed = (this.endTime || Date.now()) - this.startTime;
    const active = Math.min(this.activeTime, elapsed);
    const activityScore = elapsed > 0 ? (active / elapsed) * 100 : 0;
    return {
      start: new Date(this.startTime).toISOString(),
      end: new Date(this.endTime).toISOString(),
      elapsed,
      active,
      pauseCount: this.pauseCount,
      inactive: this.inactivityTime,
      activity: activityScore
    };
  }
};

function showInactivityPrompt() {
  sendToSheets({ action: 'inactivity', sessionCode: state.sessionCode, task: getStandardTaskName(state.sequence[state.currentTaskIndex] || ''), deviceType: state.isMobile ? 'mobile/tablet' : 'desktop', timestamp: new Date().toISOString() });
  if (confirm('Are you still there?')) {
    taskTimer.resume();
    taskTimer.recordActivity();
  }
}

['mousemove','mousedown','keydown','touchstart'].forEach(ev => {
  document.addEventListener(ev, () => taskTimer.recordActivity(), { passive: true });
});

document.addEventListener('visibilitychange', () => {
  if (document.hidden) taskTimer.pause('visibility'); else taskTimer.resume();
});

window.addEventListener('blur', () => {
  taskTimer.pause('blur');
  if (state.currentTaskType === 'external') {
    state.externalDepart = Date.now();
    sendToSheets({ action: 'task_departed', sessionCode: state.sessionCode, task: getStandardTaskName(state.sequence[state.currentTaskIndex] || ''), deviceType: state.isMobile ? 'mobile/tablet' : 'desktop', timestamp: new Date().toISOString() });
  }
});

window.addEventListener('focus', () => {
  taskTimer.resume();
  if (state.currentTaskType === 'external' && state.externalDepart) {
    const away = Date.now() - state.externalDepart;
    taskTimer.activeTime += away;
    taskTimer.lastTick = Date.now();
    sendToSheets({ action: 'task_returned', sessionCode: state.sessionCode, task: getStandardTaskName(state.sequence[state.currentTaskIndex] || ''), away: Math.round(away/1000), deviceType: state.isMobile ? 'mobile/tablet' : 'desktop', timestamp: new Date().toISOString() });
    state.externalDepart = null;
  }
});

window.addEventListener('message', e => {
  if (e.data === 'heartbeat') taskTimer.recordActivity();
});

// Handle Dropbox OAuth redirect
function handleDropboxAuth() {
  const urlParams = new URLSearchParams(window.location.hash.substring(1));
  const accessToken = urlParams.get('access_token');
  
  if (accessToken) {
    localStorage.setItem('dropbox_access_token', accessToken);
    // Clean up URL
    window.location.hash = '';
    console.log('Dropbox authorized successfully');
  }
}

// Call on page load
document.addEventListener('DOMContentLoaded', () => {
  handleDropboxAuth();
      setupEventListeners();
      // Secure-context guard: disable inline recording if not https
if (!window.isSecureContext) {
  // Hide the record button if the recording screen gets opened
  const style = document.createElement('style');
  style.textContent = `#record-btn { display: none !important; }`;
  document.head.appendChild(style);
}

      checkSavedSession();

      // Gentle mobile notice content swap
      if (isMobileDevice()) {
        const warning = document.getElementById('device-warning');
        if (warning) {
          warning.className = 'info-box friendly-tip';
          warning.innerHTML = `
  <strong>📱 Mobile or Tablet?</strong>
  <p style="margin-top: 10px;">
    Some tasks work best on a computer. You can pause now and resume later with your code.
  </p>
  <ul style="margin: 10px 0 0 20px; text-align: left;">
    <li><strong>Virtual Campus Navigation</strong> needs keyboard controls (WASD/arrow keys)</li>
    <li>Video recording requires camera & microphone permissions</li>
    <li>Chrome or Firefox recommended on desktop</li>
    <li>To receive full compensation, we recommend switching to a computer if possible.</li>
  </ul>
`;
        }
      }
    });

    function setupEventListeners() {
      document.getElementById('first-initial').addEventListener('input', validateInitials);
      document.getElementById('last-initial').addEventListener('input', validateInitials);
      document.getElementById('hearing-status').addEventListener('change', validateInitials);
      document.getElementById('fluency').addEventListener('change', validateInitials);
      document.getElementById('resume-code').addEventListener('input', e => { e.target.value = e.target.value.toUpperCase(); });
      bindRecordingSkips();
      bindUploadFallback();
    }

    function validateInitials(e) {
      if (e.target.id === 'first-initial' || e.target.id === 'last-initial') {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 1);
      }
      const first = document.getElementById('first-initial').value;
      const last = document.getElementById('last-initial').value;
      const hearing = document.getElementById('hearing-status').value;
      const fluency = document.getElementById('fluency').value;
      document.getElementById('create-session-btn').disabled = !(first && last && hearing && fluency);
    }

    // ----- Screens -----
   // === REPLACE your existing showScreen with this ===
function showScreen(screenId) {
  // Hide all screens, show target
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screen = document.getElementById(screenId);
  if (screen) screen.classList.add('active');

  updateProgressBar();

  const crumbs = ['Home'];
  if (screenId === 'consent-screen') crumbs.push('Consent');
  else if (screenId === 'progress-screen') crumbs.push('Tasks');
  else if (screenId === 'task-screen' || screenId === 'recording-screen') {
    crumbs.push('Tasks');
    const t = document.getElementById('task-title');
    if (t) crumbs.push(t.textContent.trim());
  }
  const bc = document.getElementById('breadcrumbs');
  if (bc) bc.textContent = crumbs.join(' › ');

  // Show/hide session widget + FAB
  const widget = document.getElementById('session-widget');
  const showWidget = ['progress-screen','task-screen','consent-screen','recording-screen'].includes(screenId);
  if (widget) widget.classList.toggle('active', showWidget && state.sessionCode);
  const fab = document.getElementById('pause-fab');
  if (fab) fab.classList.toggle('active', showWidget && state.sessionCode);

  // Accessibility: move focus to the screen heading and announce
  const heading = screen?.querySelector('h2, h1, h3');
  if (heading) {
    heading.setAttribute('tabindex', '-1');
    heading.focus({ preventScroll: false });
    // Clean up tabindex after focus so it doesn't stay in tab order
    setTimeout(() => heading.removeAttribute('tabindex'), 500);
    // Live region update
    const live = document.getElementById('live-status');
    if (live) live.textContent = `Section changed: ${heading.textContent}`;
  }
}


    // ----- Session -----
    function generateCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
      return code;
    }

    function createNewSession() {
      const first = document.getElementById('first-initial').value.trim().toUpperCase();
      const last = document.getElementById('last-initial').value.trim().toUpperCase();
      const email = document.getElementById('email').value.trim();
      const hearing = document.getElementById('hearing-status').value;
      const fluency = document.getElementById('fluency').value;
      if (!first || !last || !hearing || !fluency) { alert('Please complete all fields'); return; }

      if (isMobileDevice()) {
        const proceed = confirm(
          'You are on a phone or tablet.\n\n' +
          'A computer is preferred for the best experience, but you can continue now.\n' +
          'You can also pause and resume later on a computer using your resume code.\n\n' +
          'Continue on this device?'
        );
        if (!proceed) return;
      }

      state.sessionCode = generateCode();
      state.participantID = `${first}${last}_${Date.now().toString().slice(-4)}`;
      state.email = email;
      state.hearingStatus = hearing;
      state.fluency = fluency;

      // Choose sequence (mobile vs desktop)
      const seed = Math.abs(hashCode(state.sessionCode));
      state.sequenceIndex = seed;
      if (isMobileDevice()) {
        state.sequence = shuffleWithSeed(MOBILE_TASKS, seed);
        state.isMobile = true;
      } else {
        state.sequence = shuffleWithSeed(DESKTOP_TASKS, seed);
        state.isMobile = false;
      }
      state.sequence.push('DEMO');

      state.startTime = Date.now();
      state.lastActivity = new Date().toISOString();

      saveState();
      sendToSheets({
        action: 'session_created',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        email: state.email,
        hearingStatus: state.hearingStatus,
        fluency: state.fluency,
        deviceType: state.isMobile ? 'mobile/tablet' : 'desktop',
        timestamp: new Date().toISOString()
      });

      document.getElementById('display-code').textContent = state.sessionCode;
      showScreen('session-created');
    }

    async function resumeSession() {
      const code = document.getElementById('resume-code').value.toUpperCase();
      if (code.length !== 8) { alert('Please enter your 8-character resume code'); return; }
      try {
        const res = await fetch(CONFIG.SHEETS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: 'get_session', sessionCode: code })
        });
        const data = await res.json();
        if (!data.success || !data.session || !data.session.state) {
          alert('Session not found. Please check your code.');
          return;
        }
        state = JSON.parse(data.session.state);
        saveState();
        updateSessionWidget();
        if (!state.consentStatus.consent1) showScreen('consent-screen'); else showProgressScreen();
      } catch (err) {
        console.error(err);
        alert('Error loading session');
      }
    }

    // === REPLACE the body of checkSavedSession with this ===
function checkSavedSession() {
  try {
    const recentCode = localStorage.getItem('recent_session');
    if (!recentCode) return;

    const saved = localStorage.getItem(`study_${recentCode}`);
    if (!saved) return;

    const data = JSON.parse(saved);
    const daysSince = (Date.now() - new Date(data.lastActivity).getTime()) / (1000*60*60*24);
    if (daysSince < 30) {
      // Delay so it doesn’t clash with initial UI
      setTimeout(() => {
        if (confirm(`Welcome back! Resume session ${recentCode}?`)) {
          state = data; updateSessionWidget(); showProgressScreen();
        }
      }, 700); // ~0.7s feels smooth with your animations
    }
  } catch (e) {
    console.warn('Could not check saved session', e);
  }
}


    function saveState() {
      try {
        if (!state || !state.sessionCode) {
          console.warn('Invalid state, not saving');
          return;
        }
        state.lastActivity = new Date().toISOString();
        localStorage.setItem(`study_${state.sessionCode}`, JSON.stringify(state));
        localStorage.setItem('recent_session', state.sessionCode);
        sendToSheets({ action: 'save_state', sessionCode: state.sessionCode, state });
      } catch (e) { console.warn('Could not save state', e); }
    }

    // ----- Consent -----
    function proceedToConsent() { showScreen('consent-screen'); updateConsentDisplay(); }
    function openConsent(type) {
      const consent = CONSENTS[type];
      if (consent) {
        window.open(consent.url, '_blank', 'noopener');
        sendToSheets({ action: 'consent_opened', sessionCode: state.sessionCode, type, timestamp: new Date().toISOString() });
      }
    }
   function markConsentDone(type) {
  // Safety interlock: explicit warning + typed phrase
  const niceName = (type === 'consent1') ? 'Research Consent' : 'Video Consent';
  const ok = confirm(
    `Did you actually complete and submit the ${niceName} form on Qualtrics?\n\n` +
    `Clicking “OK” without completing the form will disqualify you from compensation.`
  );
  if (!ok) return;

  const phrase = prompt(
    `To confirm, type exactly: I COMPLETED THE CONSENT\n\n` +
    `This helps prevent accidental or invalid confirmation.`
  );

  if (!phrase || phrase.trim().toUpperCase() !== 'I COMPLETED THE CONSENT') {
    alert('Not confirmed. Please complete the form first.');
    return;
  }

  // Mark the consent as completed (same as before)
  if (type === 'consent1') {
    state.consentStatus.consent1 = true;
  } else if (type === 'consent2') {
    state.consentStatus.consent2 = true;
  }
  saveState(); updateConsentDisplay();

  // Log a stricter audit trail
  sendToSheets({
    action: 'consent_affirmed',
    sessionCode: state.sessionCode,
    type,
    method: 'typed-affirmation',
    timestamp: new Date().toISOString()
  });
}
function verifyConsentCode(type) {
  const inputId = type === 'consent1' ? 'consent1-code' : 'consent2-code';
  const noteId  = type === 'consent1' ? 'consent1-verify-note' : 'consent2-verify-note';

  const el = document.getElementById(inputId);
  const noteEl = document.getElementById(noteId);
  const code = (el?.value || '').trim();

  // Enforce 6 digits only
  if (!CODE_REGEX.test(code)) {
    alert('Enter the 6-digit code shown at the end of the Qualtrics form.');
    el?.focus();
    return;
  }

  // Mark this consent complete & verified
  if (type === 'consent1') state.consentStatus.consent1 = true;
  if (type === 'consent2') state.consentStatus.consent2 = true;

  state.consentVerify[type] = { verified: true, method: 'code', note: '6-digit' };
  saveState();
  updateConsentDisplay();

  if (noteEl) {
    noteEl.textContent = '✅ Verified via code';
    noteEl.style.color = '#1b5e20';
  }

  // Log (store only the 6-digit suffix; no PII)
  sendToSheets({
    action: 'consent_verified',
    sessionCode: state.sessionCode || 'none',
    type,
    method: 'code',
    codeSuffix: code,           // already 6 digits
    timestamp: new Date().toISOString()
  });
}

function autoVerifyConsentsFromURL() {
  try {
    const p = new URLSearchParams(location.search);
    // Support: ?c1=1&c2=1 or ?consent1=done etc. You can set these in Qualtrics "End of Survey" redirect.
    const c1 = p.get('c1') || p.get('consent1');
    const c2 = p.get('c2') || p.get('consent2');
    const rid1 = p.get('rid1') || p.get('rid'); // optionally pass ResponseID
    const rid2 = p.get('rid2');

    if (c1 && String(c1).toLowerCase() !== '0') {
      state.consentStatus.consent1 = true;
      state.consentVerify.consent1 = { verified: true, method: 'url-param', note: rid1 ? `RID …${String(rid1).slice(-6)}` : '' };
      sendToSheets({
        action: 'consent_verified',
        sessionCode: state.sessionCode || 'none',
        type: 'consent1',
        method: 'url-param',
        ridSuffix: rid1 ? String(rid1).slice(-6) : '',
        timestamp: new Date().toISOString()
      });
    }

    if (c2 && String(c2).toLowerCase() !== '0') {
      state.consentStatus.consent2 = true;
      state.consentVerify.consent2 = { verified: true, method: 'url-param', note: rid2 ? `RID …${String(rid2).slice(-6)}` : '' };
      sendToSheets({
        action: 'consent_verified',
        sessionCode: state.sessionCode || 'none',
        type: 'consent2',
        method: 'url-param',
        ridSuffix: rid2 ? String(rid2).slice(-6) : '',
        timestamp: new Date().toISOString()
      });
    }

    if (c1 || c2) {
      saveState(); updateConsentDisplay();
      // Optional: clean query so it doesn't re-trigger on refresh
      try {
        const cleanURL = location.origin + location.pathname;
        window.history.replaceState({}, '', cleanURL);
      } catch (e) {}
    }
  } catch (e) {
    console.warn('Auto-verify failed', e);
  }
}

// Call it during init:
document.addEventListener('DOMContentLoaded', () => {
  // ... your existing init
  autoVerifyConsentsFromURL(); // <— add this line
});

    function declineVideo() {
      if (confirm('Decline video consent? You can still participate in other tasks.')) {
        state.consentStatus.videoDeclined = true;
        state.consentStatus.consent2 = true;
        document.getElementById('consent2-card').classList.add('declined');
        document.querySelector('#consent2-card .status-icon').textContent = '⚠️';
        saveState(); updateConsentDisplay();
        sendToSheets({ action: 'video_declined', sessionCode: state.sessionCode, timestamp: new Date().toISOString() });
        updateSessionWidget();
        updateProgressBar();
      }
    }
    function updateConsentDisplay() {
  const c1 = state.consentStatus.consent1;
  const c2 = state.consentStatus.consent2 || state.consentStatus.videoDeclined;

  // Buttons state
  document.getElementById('continue-from-consent').disabled = !(c1 && c2);

  // Card styles + badges
  const card1 = document.getElementById('consent1-card');
  const card2 = document.getElementById('consent2-card');

  if (c1) {
    card1.classList.remove('declined');
    card1.classList.add('completed');
    card1.querySelector('.status-icon').textContent = '✅';

    const note = document.getElementById('consent1-verify-note');
    if (state.consentVerify.consent1.verified) {
      if (note) { note.textContent = `Verified via ${state.consentVerify.consent1.method} ${state.consentVerify.consent1.note ? '('+state.consentVerify.consent1.note+')' : ''}`; note.style.color = '#1b5e20'; }
    } else {
      if (note) { note.textContent = 'Affirmed without code'; note.style.color = '#856404'; }
    }
  }

  if (state.consentStatus.videoDeclined) {
    card2.classList.remove('completed');
    card2.classList.add('declined');
    card2.querySelector('.status-icon').textContent = '⚠️';
  } else if (state.consentStatus.consent2) {
    card2.classList.remove('declined');
    card2.classList.add('completed');
    card2.querySelector('.status-icon').textContent = '✅';

    const note = document.getElementById('consent2-verify-note');
    if (state.consentVerify.consent2.verified) {
      if (note) { note.textContent = `Verified via ${state.consentVerify.consent2.method} ${state.consentVerify.consent2.note ? '('+state.consentVerify.consent2.note+')' : ''}`; note.style.color = '#1b5e20'; }
    } else if (note) {
      note.textContent = state.consentStatus.consent2 ? 'Affirmed without code' : '';
      note.style.color = '#856404';
    }
  }
}

    function proceedToTasks() {
      if (!state.consentStatus.consent1) { alert('Please complete the research consent form'); return; }
      showProgressScreen();
    }

    // ----- Progress -----
    function showProgressScreen() { updateTaskList(); updateProgressBar(); updateSessionWidget(); showScreen('progress-screen'); }
    function updateTaskList() {
      const list = document.getElementById('task-list');
      list.innerHTML = '';
      state.sequence.forEach((taskCode, index) => {
        const task = TASKS[taskCode];
        const li = document.createElement('li');
        li.className = 'task-item';
        const isCompleted = state.completedTasks.includes(taskCode);
        const isCurrent = index === state.currentTaskIndex && !isCompleted;
        if (isCompleted) li.classList.add('completed');
        else if (isCurrent) li.classList.add('current');
        else li.classList.add('locked');
        li.innerHTML = `
          <div class="task-info">
            <div class="task-name">${task.name}<span class="task-badge">${task.estMinutes}m</span></div>
            <div class="task-description">${task.description}</div>
          </div>
          <div class="task-status">${isCompleted ? '✅' : (isCurrent ? '▶️' : '🔒')}</div>
        `;
        list.appendChild(li);
      });
    }
    function getTaskCounts() {
      const isRequired = code => !(code === 'ID' && state.consentStatus.videoDeclined);
      return {
        total: state.sequence.filter(isRequired).length,
        completed: state.completedTasks.filter(isRequired).length
      };
    }
    function updateProgressBar() {
      const { total, completed } = getTaskCounts();
      if (!total) return;
      const progress = (completed / total) * 100;
      const pct = `${Math.round(progress)}%`;
      const fill = document.getElementById('progress-fill');
      const topFill = document.getElementById('top-progress-fill');
      if (fill) { fill.style.width = `${progress}%`; document.getElementById('progress-text').textContent = pct; }
      if (topFill) { topFill.style.width = `${progress}%`; topFill.textContent = pct; }
      const step = document.getElementById('step-indicator');
      if (step) step.textContent = `Step ${Math.min(completed + 1, total)} of ${total}`;
    }
    function updateSessionWidget() {
      if (!state.sessionCode) return;
      const { total, completed } = getTaskCounts();
      document.getElementById('widget-code').textContent = state.sessionCode + (state.isMobile ? ' (Mobile)' : '');
      document.getElementById('widget-progress').textContent = `${completed}/${total}`;
      document.getElementById('widget-time').textContent = `${Math.round(state.totalTimeSpent / 60000)} min`;
      const currentTask = state.sequence[state.currentTaskIndex];
      document.getElementById('widget-current').textContent = currentTask ? TASKS[currentTask].name : 'Complete';
    }

    // ----- Task flow -----
    function continueToCurrentTask() {
      if (state.currentTaskIndex >= state.sequence.length) { showCompletionScreen(); return; }
      startTask(state.sequence[state.currentTaskIndex]);
    }
    function startTask(taskCode) {
      const task = TASKS[taskCode];
      if (!task) return;

  if (!state.taskData) state.taskData = {};
  state.taskData[taskCode] = { startTime: Date.now() };
      state.currentTaskType = task.type;
      taskTimer.start();

      if (task.type === 'recording') showRecordingTask();
      else if (task.type === 'embed') showEmbeddedTask(taskCode);
      else showExternalTask(taskCode);

      const startISO = new Date().toISOString();
      sendToSheets({ action: 'task_started', sessionCode: state.sessionCode, task: getStandardTaskName(taskCode), deviceType: state.isMobile ? 'mobile/tablet' : 'desktop', timestamp: startISO, startTime: startISO });
    }

    // ----- Distraction-free fallback -----
    function enterDistractionFree() {
      document.documentElement.classList.add('df-mode');
      document.body.dataset.scrollY = window.scrollY;
      document.body.style.top = `-${window.scrollY}px`;
    }
    function exitDistractionFree() {
      document.documentElement.classList.remove('df-mode');
      const y = parseInt(document.body.dataset.scrollY || '0', 10);
      document.body.style.top = '';
      window.scrollTo(0, y);
    }

    // PostMessage completion hook
    window.addEventListener('message', (ev) => {
      const allowedOrigin = 'https://melodyfschwenk.github.io';
      if (ev.origin !== allowedOrigin) return;
      const data = ev.data || {};
      if (data.type === 'task-complete' && data.taskCode && TASKS[data.taskCode]) {
        completeTask(data.taskCode);
      }
    });

    // ----- Embedded tasks -----
    function showEmbeddedTask(taskCode) {
      const task = TASKS[taskCode];
      const url  = task.embedUrl;
      const iframeId = `embed-${taskCode.toLowerCase()}`;

      let extra = '';
      if (taskCode === 'SN') {
        extra = `
          <div class="info-box helpful" style="margin-top:10px;">
            <strong>What you'll do</strong>
            <p style="margin-top:6px;">Press <em>one</em> arrow key for the <em>first</em> step from the gray player to the red stop sign.</p>
          </div>`;
      } else if (taskCode === 'MRT') {
        extra = `
          <div class="info-box friendly-tip" style="margin-top:10px;">
            <strong>Heads up:</strong>
            <p style="margin-top:6px;">Takes about <strong>5–6 minutes</strong>. Work steadily from start to finish.</p>
          </div>`;
      }

      document.getElementById('task-title').textContent = task.name;
      const requiredText = (taskCode === 'ID' && state.consentStatus.videoDeclined)
  ? 'This task is OPTIONAL for you (video consent declined).'
  : 'This task is REQUIRED for compensation.';
const eta = TASKS[taskCode]?.estMinutes ? `${TASKS[taskCode].estMinutes} minutes` : 'a few minutes';
const reqs = TASKS[taskCode]?.requirements || '—';

      document.getElementById('task-instructions').innerHTML = `
  <div class="info-box friendly-tip" style="margin-bottom:10px;">
    <strong> Ready to Start ${task.name}?</strong>
    <ul style="margin:8px 0 0 20px; text-align:left;">
      <li>${requiredText}</li>
      <li>Having problems? Email us instead of skipping</li>
      <li>Estimated time: <strong>${eta}</strong></li>
      <li>Requirements/tips: <em>${reqs}</em></li>
    </ul>
  </div>
  <p>${task.description}</p>
  ${extra}
  <details style="margin-top:10px;"><summary style="cursor:pointer;">More info / troubleshooting</summary>
    <ul style="margin:8px 0 0 20px; text-align:left;">
      <li>If the game doesn't respond, click inside it once to give it keyboard focus.</li>
      <li>If fullscreen doesn't work on your device, we'll switch to a distraction-free view.</li>
    </ul>
  </details>
`;


      const content = document.getElementById('task-content');
      content.innerHTML = `
  <div class="card" id="prestart">
    <p>When you click <strong>Continue</strong>, the task will open in fullscreen. When you're finished, click <em>I'm finished — Continue</em>.</p>
    <div class="button-group" style="margin-top:12px;">
      <button class="button" id="start-embed">Continue</button>
      <button class="button outline" type="button" onclick="openSupportEmail('${taskCode}')">Report Technical Issue Instead</button>
      ${task.canSkip ? `<button class="button secondary" onclick="showSkipDialog('${taskCode}')">Skip This Task</button>` : ''}
    </div>
  </div>

  <div class="embed-shell fs-shell" id="fs-shell" style="display:none;">
    <div class="fs-toolbar" id="fs-toolbar">
      <div>${task.name}</div>
      <div class="actions">
        <button class="button success" id="finish-btn" disabled>I'm finished — Continue</button>
        <button class="button secondary" id="exit-btn">Exit fullscreen</button>
      </div>
    </div>
    <iframe id="${iframeId}" class="embed-frame" src="${url}" allow="fullscreen; gamepad; xr-spatial-tracking" allowfullscreen></iframe>
    <div class="embed-note">Tip: click once inside the game to give it keyboard focus.</div>
  </div>
`;

      showScreen('task-screen');

      const fsShell = document.getElementById('fs-shell');
      const finishBtn = document.getElementById('finish-btn');
      const exitBtn = document.getElementById('exit-btn');
      const prestart = document.getElementById('prestart');
      const iframe = document.getElementById(iframeId);
      iframe.addEventListener('focus', () => taskTimer.recordActivity());

      const enableFinish = () => { finishBtn.disabled = false; };

      async function goFullscreen() {
        prestart.style.display = 'none';
        fsShell.style.display = 'block';

        setTimeout(() => { try { iframe.focus(); } catch(e) {} }, 50);

        try {
          if (fsShell.requestFullscreen) { await fsShell.requestFullscreen({ navigationUI: 'hide' }).catch(() => {}); }
          else if (fsShell.webkitRequestFullscreen) { fsShell.webkitRequestFullscreen(); }
          setTimeout(() => {
            const inFS = document.fullscreenElement || document.webkitFullscreenElement;
            if (!inFS) enterDistractionFree();
          }, 250);
        } catch (e) { enterDistractionFree(); }

        setTimeout(enableFinish, 6000);
      }

      function leaveFullscreenModes() {
        if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
        if (document.webkitFullscreenElement) document.webkitExitFullscreen?.();
        exitDistractionFree();
      }

      document.getElementById('start-embed').onclick = goFullscreen;
      finishBtn.onclick = () => { leaveFullscreenModes(); completeTask(taskCode); };
      exitBtn.onclick = () => { leaveFullscreenModes(); fsShell.scrollIntoView({ behavior: 'smooth', block: 'start' }); enableFinish(); };

      const loadTimeout = setTimeout(() => {
        const note = document.createElement('div');
        note.className = 'embed-note';
        note.textContent = 'Still loading… if nothing appears soon, try exiting fullscreen and re-entering.';
        fsShell.appendChild(note);
      }, 7000);
      iframe.addEventListener('load', () => clearTimeout(loadTimeout), { once:true });

      document.addEventListener('keydown', function escHandler(ev) {
        if (ev.key === 'Escape') {
          setTimeout(leaveFullscreenModes, 0);
          document.removeEventListener('keydown', escHandler);
        }
      });
    }

    // ----- External tasks -----
    
    // === REPLACE your existing showExternalTask with this ===
function showExternalTask(taskCode) {
  const task = TASKS[taskCode];
  let extra = '';

  const requiredText = (taskCode === 'ID' && state.consentStatus.videoDeclined)
    ? 'This task is OPTIONAL for you (video consent declined).'
    : 'This task is REQUIRED for compensation.';
  const eta  = TASKS[taskCode]?.estMinutes ? `${TASKS[taskCode].estMinutes} minutes` : 'a few minutes';
  const reqs = TASKS[taskCode]?.requirements || '—';

  if (taskCode === 'ASLCT') {
    const ASLCT_CODE = CONFIG.ASLCT_ACCESS_CODE;
    extra = `
      <div class="info-box helpful" style="margin-top: 10px;">
        <strong>ASLCT Access Code</strong>
        <p style="margin-top: 6px;">
          On the login page, enter access code:
          <span class="code" style="font-size:22px; background:#fff; color:#333; padding:4px 8px; border-radius:6px; display:inline-block;">${ASLCT_CODE}</span>
        </p>
        <button class="button outline" onclick="navigator.clipboard.writeText('${ASLCT_CODE}').then(()=>{ this.textContent='✅ Copied!'; setTimeout(()=>this.textContent='Copy Access Code',1500); })">Copy Access Code</button>
      </div>
      <div class="info-box helpful" style="margin-top: 10px;">
        <strong>Instructions:</strong>
        <ol style="margin: 10px 0 0 20px; text-align: left;">
          <li>Click "Open Task".</li>
          <li>On the ASLCT portal, paste the access code <em>${ASLCT_CODE}</em> and follow the prompts.</li>
          <li>Return here when finished and click "Mark Complete".</li>
        </ol>
      </div>
      <div style="margin-top: 10px; text-align: left;">
        <p>If you encounter any problems with the ASLCT, please describe them below and click Send.</p>
        <textarea id="aslct-issue-text" style="width: 100%; height: 80px; margin-top: 6px;"></textarea>
        <button class="button secondary" style="margin-top: 10px;" onclick="submitASLCTIssue()">Send</button>
      </div>`;
  } else if (taskCode === 'VCN') {
    extra = `
      <div class="info-box helpful" style="margin-top: 10px;">
        <strong>Virtual SILC Test of Navigation (SILCton) — What you'll do</strong>
        <p style="margin-top: 6px;">Learn a small virtual campus (Learning phase), then answer quick questions (Test phase).</p>
        <ul style="margin: 10px 0 0 20px; text-align: left;">
          <li><strong>Controls:</strong> Move with WASD/arrow keys; look around with the mouse.</li>
          <li>Desktop/laptop recommended (Chrome/Firefox). Keep this page open.</li>
        </ul>
      </div>`;
  }

  document.getElementById('task-title').textContent = task.name;
  document.getElementById('task-instructions').innerHTML = `
    <div class="info-box friendly-tip" style="margin-bottom:10px;">
      <strong>⚠️ Ready to Start ${task.name}?</strong>
      <ul style="margin:8px 0 0 20px; text-align:left;">
        <li>${requiredText}</li>
        <li>Having problems? Email us instead of skipping</li>
        <li>Estimated time: <strong>${eta}</strong></li>
        <li>Requirements/tips: <em>${reqs}</em></li>
      </ul>
    </div>
    <p>${task.description}</p>
    ${extra}
    <div class="info-box helpful" style="margin-top: 10px;">
      <strong>Instructions:</strong>
      <ol style="margin: 10px 0 0 20px; text-align: left;">
        <li>Click "Open Task" to launch in a new tab.</li>
        <li>Complete the task as instructed.</li>
        <li>Return to this tab when finished.</li>
        <li>Click "Mark Complete" to continue.</li>
      </ol>
    </div>
  `;

  const content = document.getElementById('task-content');
  content.innerHTML = `
    <div class="button-group">
      <a class="button" href="${task.url}" target="_blank" rel="noopener"
         aria-label="Open Task (opens in new tab)"
         onclick="sendToSheets({ action: 'task_opened', sessionCode: state.sessionCode || 'none', timestamp: new Date().toISOString(), userAgent: navigator.userAgent, deviceType: state.isMobile ? 'mobile/tablet' : 'desktop' });">
         Open Task
      </a>
      <button class="button success" onclick="completeTask('${taskCode}')">Mark Complete</button>
      <button class="button outline" onclick="openSupportEmail('${taskCode}')">Report Technical Issue Instead</button>
    </div>
  `;
  if (task.canSkip) {
    content.innerHTML += `
      <button class="button secondary" onclick="showSkipDialog('${taskCode}')" style="display: block; margin: 20px auto;">
        ${taskCode === 'ASLCT' ? 'Skip - I Do Not Know ASL' : 'Skip This Task'}
      </button>
    `;
  }
  showScreen('task-screen');
}

function openExternalTask(taskCode) {
  const task = TASKS[taskCode];
  if (!task || !task.url) return;
  window.open(task.url, '_blank', 'noopener');
}

    // ----- Recording task -----
    function showRecordingTask() {
      state.recording.currentImage = 0;
      state.recording.recordings = [];
      state.recording.currentBlob = null;
      if (!state.consentStatus.consent2 || state.consentStatus.videoDeclined) {
        document.getElementById('recording-consent-check').style.display = 'block';
        document.getElementById('recording-content').style.display = 'none';
      } else {
        document.getElementById('recording-consent-check').style.display = 'none';
        document.getElementById('recording-content').style.display = 'block';
        updateRecordingImage();
      }
      // NEW: if page not secure, skip recorder UI and show upload UI
if (!window.isSecureContext) {
  document.getElementById('recording-consent-check').style.display = 'none';
  document.getElementById('recording-content').style.display = 'block';
  document.getElementById('video-upload-fallback').style.display = 'block';
  const status = document.getElementById('recording-status');
  status.textContent = 'Recording disabled (requires https). Please use the upload option below.';
  status.className = 'recording-status warning';
}

      showScreen('recording-screen');
    }

    function revokeRecordedURL() {
      const recorded = document.getElementById('recorded-video');
      if (recorded && recorded.src) {
        try { URL.revokeObjectURL(recorded.src); } catch(e) {}
        recorded.removeAttribute('src');
        recorded.load?.();
      }
    }

    function updateRecordingImage() {
      const imageNum = state.recording.currentImage + 1;
      document.getElementById('image-number').textContent = imageNum;
      document.getElementById('current-image').src = imageNum === 1 ? CONFIG.IMAGE_1 : CONFIG.IMAGE_2;
      
      const preview = document.getElementById('video-preview');
      const recorded = document.getElementById('recorded-video');
      preview.style.display = 'none';
      recorded.style.display = 'none';
      
      // Clean up previous recording blob URL
      revokeRecordedURL();
      state.recording.currentBlob = null;
      
      // Reset UI elements
      document.getElementById('record-btn').style.display = 'inline-block';
      document.getElementById('rerecord-btn').style.display = 'none';
      document.getElementById('save-recording-btn').style.display = 'none';
      
      const status = document.getElementById('recording-status');
      status.textContent = 'Ready to record';
      status.className = 'recording-status ready';
      
      // Clear any previous errors
      document.getElementById('recording-error').style.display = 'none';
      document.getElementById('video-upload-fallback').style.display = 'none';
      document.getElementById('upload-progress').style.display = 'none';
      
      // Clear file input
      const fileInput = document.getElementById('video-file-input');
      if (fileInput) fileInput.value = '';
      
      const uploadBtn = document.getElementById('upload-save-btn');
      if (uploadBtn) {
        uploadBtn.style.display = 'none';
        uploadBtn.textContent = 'Use this upload';
      }

      const requiredTextRec = (state.consentStatus.videoDeclined)
  ? 'This task is OPTIONAL for you (video consent declined).'
  : 'This task is REQUIRED for compensation.';
const etaRec = TASKS['ID']?.estMinutes ? `${TASKS['ID'].estMinutes} minutes` : 'a few minutes';
const reqsRec = TASKS['ID']?.requirements || '—';

const instructionBox = document.getElementById('task-instructions');
if (instructionBox) {
  document.getElementById('task-title').textContent = TASKS['ID'].name;
  instructionBox.innerHTML = `
    <div class="info-box friendly-tip" style="margin-bottom:10px;">
      <strong>⚠️ Ready to Start ${TASKS['ID'].name}?</strong>
      <ul style="margin:8px 0 0 20px; text-align:left;">
        <li>${requiredTextRec}</li>
        <li>Having problems? Email us instead of skipping</li>
        <li>Estimated time: <strong>${etaRec}</strong></li>
        <li>Requirements/tips: <em>${reqsRec}</em></li>
      </ul>
    </div>
  `;
}

    }

    function isIOS() { return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }

    async function checkSecureAndPermissions() {
      if (!window.isSecureContext) {
        const hint = location.protocol === 'http:' ? 'This page must be served over https.' : 'This page cannot run from a local file.';
        throw { code: 'NOT_SECURE', message: hint };
      }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw { code: 'NO_MEDIADEVICES', message: 'This browser does not support in-page recording.' };
      }
      let cam = 'unknown', mic = 'unknown';
      try {
        const camPerm = await navigator.permissions.query({ name: 'camera' });
        const micPerm = await navigator.permissions.query({ name: 'microphone' });
        cam = camPerm?.state || 'unknown';
        mic = micPerm?.state || 'unknown';
      } catch(e) {}
      return { cam, mic };
    }

    function showRecordingError(html, showFallback = true) {
      const box = document.getElementById('recording-error');
      if (!box) return;
      box.style.display = 'block';
      box.innerHTML = html;
      if (showFallback) {
        const fb = document.getElementById('video-upload-fallback');
        if (fb) fb.style.display = 'block';
      }
    }

    // Enhanced file upload handling for the fallback option
    function bindUploadFallback() {
  const input = document.getElementById('video-file-input');
  const btn = document.getElementById('upload-save-btn');
  if (!input || !btn) return;
  
  input.addEventListener('change', () => {
    const f = input.files && input.files[0];
    if (!f) return;
    if (!f.type.startsWith('video/')) { 
      alert('Please select a video file'); 
      input.value = ''; 
      return; 
    }
    
    // Warn for very large files but allow them
    if (f.size > 100 * 1024 * 1024) { // 100MB warning
      if (!confirm(`Large file (${Math.round(f.size/1024/1024)}MB). This may take longer to upload. Continue?`)) {
        input.value = '';
        return;
      }
    }
    
    state.recording.currentBlob = f;
    btn.style.display = 'inline-block';
    btn.textContent = `Upload & Continue (${Math.round(f.size/1024)}KB)`;
  });
  
  btn.addEventListener('click', saveRecording);
}

    function bindRecordingSkips() {
      document.getElementById('skip-recording-btn')?.addEventListener('click', () => showSkipDialog('ID'));
      document.getElementById('skip-recording-consent-btn')?.addEventListener('click', () => showSkipDialog('ID'));
    }

    async function toggleRecording() {
      const btn = document.getElementById('record-btn');
      const status = document.getElementById('recording-status');
      const preview = document.getElementById('video-preview');

      if (!state.recording.active) {
        try {
          const perm = await checkSecureAndPermissions();
          if (perm.cam === 'denied' || perm.mic === 'denied') {
            const how = isIOS()
              ? 'Settings → Safari → Camera/Microphone → Allow for this site, then reload.'
              : 'Click the camera icon in the address bar and allow camera and microphone, then reload.';
            showRecordingError(`<strong>Camera or microphone is blocked</strong><p style="margin-top: 6px;">Please allow access for this site. ${how}</p>`);
            return;
          }

          const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: true });
          state.recording.stream = stream; preview.srcObject = stream; preview.style.display = 'block';

          if (!window.MediaRecorder) {
            showRecordingError(`<strong>Recording not supported in this browser</strong><p style="margin-top: 6px;">Please use Chrome, Edge, or Firefox, or upload a short video below.</p>`);
            return;
          }

          // UPDATED: Try MP4 first, then WebM fallback
          let options = {};
          if (MediaRecorder.isTypeSupported?.('video/mp4;codecs=h264,aac')) {
            options.mimeType = 'video/mp4;codecs=h264,aac';
          } else if (MediaRecorder.isTypeSupported?.('video/webm;codecs=vp9,opus')) {
            options.mimeType = 'video/webm;codecs=vp9,opus';
          } else if (MediaRecorder.isTypeSupported?.('video/webm;codecs=vp8,opus')) {
            options.mimeType = 'video/webm;codecs=vp8,opus';
          }

          state.recording.mediaRecorder = new MediaRecorder(stream, options);
          state.recording.chunks = [];
          state.recording.mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) state.recording.chunks.push(e.data); };
          state.recording.mediaRecorder.onstop = () => {
            try {
              revokeRecordedURL();
              const blob = new Blob(state.recording.chunks, { type: options.mimeType || 'video/mp4' });
              const url = URL.createObjectURL(blob);
              const recordedEl = document.getElementById('recorded-video');
              recordedEl.src = url;
              recordedEl.style.display = 'block';
              preview.style.display = 'none';

              document.getElementById('record-btn').style.display = 'none';
              document.getElementById('rerecord-btn').style.display = 'inline-block';
              document.getElementById('save-recording-btn').style.display = 'inline-block';
              const format = blob.type.includes('mp4') ? 'MP4' : 'WebM';
              status.textContent = `Recording complete (${format})`;
              status.className = 'recording-status recorded';
              state.recording.currentBlob = blob;
            } catch (e) {
              console.error('Finalize error:', e);
              alert('There was an issue finalizing the recording.');
            }
          };

          state.recording.mediaRecorder.start();
          state.recording.active = true;
          btn.textContent = 'Stop Recording';
          btn.className = 'button danger';
          status.textContent = '🔴 Recording...';
          status.className = 'recording-status recording';
          startRecordingTimer();

        } catch (err) {
          console.error('Recording error:', err);
          const name = err?.name || err?.code || 'Unknown';
          if (name === 'NOT_SECURE') {
            const suggest = location.protocol === 'http:' ? `Please reload over https: ${location.href.replace('http:', 'https:')}` : 'This page cannot run from a local file. Please host it or use a local https server.';
            showRecordingError(`<strong>Secure context required</strong><p style="margin-top: 6px;">${suggest}</p>`);
          } else if (name === 'NotAllowedError' || name === 'PermissionDeniedError') {
            const how = isIOS()
              ? 'Settings → Safari → Camera/Microphone → Allow for this site, then reload.'
              : 'Click the camera icon in the address bar and allow camera and microphone, then reload.';
            showRecordingError(`<strong>Permission not granted</strong><p style="margin-top: 6px;">Please allow camera and microphone access for this site. ${how}</p>`);
          } else if (name === 'NotFoundError' || name === 'DevicesNotFoundError') {
            showRecordingError(`<strong>No camera or microphone found</strong><p style="margin-top: 6px;">Please connect a camera and microphone or use the upload option below.</p>`);
          } else if (name === 'NotReadableError' || name === 'TrackStartError') {
            showRecordingError(`<strong>Camera or microphone in use</strong><p style="margin-top: 6px;">Please close other apps using the camera, then try again. You can also upload a video below.</p>`);
          } else {
            showRecordingError(`<strong>Could not access camera</strong><p style="margin-top: 6px;">${err?.message || 'Unknown error'}</p>`);
          }
        }
      } else {
        try {
          if (state.recording.mediaRecorder && state.recording.mediaRecorder.state !== 'inactive') {
            state.recording.mediaRecorder.stop();
          }
        } catch(e) { console.warn('Stop error:', e); }
        finally {
          if (state.recording.stream) { try { state.recording.stream.getTracks().forEach(track => track.stop()); } catch(e){} }
          state.recording.active = false;
          btn.textContent = 'Start Recording';
          btn.className = 'button danger';
          stopRecordingTimer();
        }
      }
    }

    function reRecord() { cleanupRecording(true).finally(() => updateRecordingImage()); }

    // Updated saveRecording function with Google Drive upload
// Updated saveRecording function with enhanced logging
async function saveRecording() {
  if (!state.recording.currentBlob) { 
    alert('Please record or upload a video first.'); 
    return; 
  }

  const saveBtn = document.getElementById('save-recording-btn');
  const originalText = saveBtn.textContent;
  saveBtn.disabled = true;
  saveBtn.textContent = 'Processing...';

  const status = document.getElementById('recording-status');
  status.textContent = '⚙️ Processing video...';
  status.className = 'recording-status recording';

  const uploadProgress = document.getElementById('upload-progress');
  uploadProgress.style.display = 'block';

  try {
    // Upload with enhanced tracking
    const uploadResult = await uploadVideoToDrive(
      state.recording.currentBlob, 
      state.sessionCode, 
      state.recording.currentImage + 1
    );

    if (uploadResult.success) {
      // Store the upload info with method tracking
      state.recording.recordings.push({ 
        image: state.recording.currentImage + 1, 
        blob: state.recording.currentBlob, 
        timestamp: new Date().toISOString(),
        driveFileId: uploadResult.fileId,
        driveFileUrl: uploadResult.fileUrl,
        filename: uploadResult.filename,
        uploadMethod: uploadResult.uploadMethod,
        dropboxPath: uploadResult.dropboxPath || ''
      });

      // Enhanced logging to Google Sheets
      const logData = {
        action: 'image_recorded_and_uploaded',
        sessionCode: state.sessionCode,
        imageNumber: state.recording.currentImage + 1,
        driveFileId: uploadResult.fileId,
        filename: uploadResult.filename,
        timestamp: new Date().toISOString(),
        deviceType: state.isMobile ? 'mobile/tablet' : 'desktop',
        // Enhanced fields
        uploadMethod: uploadResult.uploadMethod,
        dropboxPath: uploadResult.dropboxPath || '',
        fileSize: Math.round(state.recording.currentBlob.size / 1024),
        uploadStatus: 'success'
      };

      // Send to both the task logging and video upload logging
      sendToSheets(logData);
      
      // Also log specifically to video uploads table
      sendToSheets({
        action: 'log_video_upload',
        sessionCode: state.sessionCode,
        imageNumber: state.recording.currentImage + 1,
        filename: uploadResult.filename,
        fileId: uploadResult.fileId,
        fileUrl: uploadResult.fileUrl,
        fileSize: Math.round(state.recording.currentBlob.size / 1024),
        uploadTime: new Date().toISOString(),
        uploadMethod: uploadResult.uploadMethod,
        dropboxPath: uploadResult.dropboxPath || '',
        uploadStatus: 'success'
      });

      status.textContent = `✅ Upload complete via ${uploadResult.uploadMethod}!`;
      status.className = 'recording-status recorded';
      uploadProgress.style.display = 'none';

      setTimeout(() => {
        if (state.recording.currentImage === 0) { 
          state.recording.currentImage = 1; 
          updateRecordingImage(); 
        } else { 
          completeTask('ID'); 
        }
      }, 1000);

    } else {
      throw new Error(uploadResult.error || 'Upload failed');
    }

  } catch (error) {
    console.error('Upload error:', error);
    
    // Enhanced error logging
    sendToSheets({
      action: 'log_video_upload_error',
      sessionCode: state.sessionCode,
      imageNumber: state.recording.currentImage + 1,
      error: error.message,
      timestamp: new Date().toISOString(),
      deviceType: state.isMobile ? 'mobile/tablet' : 'desktop',
      attemptedMethod: 'drive_then_dropbox',
      fallbackUsed: error.message.includes('Dropbox')
    });
    
    uploadProgress.style.display = 'none';
    const errorDiv = document.getElementById('recording-error');
    errorDiv.style.display = 'block';
    errorDiv.innerHTML = `
      <strong>Upload failed</strong>
      <p style="margin-top: 6px;">
        Error: ${error.message}. You can try again or continue without uploading. 
        The video is saved locally in your browser.
      </p>
      <div class="button-group" style="margin-top: 10px;">
        <button class="button" onclick="retryVideoUpload()">Try Again</button>
        <button class="button secondary" onclick="continueWithoutUpload()">Continue Without Upload</button>
      </div>
    `;

    status.textContent = '❌ Upload failed';
    status.className = 'recording-status ready';
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = originalText;
  }
}

// Updated continueWithoutUpload with enhanced logging
function continueWithoutUpload() {
  if (confirm('Continue without uploading the video? The recording will only be saved locally in your browser.')) {
    state.recording.recordings.push({ 
      image: state.recording.currentImage + 1, 
      blob: state.recording.currentBlob, 
      timestamp: new Date().toISOString(),
      uploadSkipped: true,
      uploadMethod: 'local_only'
    });

    // Enhanced logging for skipped upload
    sendToSheets({
      action: 'image_recorded_no_upload',
      sessionCode: state.sessionCode,
      imageNumber: state.recording.currentImage + 1,
      reason: 'Upload failed - continued locally',
      timestamp: new Date().toISOString(),
      deviceType: state.isMobile ? 'mobile/tablet' : 'desktop',
      uploadMethod: 'local_only',
      uploadStatus: 'skipped'
    });

    if (state.recording.currentImage === 0) { 
      state.recording.currentImage = 1; 
      updateRecordingImage(); 
    } else { 
      completeTask('ID'); 
    }
    
    document.getElementById('recording-error').style.display = 'none';
  }
}

// Enhanced upload function - tries Google Drive first, Dropbox as fallback
async function uploadVideoToDrive(videoBlob, sessionCode, imageNumber) {
  try {
    updateUploadProgress(5, 'Starting upload…');

    // Try Google Drive FIRST
    try {
      updateUploadProgress(10, 'Connecting to Google Drive...');
      const driveResult = await uploadToGoogleDrive(videoBlob, sessionCode, imageNumber);

      if (driveResult.success) {
        updateUploadProgress(100, 'Upload complete to Google Drive!');
        return {
          success: true,
          filename: driveResult.filename,
          fileId: driveResult.fileId,
          fileUrl: driveResult.fileUrl,
          uploadMethod: 'google_drive'
        };
      } else {
        console.warn('Google Drive upload failed, trying Dropbox fallback:', driveResult.error);
        updateUploadProgress(30, 'Google Drive failed, trying Dropbox...');
      }
    } catch (driveError) {
      console.warn('Google Drive upload error, trying Dropbox fallback:', driveError);
      updateUploadProgress(30, 'Google Drive failed, trying Dropbox...');
    }

    // Fallback to Dropbox
    updateUploadProgress(40, 'Uploading to Dropbox...');
    const dropboxResult = await uploadToDropboxRegularFolder(videoBlob, sessionCode, imageNumber);

    if (dropboxResult.success) {
      updateUploadProgress(100, 'Upload complete to Dropbox!');
      return {
        success: true,
        filename: dropboxResult.filename,
        fileId: dropboxResult.fileId,
        fileUrl: dropboxResult.fileUrl,
        uploadMethod: 'dropbox',
        dropboxPath: dropboxResult.dropboxPath
      };
    } else {
      throw new Error(`Both uploads failed. Google Drive: failed, Dropbox: ${dropboxResult.error}`);
    }

  } catch (error) {
    console.error('All upload methods failed:', error);
    return {
      success: false,
      error: error.message || String(error)
    };
  }
}

// Updated Dropbox upload function (now fallback)
async function uploadToDropboxRegularFolder(videoBlob, sessionCode, imageNumber) {
  try {
    const dbx = new Dropbox.Dropbox({
      clientId: 'nvkm67mvluiu4pf',
      fetch: fetch
    });

    let accessToken = localStorage.getItem('dropbox_access_token');

    if (!accessToken) {
      updateUploadProgress(45, 'Authorizing Dropbox access...');
      const authUrl = dbx.getAuthenticationUrl('https://melodyfschwenk.github.io/spatial-cognition-study/');
      const popup = window.open(authUrl, 'dropbox_auth', 'width=600,height=700');

      accessToken = await new Promise((resolve, reject) => {
        const checkClosed = setInterval(() => {
          try {
            if (popup.closed) {
              clearInterval(checkClosed);
              reject(new Error('Authorization cancelled'));
            }

            const currentUrl = popup.location.href;
            if (currentUrl.includes('access_token=')) {
              const token = currentUrl.split('access_token=')[1].split('&')[0];
              localStorage.setItem('dropbox_access_token', token);
              popup.close();
              clearInterval(checkClosed);
              resolve(token);
            }
          } catch (e) {
            // Cross-origin error is expected during auth flow
          }
        }, 1000);

        setTimeout(() => {
          clearInterval(checkClosed);
          popup.close();
          reject(new Error('Authorization timeout'));
        }, 300000);
      });
    }

    dbx.setAccessToken(accessToken);
    updateUploadProgress(55, 'Preparing file...');

    if (videoBlob.size > 150 * 1024 * 1024) {
      throw new Error('Video too large for direct upload (max 150MB)');
    }

    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const extension = videoBlob.type.includes('mp4') ? 'mp4' : 'webm';
    const filename = `${sessionCode}_image${imageNumber}_${timestamp}.${extension}`;

    const participantFolder = `/spatial-cognition-videos/Participant_${sessionCode}`;
    const fullPath = `${participantFolder}/${filename}`;

    updateUploadProgress(60, 'Uploading to Dropbox...');

    try {
      await dbx.filesCreateFolderV2({
        path: participantFolder,
        autorename: false
      });
    } catch (folderError) {
      if (!folderError.error || !folderError.error.error_summary.includes('path/conflict')) {
        console.warn('Folder creation issue:', folderError);
      }
    }

    const response = await dbx.filesUpload({
      path: fullPath,
      contents: videoBlob,
      mode: 'add',
      autorename: true
    });

    updateUploadProgress(80, 'Getting shareable link...');

    let shareUrl = '';
    try {
      const shareResponse = await dbx.sharingCreateSharedLinkWithSettings({
        path: fullPath,
        settings: {
          access: 'viewer',
          allow_download: true,
          audience: 'public'
        }
      });
      shareUrl = shareResponse.result.url;
    } catch (shareError) {
      console.warn('Could not create share link:', shareError);
      shareUrl = `https://dropbox.com/home/spatial-cognition-videos/Participant_${sessionCode}`;
    }

    updateUploadProgress(90, 'Upload complete!');

    return {
      success: true,
      filename: filename,
      fileId: response.result.id,
      fileUrl: shareUrl,
      dropboxPath: fullPath,
      fileSize: Math.round(videoBlob.size / 1024)
    };

  } catch (error) {
    console.error('Dropbox upload failed:', error);

    if (error.message?.includes('auth') || error.status === 401) {
      localStorage.removeItem('dropbox_access_token');
    }

    return {
      success: false,
      error: error.message || String(error)
    };
  }
}

async function uploadToGoogleDrive(videoBlob, sessionCode, imageNumber) {
  try {
    updateUploadProgress(15, 'Preparing Google Drive upload…');

    // UPDATED: Higher size limit for MP4 (they're usually smaller than WebM)
    if (videoBlob.size > 45 * 1024 * 1024) { // Increased from 35MB to 45MB
      throw new Error('Video too large for Google Drive (max 45MB)');
    }

    const base64DataUrl = await blobToBase64(videoBlob);
    const base64VideoData = base64DataUrl.split(',').pop();
    updateUploadProgress(25, 'Encoding complete...');

    const uploadData = {
      action: 'upload_video',
      sessionCode,
      imageNumber,
      videoData: base64VideoData,
      fileSize: videoBlob.size,
      timestamp: new Date().toISOString()
    };

    updateUploadProgress(30, 'Sending to Google Drive...');

    const response = await fetch(CONFIG.SHEETS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(uploadData)
    });

    updateUploadProgress(35, 'Processing response...');

    let result;
    const contentType = response.headers.get('content-type');

    if (contentType && contentType.includes('application/json')) {
      result = await response.json();
    } else {
      const text = await response.text();
      try {
        result = JSON.parse(text);
      } catch (e) {
        console.error('Response text:', text);
        throw new Error('Invalid response format from server');
      }
    }

    if (!response.ok || !result.success) {
      throw new Error(result.error || result.details || `Upload failed (${response.status})`);
    }

    return {
      success: true,
      filename: result.filename,
      fileId: result.fileId,
      fileUrl: result.fileUrl
    };

  } catch (error) {
    console.error('Google Drive upload error:', error);
    return {
      success: false,
      error: error.message || String(error)
    };
  }
}

    


    // Add this NEW function after uploadVideoToDrive
function updateUploadProgress(percent, message) {
  const progressDiv = document.getElementById('upload-progress');
  const progressFill = document.getElementById('upload-progress-fill');
  const status = document.getElementById('upload-status');
  
  if (progressDiv) progressDiv.style.display = 'block';
  if (progressFill) progressFill.style.width = `${percent}%`;
  if (status) status.textContent = `${percent}%`;
  
  // Update the progress message
  const progressText = progressDiv?.querySelector('div[style*="font-weight: bold"]');
  if (progressText && message) {
    progressText.textContent = message;
  }
}

    // Helper function to convert blob to base64
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // Retry upload function
    async function retryVideoUpload() {
      document.getElementById('recording-error').style.display = 'none';
      await saveRecording();
    }

      function cleanupRecording(keepPreviewUI = false) {
      return new Promise(resolve => {
        try {
          if (state.recording.mediaRecorder && state.recording.mediaRecorder.state !== 'inactive') {
            state.recording.mediaRecorder.addEventListener('stop', () => resolve(), { once: true });
            try { state.recording.mediaRecorder.stop(); } catch(e) { resolve(); }
          } else { resolve(); }
        } catch(e) { resolve(); }
      }).finally(() => {
        try { if (state.recording.stream) state.recording.stream.getTracks().forEach(t => t.stop()); } catch(e){}
        state.recording.stream = null;
        state.recording.active = false;
        state.recording.chunks = [];
        stopRecordingTimer();

        if (!keepPreviewUI) {
          const preview = document.getElementById('video-preview');
          if (preview) { preview.pause?.(); preview.srcObject = null; preview.style.display = 'none'; }
          const recorded = document.getElementById('recorded-video');
          if (recorded) { revokeRecordedURL(); recorded.style.display = 'none'; }
          state.recording.mediaRecorder = null;
        }
      });
    }

    function ensureTaskPointer(taskCode) {
      if (!state.sequence || !state.sequence.length) return;
      if (state.sequence[state.currentTaskIndex] !== taskCode) {
        const idx = state.sequence.indexOf(taskCode);
        if (idx !== -1) state.currentTaskIndex = idx;
      }
    }

    async function skipRecording() {
      if (!confirm('Skip the image description task?')) return;
      try { await cleanupRecording(); } catch(e) { console.warn('Cleanup on skip failed silently:', e); }
      ensureTaskPointer('ID'); skipTask('ID');
    }

    let recordingTimer;
    function startRecordingTimer() {
      const timer = document.getElementById('recording-timer'); timer.style.display = 'block';
      let seconds = 0;
      state.recording.recordingStart = Date.now();
      recordingTimer = setInterval(() => {
        seconds++; const mins = Math.floor(seconds/60); const secs = seconds % 60;
        timer.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
      }, 1000);
    }
    function stopRecordingTimer() {
      clearInterval(recordingTimer);
      const t = document.getElementById('recording-timer'); if (t) t.style.display = 'none';
      if (state.recording.recordingStart) {
        state.recording.recordingDuration = Date.now() - state.recording.recordingStart;
      }
    }

    // ----- Complete/Skip -----
    function completeTask(taskCode) {
      const task = TASKS[taskCode]; if (!task) { console.error('Task not found:', taskCode); return; }
      taskTimer.stop();
      const summary = taskTimer.getSummary();
      state.totalTimeSpent += summary.elapsed;
      state.totalActiveTime += summary.active;
      if (!state.completedTasks.includes(taskCode)) state.completedTasks.push(taskCode);
      state.currentTaskIndex++;
      while (state.currentTaskIndex < state.sequence.length && state.completedTasks.includes(state.sequence[state.currentTaskIndex])) state.currentTaskIndex++;
      saveState();
      const payload = {
        action: 'task_completed',
        sessionCode: state.sessionCode,
        task: getStandardTaskName(taskCode),
        elapsed: Math.round(summary.elapsed/1000),
        active: Math.round(summary.active/1000),
        pauseCount: summary.pauseCount,
        inactive: Math.round(summary.inactive/1000),
        activity: Math.round(summary.activity),
        startTime: summary.start,
        endTime: summary.end,
        timestamp: new Date().toISOString(),
        deviceType: state.isMobile ? 'mobile/tablet' : 'desktop'
      };
      if (taskCode === 'ID' && state.recording && state.recording.recordingDuration) {
        payload.recordingDuration = Math.round(state.recording.recordingDuration/1000);
      }
      sendToSheets(payload);
      state.currentTaskType = '';
      if (state.currentTaskIndex >= state.sequence.length) showCompletionScreen(); else showProgressScreen();
    }

    function skipTask(taskCode) {
      const task = TASKS[taskCode]; if (!task) { console.error('Task not found:', taskCode); return; }
      taskTimer.stop();
      if (taskCode === 'ID') {
        if (state.recording && (state.recording.stream || state.recording.active)) {
          try { state.recording.stream?.getTracks().forEach(t => t.stop()); } catch(e){}
          state.recording.active = false; state.recording.chunks = []; stopRecordingTimer();
        }
      }
      if (!state.completedTasks.includes(taskCode)) state.completedTasks.push(taskCode);
      state.currentTaskIndex++;
      while (state.currentTaskIndex < state.sequence.length && state.completedTasks.includes(state.sequence[state.currentTaskIndex])) state.currentTaskIndex++;
      saveState();
      sendToSheets({
        action: 'task_skipped',
        sessionCode: state.sessionCode,
        task: getStandardTaskName(taskCode),
        reason: taskCode === 'ASLCT' ? 'Does not know ASL' : taskCode === 'ID' ? (state.consentStatus.videoDeclined ? 'Video consent declined' : 'User chose to skip') : 'User chose to skip',
        timestamp: new Date().toISOString(),
        deviceType: state.isMobile ? 'mobile/tablet' : 'desktop'
      });
      state.currentTaskType = '';
      if (state.currentTaskIndex >= state.sequence.length) showCompletionScreen(); else showProgressScreen();
    }

    // ----- Completion -----
    function showCompletionScreen() {
      document.getElementById('final-code').textContent = state.sessionCode;
      document.getElementById('total-time').textContent = Math.round(state.totalTimeSpent / 60000);
      showScreen('completion-screen');
      document.getElementById('pause-fab').classList.remove('active');
    }

    async function markComplete() {
      const btn = document.getElementById('mark-complete-btn');
      btn.disabled = true;
      await sendToSheets({
        action: 'study_completed',
        sessionCode: state.sessionCode,
        totalDuration: Math.round(state.totalTimeSpent / 60000),
        deviceType: state.isMobile ? 'mobile/tablet' : 'desktop',
        timestamp: new Date().toISOString()
      });
      document.getElementById('completion-message').style.display = 'block';
    }

    // ----- Utilities -----
    function pauseSession() {
      saveState();
      document.getElementById('modal-code').textContent = state.sessionCode;
      document.getElementById('pause-modal').classList.add('active');
      sendToSheets({ action: 'session_paused', sessionCode: state.sessionCode, timestamp: new Date().toISOString() });
    }
    function copyCode(btnEl) {
      const code = document.getElementById('display-code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        if (btnEl) { const original = btnEl.textContent; btnEl.textContent = '✅ Copied!'; setTimeout(() => btnEl.textContent = original, 2000); }
      });
    }
    function copyASLCTCode(btnEl) {
  navigator.clipboard.writeText(CONFIG.ASLCT_ACCESS_CODE)
    .then(() => { if (btnEl) { const o=btnEl.textContent; btnEl.textContent='✅ Copied!'; setTimeout(()=>btnEl.textContent=o,2000);} })
    .catch(() => { alert('Access code: ' + CONFIG.ASLCT_ACCESS_CODE); });
}

    function openEmbedInNewTab(taskCode) {
      const task = TASKS[taskCode];
      if (task?.embedUrl) window.open(task.embedUrl, '_blank', 'noopener');
    }
    function reloadEmbed(iframeId) {
      const f = document.getElementById(iframeId);
      if (f) f.src = f.src;
    }

    function requestEEGReminder() {
      sendToSheets({
        action: 'eeg_interest_clicked',
        sessionCode: state.sessionCode || 'none',
        participantID: state.participantID || 'none',
        email: state.email || '',
        timestamp: new Date().toISOString()
      });
      alert('Thanks! We\'ll email you when EEG scheduling opens.');
    }

    function scheduleEEG() {
  // Log the intent then open Calendly in a new tab
  sendToSheets({
    action: 'calendly_opened',
    sessionCode: state.sessionCode || 'none',
    participantID: state.participantID || 'none',
    timestamp: new Date().toISOString()
  });
  window.open(CONFIG.EEG_CALENDLY_URL, '_blank', 'noopener');
}

function markEEGScheduled() {
  // Optional prompt so you can capture a date-time string if the participant knows it
  var when = prompt('If you know your scheduled date-time, enter it here (optional). You can also leave this blank and press OK.');
  sendToSheets({
    action: 'eeg_scheduled',
    sessionCode: state.sessionCode || 'none',
    participantID: state.participantID || 'none',
    scheduledAt: when || new Date().toISOString(),
    source: 'Calendly',
    timestamp: new Date().toISOString()
  });
  alert('Thanks. We marked EEG as scheduled on our side.');
}

    function showSkipDialog(taskCode) {
  const modal = document.getElementById('skip-modal');
  const nameEl = document.getElementById('skip-task-name');
  nameEl.textContent = (TASKS[taskCode]?.name) || 'this task';
  modal.classList.add('active');

  const helpBtn = document.getElementById('skip-help-btn');
  const confirmBtn = document.getElementById('skip-confirm-btn');
  const cancelBtn = document.getElementById('skip-cancel-btn');

  helpBtn.onclick = () => {
    openSupportEmail(taskCode);
    sendToSheets({
      action: 'help_requested',
      sessionCode: state.sessionCode || 'none',
      task: getStandardTaskName(taskCode),
      timestamp: new Date().toISOString()
    });
  };

  confirmBtn.onclick = async () => {
    modal.classList.remove('active');
    await skipTaskProceed(taskCode);
  };

  cancelBtn.onclick = () => modal.classList.remove('active');
}

function openSupportEmail() {
  const subject = encodeURIComponent('Technical Support Request - Spatial Cognition Study');
  const body = encodeURIComponent(`Hi Action Brain Lab,

I need technical support with the spatial cognition study.

Device/Browser: 
Issue description: 
What I've tried: 
Accessibility needs (if any): 

Thank you!`);
  window.open(`mailto:action.brain.lab@gallaudet.edu?subject=${subject}&body=${body}`, '_blank');
}

// Do the actual skip (handles video task cleanup)
async function skipTaskProceed(taskCode) {
  if (taskCode === 'ID') {
    try { await cleanupRecording(); } catch(e) {}
  }
  // Call your existing skip function
  skipTask(taskCode);
}


    function hashCode(str) { let hash = 0; for (let i=0;i<str.length;i++){const c=str.charCodeAt(i); hash=((hash<<5)-hash)+c; hash|=0;} return hash; }

    function submitASLCTIssue() {
      const el = document.getElementById('aslct-issue-text');
      if (!el) return;
      const message = el.value.trim();
      if (!message) return;
      sendToSheets({
        action: 'aslct_issue',
        sessionCode: state.sessionCode || 'none',
        participantID: state.participantID || 'none',
        message,
        timestamp: new Date().toISOString()
      });
      el.value = '';
      alert('Issue submitted. Thank you!');
    }

    // === REPLACE sendToSheets with this ===
async function sendToSheets(payload) {
  if (!CONFIG.SHEETS_URL) return;

  const body = { ...payload, userAgent: navigator.userAgent, deviceType: payload.deviceType || (state.isMobile ? 'mobile/tablet' : 'desktop') };

  try {
    await fetch(CONFIG.SHEETS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // simple request, no preflight
      body: JSON.stringify(body)
    });
  } catch (error) {
    console.error('Error sending to sheets:', error);
  }
}



    // ---------- OPTIONAL AUTH HELPERS (frontend) ----------


    // DEBUG FUNCTION - Add this before "// Expose to window"
 async function debugVideoUpload() {
  console.log('🔍 Starting video upload debug...');
  
  // Test 1: Check configuration
  console.log('1. Configuration check:');
  console.log('SHEETS_URL:', CONFIG.SHEETS_URL);
  console.log('Is valid URL:', CONFIG.SHEETS_URL.includes('script.google.com'));
  
  // Test 2: Test basic connection
  console.log('2. Testing basic connection...');
  try {
    const res = await fetch(CONFIG.SHEETS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        action: 'test_connection',
        timestamp: new Date().toISOString()
      })
    });

    console.log('✅ Connection response:', {
      status: res.status,
      ok: res.ok,
      statusText: res.statusText,
      contentType: res.headers.get('content-type')
    });

    // Handle response carefully
    const text = await res.text();
    let payload;
    try {
      payload = JSON.parse(text);
    } catch {
      payload = text;
    }
    console.log('✅ Connection result:', payload);
    
  } catch (error) {
    console.error('❌ Connection failed:', error);
    return;
  }

  // Test 3: Create a tiny test video blob
  console.log('3. Creating test video blob...');
  try {
    // Create a minimal test "video" (just some bytes)
    const testData = new Uint8Array([0x1A, 0x45, 0xDF, 0xA3]); // WebM magic number
    const testBlob = new Blob([testData], { type: 'video/webm' });
    
    console.log('Test blob created:', {
      size: testBlob.size,
      type: testBlob.type
    });
    
    // Test 4: Test base64 conversion
    console.log('4. Testing base64 conversion...');
    const base64Data = await blobToBase64(testBlob);
    const base64VideoData = base64Data.split(',')[1];
    
    console.log('✅ Base64 conversion successful:', {
      originalSize: testBlob.size,
      base64Length: base64VideoData.length
    });
    
    // Test 5: Test actual upload
    console.log('5. Testing upload with tiny file...');
    const uploadData = {
      action: 'upload_video',
      sessionCode: 'DEBUG_' + Date.now(),
      imageNumber: 99,
      videoData: base64VideoData,
      timestamp: new Date().toISOString()
    };
    
    const uploadResponse = await fetch(CONFIG.SHEETS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(uploadData)
    });
    
    console.log('Upload response:', {
      status: uploadResponse.status,
      ok: uploadResponse.ok,
      statusText: uploadResponse.statusText,
      contentType: uploadResponse.headers.get('content-type')
    });
    
    const uploadText = await uploadResponse.text();
    let uploadResult;
    try {
      uploadResult = JSON.parse(uploadText);
    } catch {
      uploadResult = uploadText;
    }
    
    if (uploadResponse.ok && uploadResult.success) {
      console.log('✅ Upload successful:', uploadResult);
      
      // Note about cleanup
      if (uploadResult.fileId) {
        console.log('🧹 Test file created with ID:', uploadResult.fileId);
        console.log('Note: You may want to delete this test file from Google Drive');
      }
    } else {
      console.error('❌ Upload failed:', uploadResult);
    }
    
  } catch (error) {
    console.error('❌ Debug test failed:', error);
  }
  
  console.log('🔍 Debug complete! Check the console messages above.');
}
    // Expose to window
    window.showScreen = showScreen;
    window.createNewSession = createNewSession;
    window.resumeSession = resumeSession;
    window.proceedToConsent = proceedToConsent;
    window.openConsent = openConsent;
    window.markConsentDone = markConsentDone;
    window.declineVideo = declineVideo;
    window.proceedToTasks = proceedToTasks;
    window.continueToCurrentTask = continueToCurrentTask;
    window.pauseSession = pauseSession;
    window.copyCode = copyCode;
    window.copyASLCTCode = copyASLCTCode;
    window.tryMailto = tryMailto;
    window.copyEmail = copyEmail;
    window.closeEEGModal = closeEEGModal;
    window.completeTask = completeTask;
    window.skipTask = skipTask;
    window.openEmbedInNewTab = openEmbedInNewTab;
    window.reloadEmbed = reloadEmbed;
    // Video upload functions
    window.retryVideoUpload = retryVideoUpload;
    window.continueWithoutUpload = continueWithoutUpload;
     window.debugVideoUpload = debugVideoUpload;
    window.submitASLCTIssue = submitASLCTIssue;
    window.markComplete = markComplete;
    window.scheduleEEG = scheduleEEG;
window.requestEEGReminder = requestEEGReminder;
window.markEEGScheduled = markEEGScheduled;
window.showSkipDialog = showSkipDialog;
window.skipTaskProceed = skipTaskProceed;
window.openSupportEmail = openSupportEmail;

  </script>
</body>
</html>
