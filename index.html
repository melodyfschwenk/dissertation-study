<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spatial Cognition & Sign Language Research Study</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
      --gray-light: #f8f9fa;
      --gray-border: #e0e0e0;
      --text-dark: #333;
      --text-muted: #666;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--primary-gradient);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: var(--primary-gradient);
      color: white;
      padding: 40px;
      text-align: center;
    }
    
    .header h1 { font-size: 32px; margin-bottom: 10px; }
    .header p { font-size: 18px; opacity: 0.95; }
    
    .content { padding: 40px; }
    
    /* Screen containers */
    .screen { display: none; animation: fadeIn 0.3s ease-in; }
    .screen.active { display: block; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Cards and panels */
    .card {
      background: var(--gray-light);
      border-radius: 10px;
      padding: 30px;
      margin: 20px 0;
      border: 2px solid var(--gray-border);
      transition: all 0.3s;
    }
    
    .card:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102,126,234,0.2);
    }
    
    .info-banner {
      padding: 15px 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid;
    }
    
    .info-banner.success {
      background: #e8f5e9;
      border-left-color: var(--success);
      color: #1b5e20;
    }
    
    .info-banner.warning {
      background: #fff3cd;
      border-left-color: var(--warning);
      color: #856404;
    }
    
    .info-banner.info {
      background: #e3f2fd;
      border-left-color: var(--info);
      color: #0d47a1;
    }
    
    /* Forms */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-border);
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    /* Buttons */
    .button {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102,126,234,0.4);
      margin: 5px;
      display: inline-block;
    }
    
    .button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 7px 20px rgba(102,126,234,0.5);
    }
    
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .button.secondary {
      background: #6c757d;
    }
    
    .button.success {
      background: var(--success);
    }
    
    .button.danger {
      background: var(--danger);
    }
    
    .button.outline {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .button.outline:hover {
      background: #667eea;
      color: white;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    /* Session info widget */
    .session-widget {
      background: linear-gradient(135deg, #667eea20, #764ba220);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      display: none;
    }
    
    .session-widget.active { display: block; }
    
    .session-widget h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .session-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .session-detail {
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      border-left: 3px solid #667eea;
    }
    
    .session-detail label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .session-detail .value {
      font-size: 16px;
      font-weight: bold;
      color: var(--text-dark);
      margin-top: 3px;
    }
    
    /* Resume code display */
    .code-display {
      background: var(--primary-gradient);
      color: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
    }
    
    .code-display .code {
      font-size: 36px;
      font-weight: bold;
      letter-spacing: 3px;
      margin: 15px 0;
      font-family: monospace;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Consent forms section */
    .consent-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    
    .consent-card {
      background: white;
      border: 2px solid var(--gray-border);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
      position: relative;
    }
    
    .consent-card.completed {
      border-color: var(--success);
      background: #f1f8f4;
    }
    
    .consent-card.declined {
      border-color: var(--warning);
      background: #fff9e6;
    }
    
    .consent-card .status-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .consent-card h4 {
      color: var(--text-dark);
      margin-bottom: 10px;
    }
    
    .consent-card p {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    /* Task list */
    .task-list {
      list-style: none;
      margin: 20px 0;
    }
    
    .task-item {
      padding: 20px;
      margin: 10px 0;
      background: white;
      border-radius: 10px;
      border-left: 4px solid var(--gray-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s;
    }
    
    .task-item:hover {
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .task-item.completed {
      border-left-color: var(--success);
      background: #f9fdf9;
    }
    
    .task-item.current {
      border-left-color: var(--warning);
      background: #fffbf5;
      font-weight: bold;
      box-shadow: 0 3px 10px rgba(255,152,0,0.2);
    }
    
    .task-item.locked {
      opacity: 0.6;
    }
    
    .task-info {
      flex: 1;
    }
    
    .task-name {
      font-size: 16px;
      color: var(--text-dark);
      margin-bottom: 5px;
    }
    
    .task-description {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .task-status {
      font-size: 24px;
      margin-left: 20px;
    }
    
    /* Progress bar */
    .progress-bar {
      background: var(--gray-light);
      height: 30px;
      border-radius: 15px;
      overflow: hidden;
      margin: 20px 0;
      position: relative;
    }
    
    .progress-fill {
      background: var(--primary-gradient);
      height: 100%;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }
    
    /* Video recording section */
    .video-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 20px 0;
    }
    
    .video-panel {
      text-align: center;
    }
    
    .video-panel h3 {
      color: var(--text-dark);
      margin-bottom: 15px;
    }
    
    #video-preview, #recorded-video {
      width: 100%;
      max-width: 500px;
      height: 375px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      background: #000;
    }
    
    #video-preview {
      border: 2px solid var(--success);
      transform: scaleX(-1);
    }
    
    #recorded-video {
      border: 2px solid var(--info);
    }
    
    .recording-controls {
      margin-top: 20px;
      padding: 20px;
      background: var(--gray-light);
      border-radius: 10px;
    }
    
    .recording-status {
      margin: 15px 0;
      font-size: 18px;
      font-weight: bold;
    }
    
    .recording-status.ready { color: var(--text-muted); }
    .recording-status.recording { 
      color: var(--danger);
      animation: pulse 1.5s infinite;
    }
    .recording-status.recorded { color: var(--success); }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* File upload */
    .file-upload {
      border: 2px dashed #667eea;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }
    
    .file-upload:hover {
      background: #f0f4ff;
      border-color: #4a5fc4;
    }
    
    .file-upload.drag-over {
      background: #e8ecff;
      border-color: #4a5fc4;
    }
    
    .file-upload input[type="file"] {
      display: none;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 40px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      animation: slideUp 0.3s;
    }
    
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* Footer */
    .footer {
      background: var(--gray-light);
      padding: 30px;
      text-align: center;
      color: var(--text-muted);
    }
    
    /* Floating action button */
    .fab {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
      background: var(--warning);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      display: none;
      transition: all 0.3s;
    }
    
    .fab.active { display: block; }
    .fab:hover { transform: scale(1.05); }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        border-radius: 0;
        margin: 0;
      }
      
      .form-row,
      .consent-grid,
      .video-container {
        grid-template-columns: 1fr;
      }
      
      .session-details {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .button {
        width: 100%;
      }
    }
    
    /* Accessibility */
    .sr-only {
      position: absolute;
      left: -9999px;
    }
    
    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Spatial Cognition & Sign Language Research Study</h1>
      <p>Gallaudet University Research Project</p>
    </div>

    <div class="content">
      <div id="live-status" role="status" aria-live="polite" class="sr-only"></div>

      <!-- Session Widget (shows throughout) -->
      <div class="session-widget" id="session-widget">
        <h3>üìä Your Session</h3>
        <div class="session-details">
          <div class="session-detail">
            <label>Resume Code</label>
            <div class="value" id="widget-code">-</div>
          </div>
          <div class="session-detail">
            <label>Progress</label>
            <div class="value" id="widget-progress">0/9</div>
          </div>
          <div class="session-detail">
            <label>Time Spent</label>
            <div class="value" id="widget-time">0 min</div>
          </div>
          <div class="session-detail">
            <label>Current Task</label>
            <div class="value" id="widget-current">-</div>
          </div>
        </div>
      </div>

      <!-- Welcome Screen -->
      <div class="screen active" id="welcome-screen">
        <h2 style="text-align: center; margin-bottom: 30px;">Welcome to Our Research Study</h2>
        
        <div class="info-banner info">
          <strong>üìÖ Important: Zoom Task Required</strong>
          <p style="margin-top: 10px;">One task (15-20 minutes) must be completed live on Zoom. You can start other tasks now and schedule the Zoom meeting at your convenience. We support ASL or spoken English with captions.</p>
        </div>

        <div class="info-banner success" id="eeg-banner">
          <strong>üìç Live in DC, Maryland, or Northern Virginia?</strong>
          <p style="margin-top: 10px;">Add an optional in-lab EEG visit for <strong>additional compensation!</strong> Non-invasive, 30-45 minutes at Gallaudet campus.</p>
          <ul style="margin: 10px 0 0 20px; text-align: left;">
            <li>Flexible scheduling at your convenience</li>
            <li>ASL or spoken English with captions available</li>
            <li>Complete online tasks first, then add the EEG visit</li>
            <li>Boosts the scientific value of the research</li>
          </ul>
          <button class="button success" onclick="contactEEG()" style="margin-top: 10px;">I am local, tell me more</button>
        </div>

        <div class="info-banner warning">
          <strong>üì± Device Recommendation</strong>
          <p style="margin-top: 10px;">Please use a computer if possible. Some tasks require keyboard/mouse and work best in Chrome or Firefox.</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
          <div class="card">
            <h3>üÜï New Participant</h3>
            <p>Start a new study session and receive your unique resume code.</p>
            <button class="button" onclick="showScreen('new-participant')">Start New Session</button>
          </div>

          <div class="card">
            <h3>‚Ü©Ô∏è Returning Participant</h3>
            <p>Continue from where you left off using your resume code.</p>
            <button class="button secondary" onclick="showScreen('returning-participant')">Resume Session</button>
          </div>
        </div>
      </div>

      <!-- New Participant Screen -->
      <div class="screen" id="new-participant">
        <h2>New Participant Registration</h2>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Create your unique session to track your progress</p>

        <div class="form-row">
          <div class="form-group">
            <label for="first-initial">First Name Initial</label>
            <input type="text" id="first-initial" maxlength="1" placeholder="J" />
          </div>
          <div class="form-group">
            <label for="last-initial">Last Name Initial</label>
            <input type="text" id="last-initial" maxlength="1" placeholder="D" />
          </div>
        </div>

        <div class="form-group">
          <label for="email">Email (optional - for reminders if you pause)</label>
          <input type="email" id="email" placeholder="your.email@example.com" />
        </div>

        <div class="button-group">
          <button class="button" id="create-session-btn" onclick="createNewSession()" disabled>Create Session</button>
          <button class="button secondary" onclick="showScreen('welcome-screen')">Back</button>
        </div>
      </div>

      <!-- Returning Participant Screen -->
      <div class="screen" id="returning-participant">
        <h2>Resume Your Session</h2>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Enter your 8-character code to continue</p>

        <div class="form-group">
          <label for="resume-code">Resume Code</label>
          <input 
            type="text" 
            id="resume-code" 
            maxlength="8" 
            placeholder="ABC12345"
            style="text-transform: uppercase; font-family: monospace; font-size: 24px; letter-spacing: 2px; text-align: center;"
          />
        </div>

        <div class="button-group">
          <button class="button" onclick="resumeSession()">Resume Session</button>
          <button class="button secondary" onclick="showScreen('welcome-screen')">Back</button>
        </div>
      </div>

      <!-- Session Created Screen -->
      <div class="screen" id="session-created">
        <h2>‚úÖ Session Created Successfully!</h2>
        
        <div class="code-display">
          <p>Your Resume Code:</p>
          <div class="code" id="display-code">ABC12345</div>
          <button class="button outline" onclick="copyCode()">üìã Copy Code</button>
          <p style="font-size: 14px; margin-top: 15px;">Save this code to resume anytime</p>
        </div>

        <div class="info-banner warning">
          <strong>‚ö†Ô∏è Important: Save Your Code!</strong>
          <ul style="margin: 10px 0 0 20px; text-align: left;">
            <li>Write down or screenshot your code</li>
            <li>Use this code to continue from any device</li>
            <li>Progress saves automatically after each task</li>
          </ul>
        </div>

        <button class="button success" onclick="proceedToConsent()" style="display: block; margin: 20px auto;">
          I've Saved My Code - Continue
        </button>
      </div>

      <!-- Unified Consent Screen -->
      <div class="screen" id="consent-screen">
        <h2>üìã Consent Forms</h2>
        <p style="color: var(--text-muted); margin-bottom: 20px;">Please complete both consent forms to participate. If you've already completed these through the screener, mark them as done.</p>

        <div class="consent-grid">
          <div class="consent-card" id="consent1-card">
            <div class="status-icon">üìÑ</div>
            <h4>Research Consent</h4>
            <p>General study participation consent (required)</p>
            <button class="button" onclick="openConsent('CONSENT1')">Open Form</button>
            <button class="button outline" onclick="markConsentDone('consent1')" style="margin-top: 10px;">Mark as Done</button>
          </div>

          <div class="consent-card" id="consent2-card">
            <div class="status-icon">üé•</div>
            <h4>Video Consent</h4>
            <p>For video recording task (optional)</p>
            <button class="button" onclick="openConsent('CONSENT2')">Open Form</button>
            <div class="button-group" style="margin-top: 10px;">
              <button class="button outline" onclick="markConsentDone('consent2')">Mark as Done</button>
              <button class="button secondary" onclick="declineVideo()">Decline Video</button>
            </div>
          </div>
        </div>

        <div class="info-banner info">
          <strong>Already completed these forms?</strong>
          <p style="margin-top: 5px;">If you completed the consent forms through the screener, click "Mark as Done" on each form above.</p>
        </div>

        <button class="button success" id="continue-from-consent" onclick="proceedToTasks()" disabled style="display: block; margin: 20px auto;">
          Continue to Study Tasks
        </button>
      </div>

      <!-- Progress Overview Screen -->
      <div class="screen" id="progress-screen">
        <h2>Your Study Progress</h2>
        
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%">
            <span id="progress-text">0%</span>
          </div>
        </div>

        <ul class="task-list" id="task-list"></ul>

        <div class="button-group">
          <button class="button" id="continue-task-btn" onclick="continueToCurrentTask()">Continue to Current Task</button>
          <button class="button secondary" onclick="pauseSession()">Save & Exit</button>
        </div>
      </div>

      <!-- Task Display Screen -->
      <div class="screen" id="task-screen">
        <h2 id="task-title">Task Title</h2>
        <div id="task-instructions" style="margin: 20px 0;"></div>
        <div id="task-content"></div>
      </div>

      <!-- MRT Upload Screen -->
      <div class="screen" id="mrt-upload-screen">
        <h2>Upload MRT Results</h2>
        <p style="color: var(--text-muted); margin-bottom: 20px;">Please upload the CSV file from the Mental Rotation Task</p>
        
        <div class="file-upload" id="file-upload">
          <div style="font-size: 48px; color: #667eea;">üìÅ</div>
          <p>Click to select or drag your CSV file here</p>
          <input type="file" id="mrt-file" accept=".csv" />
        </div>
        
        <div id="upload-status" style="margin-top: 20px;"></div>
        
        <div class="button-group">
          <button class="button success" id="mrt-continue" onclick="completeMRTUpload()" style="display: none;">Continue</button>
          <button class="button secondary" onclick="skipMRTUpload()">Skip Upload (Email Later)</button>
        </div>
      </div>

      <!-- Recording Screen -->
      <div class="screen" id="recording-screen">
        <h2>Image Description Task</h2>
        
        <div class="info-banner info" id="recording-consent-check" style="display: none;">
          <strong>Video consent required</strong>
          <p>Please complete the video consent form to proceed with this task.</p>
          <div class="button-group" style="margin-top: 10px;">
            <button class="button" onclick="openConsent('CONSENT2')">Open Video Consent</button>
            <button class="button secondary" id="skip-recording-consent-btn">Skip Task</button>
          </div>
        </div>

        <div id="recording-content" style="display: none;">
          <div class="info-banner warning">
            <strong>Language for descriptions:</strong>
            <p>If you know ASL, please use ASL. Otherwise, spoken English is fine.</p>
          </div>

          <div style="text-align: center; margin: 20px 0;">
            <span style="background: var(--info); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold;">
              Image <span id="image-number">1</span> of 2
            </span>
          </div>

          <div class="video-container">
            <div class="video-panel">
              <h3>Image to Describe</h3>
              <img id="current-image" src="" alt="Image to describe" style="width: 100%; border-radius: 10px;" />
            </div>

            <div class="video-panel">
              <h3>Your Video</h3>
              <video id="video-preview" autoplay muted playsinline style="display: none;"></video>
              <video id="recorded-video" controls playsinline style="display: none;"></video>
              
              <div class="recording-controls">
                <div class="recording-status ready" id="recording-status">Ready to record</div>
                <div id="recording-timer" style="font-size: 24px; color: var(--danger); margin: 10px 0; display: none;">00:00</div>
                
                <div class="button-group">
                  <button class="button danger" id="record-btn" onclick="toggleRecording()">Start Recording</button>
                  <button class="button secondary" id="rerecord-btn" onclick="reRecord()" style="display: none;">Re-record</button>
                  <button class="button success" id="save-recording-btn" onclick="saveRecording()" style="display: none;">Save & Continue</button>
                </div>
              </div>
            </div>
          </div>

          <div class="info-banner info">
            <strong>What to describe (30-60 seconds):</strong>
            <ul style="margin: 10px 0 0 20px; text-align: left;">
              <li>Objects and people you see</li>
              <li>What is happening in the image</li>
            </ul>
          </div>

          <button class="button secondary" id="skip-recording-btn" style="display: block; margin: 20px auto;">Skip This Task</button>
        </div>
      </div>

      <!-- Completion Screen -->
      <div class="screen" id="completion-screen">
        <div style="text-align: center; padding: 50px;">
          <h2 style="color: var(--success); font-size: 36px; margin-bottom: 20px;">üéâ Study Complete!</h2>
          <p style="font-size: 20px; margin: 20px 0;">Thank you for participating in our research!</p>
          <div class="code-display">
            <p>Your session code was:</p>
            <div class="code" id="final-code">ABC12345</div>
          </div>
          <p style="margin-top: 20px;">Total time: <strong id="total-time">0</strong> minutes</p>
          <p style="margin-top: 30px; color: var(--text-muted);">You may now close this window.</p>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>For technical support: <a href="mailto:action.brain.lab@gallaudet.edu">action.brain.lab@gallaudet.edu</a></p>
      <p style="margin-top: 10px; font-size: 14px;">Your progress is automatically saved after each task.</p>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button class="fab" id="pause-fab" onclick="pauseSession()">‚è∏Ô∏è Save & Exit</button>

  <!-- Modal -->
  <div class="modal" id="pause-modal">
    <div class="modal-content">
      <h3>Session Saved!</h3>
      <p>Your progress has been saved.</p>
      <div class="code-display">
        <div class="code" id="modal-code">ABC12345</div>
      </div>
      <p style="font-size: 14px; color: var(--text-muted); margin-top: 20px;">Return anytime to complete remaining tasks.</p>
      <button class="button" onclick="location.reload()">Exit Study</button>
    </div>
  </div>

  <!-- EEG Contact Modal -->
  <div class="modal" id="eeg-modal">
    <div class="modal-content">
      <h3>üìç Local EEG Add-On Information</h3>
      <div class="info-banner info" style="margin: 20px 0;">
        <strong>Contact the Action Brain Lab:</strong>
        <p style="margin-top: 10px;">
          Email: <strong>action.brain.lab@gallaudet.edu</strong>
          <button class="button outline" onclick="copyEmail()" style="margin-left: 10px;">Copy Email</button>
        </p>
      </div>
      
      <div style="text-align: left; background: var(--gray-light); padding: 20px; border-radius: 10px; margin: 20px 0;">
        <strong>Include in your email:</strong>
        <ul style="margin: 10px 0 0 20px;">
          <li>Your session code: <strong id="eeg-session-code">TBD</strong></li>
          <li>That you're interested in the local EEG add-on</li>
          <li>Your preferred days/times for the visit</li>
          <li>Communication preference (ASL or English)</li>
        </ul>
      </div>
      
      <div class="button-group">
        <button class="button" onclick="tryMailto()">Open Email Client</button>
        <button class="button secondary" onclick="closeEEGModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      SHEETS_URL: 'https://script.google.com/macros/s/AKfycbzDGf-cwvjmZuieeOKNleKLd38pLyWAw-k8nsTLYOX7RiSHSKJJmihOXo7u711oyD80nA/exec',
      IMAGE_1: 'images/description1.jpg',
      IMAGE_2: 'images/description2.jpg'
    };

    // Task definitions
    const TASKS = {
      'ZOOM': {
        name: 'Schedule Zoom Task',
        description: '15-20 minute live assessment',
        url: 'https://calendly.com/melodyschwenk/spatialcognitionzoom',
        type: 'external',
        required: true
      },
      'MRT': {
        name: 'Mental Rotation Task',
        description: 'Spatial reasoning assessment',
        url: 'https://psych.hanover.edu/javatest/cle/Cognition_js/exp/mentRot.html',
        type: 'external',
        requiresUpload: true
      },
      'ASLCT': {
        name: 'ASL Comprehension Test',
        description: 'For ASL users only',
        url: 'https://vl2portal.gallaudet.edu/assessment/login.php',
        type: 'external',
        canSkip: true
      },
      'VCN': {
        name: 'Virtual Campus Navigation',
        description: 'Navigate virtual environments',
        url: 'http://www.virtualsilcton.com/study/753798747',
        type: 'external'
      },
      'SN': {
        name: 'Spatial Navigation',
        description: 'Maze navigation exercises',
        url: 'https://melodyfschwenk.github.io/spatial-navigation-web/',
        type: 'external'
      },
      'ID': {
        name: 'Image Description',
        description: 'Describe images (video recording)',
        type: 'recording',
        canSkip: true
      },
      'DEMO': {
        name: 'Demographics Survey',
        description: 'Background information & payment',
        url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_8GJcoF3hkHoP8BU',
        type: 'external'
      }
    };

    // Consent forms (separate from main task sequence)
    const CONSENTS = {
      'CONSENT1': {
        name: 'Research Consent',
        url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_cGZEQDXQpUbGq1g'
      },
      'CONSENT2': {
        name: 'Video Consent',
        url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_5j0XhME387Kii8u'
      }
    };

    // Task sequences (without consent forms)
    const SEQUENCES = [
      ['ZOOM', 'MRT', 'ASLCT', 'VCN', 'SN', 'ID', 'DEMO'],
      ['ZOOM', 'ASLCT', 'VCN', 'SN', 'ID', 'MRT', 'DEMO'],
      ['ZOOM', 'VCN', 'SN', 'ID', 'MRT', 'ASLCT', 'DEMO'],
      ['ZOOM', 'SN', 'ID', 'MRT', 'ASLCT', 'VCN', 'DEMO'],
      ['ZOOM', 'ID', 'MRT', 'ASLCT', 'VCN', 'SN', 'DEMO']
    ];

    // State management
    let state = {
      sessionCode: '',
      participantID: '',
      email: '',
      sequenceIndex: -1,
      sequence: [],
      currentTaskIndex: 0,
      completedTasks: [],
      startTime: null,
      totalTimeSpent: 0,
      lastActivity: null,
      consentStatus: {
        consent1: false,
        consent2: false,
        videoDeclined: false
      },
      recording: {
        active: false,
        mediaRecorder: null,
        chunks: [],
        currentImage: 0,
        recordings: [],
        stream: null,
        currentBlob: null
      }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      checkSavedSession();
    });

    // Event listeners
    function setupEventListeners() {
      // Input validation
      document.getElementById('first-initial').addEventListener('input', validateInitials);
      document.getElementById('last-initial').addEventListener('input', validateInitials);
      document.getElementById('resume-code').addEventListener('input', e => {
        e.target.value = e.target.value.toUpperCase();
      });

      // File upload
      const fileUpload = document.getElementById('file-upload');
      const fileInput = document.getElementById('mrt-file');
      if (fileUpload && fileInput) {
        fileUpload.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        
        // Drag and drop
        fileUpload.addEventListener('dragover', e => {
          e.preventDefault();
          fileUpload.classList.add('drag-over');
        });
        fileUpload.addEventListener('dragleave', () => {
          fileUpload.classList.remove('drag-over');
        });
        fileUpload.addEventListener('drop', e => {
          e.preventDefault();
          fileUpload.classList.remove('drag-over');
          if (e.dataTransfer.files.length > 0) {
            handleFileUpload({ target: { files: e.dataTransfer.files } });
          }
        });
      }

      // Bind skip buttons explicitly so they work even under strict CSP
      document.getElementById('skip-recording-btn')?.addEventListener('click', skipRecording);
      document.getElementById('skip-recording-consent-btn')?.addEventListener('click', skipRecording);
    }

    function validateInitials(e) {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 1);
      const first = document.getElementById('first-initial').value;
      const last = document.getElementById('last-initial').value;
      document.getElementById('create-session-btn').disabled = !(first && last);
    }

    // Screen navigation
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(screenId);
      if (screen) screen.classList.add('active');
      
      // Update session widget visibility
      const widget = document.getElementById('session-widget');
      const showWidget = ['progress-screen', 'task-screen', 'consent-screen', 'mrt-upload-screen', 'recording-screen'].includes(screenId);
      if (widget) widget.classList.toggle('active', showWidget && state.sessionCode);
      
      // Update FAB visibility
      const fab = document.getElementById('pause-fab');
      if (fab) fab.classList.toggle('active', showWidget && state.sessionCode);
    }

    // Session management
    function generateCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    function createNewSession() {
      const first = document.getElementById('first-initial').value.trim().toUpperCase();
      const last = document.getElementById('last-initial').value.trim().toUpperCase();
      const email = document.getElementById('email').value.trim();

      if (!first || !last) {
        alert('Please enter your initials');
        return;
      }

      state.sessionCode = generateCode();
      state.participantID = `${first}${last}_${Date.now().toString().slice(-4)}`;
      state.email = email;
      state.sequenceIndex = Math.abs(hashCode(state.sessionCode)) % SEQUENCES.length;
      state.sequence = SEQUENCES[state.sequenceIndex].slice();
      state.startTime = Date.now();
      state.lastActivity = new Date().toISOString();

      saveState();
      sendToSheets({
        action: 'session_created',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        email: state.email,
        sequenceIndex: state.sequenceIndex,
        timestamp: new Date().toISOString()
      });

      document.getElementById('display-code').textContent = state.sessionCode;
      showScreen('session-created');
    }

    function resumeSession() {
      const code = document.getElementById('resume-code').value.toUpperCase();
      if (code.length !== 8) {
        alert('Please enter your 8-character resume code');
        return;
      }

      try {
        const saved = localStorage.getItem(`study_${code}`);
        if (saved) {
          state = JSON.parse(saved);
          updateSessionWidget();
          
          if (!state.consentStatus.consent1) {
            showScreen('consent-screen');
          } else {
            showProgressScreen();
          }
        } else {
          alert('Session not found. Please check your code.');
        }
      } catch (err) {
        console.error(err);
        alert('Error loading session');
      }
    }

    function checkSavedSession() {
      try {
        const recentCode = localStorage.getItem('recent_session');
        if (!recentCode) return;
        
        const saved = localStorage.getItem(`study_${recentCode}`);
        if (!saved) return;
        
        const data = JSON.parse(saved);
        const daysSince = (Date.now() - new Date(data.lastActivity).getTime()) / (1000 * 60 * 60 * 24);
        
        if (daysSince < 30) {
          if (confirm(`Welcome back! Resume session ${recentCode}?`)) {
            state = data;
            updateSessionWidget();
            showProgressScreen();
          }
        }
      } catch (e) {
        console.warn('Could not check saved session', e);
      }
    }

    function saveState() {
      try {
        state.lastActivity = new Date().toISOString();
        localStorage.setItem(`study_${state.sessionCode}`, JSON.stringify(state));
        localStorage.setItem('recent_session', state.sessionCode);
      } catch (e) {
        console.warn('Could not save state', e);
      }
    }

    // Consent handling
    function proceedToConsent() {
      showScreen('consent-screen');
      updateConsentDisplay();
    }

    function openConsent(type) {
      const consent = CONSENTS[type];
      if (consent) {
        window.open(consent.url, '_blank');
        sendToSheets({
          action: 'consent_opened',
          sessionCode: state.sessionCode,
          type: type,
          timestamp: new Date().toISOString()
        });
      }
    }

    function markConsentDone(type) {
      if (type === 'consent1') {
        state.consentStatus.consent1 = true;
        document.getElementById('consent1-card').classList.add('completed');
        document.querySelector('#consent1-card .status-icon').textContent = '‚úÖ';
      } else if (type === 'consent2') {
        state.consentStatus.consent2 = true;
        document.getElementById('consent2-card').classList.add('completed');
        document.querySelector('#consent2-card .status-icon').textContent = '‚úÖ';
      }
      
      saveState();
      updateConsentDisplay();
      
      sendToSheets({
        action: 'consent_completed',
        sessionCode: state.sessionCode,
        type: type,
        timestamp: new Date().toISOString()
      });
    }

    function declineVideo() {
      if (confirm('Decline video consent? You can still participate in other tasks.')) {
        state.consentStatus.videoDeclined = true;
        state.consentStatus.consent2 = true;
        document.getElementById('consent2-card').classList.add('declined');
        document.querySelector('#consent2-card .status-icon').textContent = '‚ö†Ô∏è';
        saveState();
        updateConsentDisplay();
        
        sendToSheets({
          action: 'video_declined',
          sessionCode: state.sessionCode,
          timestamp: new Date().toISOString()
        });
      }
    }

    function updateConsentDisplay() {
      const btn = document.getElementById('continue-from-consent');
      const ready = state.consentStatus.consent1 && (state.consentStatus.consent2 || state.consentStatus.videoDeclined);
      btn.disabled = !ready;
      
      if (state.consentStatus.consent1) {
        document.getElementById('consent1-card').classList.add('completed');
        document.querySelector('#consent1-card .status-icon').textContent = '‚úÖ';
      }
      
      if (state.consentStatus.consent2 || state.consentStatus.videoDeclined) {
        const card = document.getElementById('consent2-card');
        card.classList.add(state.consentStatus.videoDeclined ? 'declined' : 'completed');
        document.querySelector('#consent2-card .status-icon').textContent = 
          state.consentStatus.videoDeclined ? '‚ö†Ô∏è' : '‚úÖ';
      }
    }

    function proceedToTasks() {
      if (!state.consentStatus.consent1) {
        alert('Please complete the research consent form');
        return;
      }
      showProgressScreen();
    }

    // Progress management
    function showProgressScreen() {
      updateTaskList();
      updateProgressBar();
      updateSessionWidget();
      showScreen('progress-screen');
    }

    function updateTaskList() {
      const list = document.getElementById('task-list');
      list.innerHTML = '';
      
      state.sequence.forEach((taskCode, index) => {
        const task = TASKS[taskCode];
        const li = document.createElement('li');
        li.className = 'task-item';
        
        const isCompleted = state.completedTasks.includes(taskCode);
        const isCurrent = index === state.currentTaskIndex && !isCompleted;
        
        if (isCompleted) li.classList.add('completed');
        else if (isCurrent) li.classList.add('current');
        else li.classList.add('locked');
        
        li.innerHTML = `
          <div class="task-info">
            <div class="task-name">${task.name}</div>
            <div class="task-description">${task.description}</div>
          </div>
          <div class="task-status">
            ${isCompleted ? '‚úÖ' : (isCurrent ? '‚ñ∂Ô∏è' : '‚≠ï')}
          </div>
        `;
        
        list.appendChild(li);
      });
    }

    function updateProgressBar() {
      const progress = (state.completedTasks.length / state.sequence.length) * 100;
      document.getElementById('progress-fill').style.width = `${progress}%`;
      document.getElementById('progress-text').textContent = `${Math.round(progress)}%`;
    }

    function updateSessionWidget() {
      if (!state.sessionCode) return;
      
      document.getElementById('widget-code').textContent = state.sessionCode;
      document.getElementById('widget-progress').textContent = 
        `${state.completedTasks.length}/${state.sequence.length}`;
      document.getElementById('widget-time').textContent = 
        `${Math.round(state.totalTimeSpent / 60000)} min`;
      
      const currentTask = state.sequence[state.currentTaskIndex];
      document.getElementById('widget-current').textContent = 
        currentTask ? TASKS[currentTask].name : 'Complete';
    }

    // Task management
    function continueToCurrentTask() {
      if (state.currentTaskIndex >= state.sequence.length) {
        showCompletionScreen();
        return;
      }
      
      const taskCode = state.sequence[state.currentTaskIndex];
      startTask(taskCode);
    }

    function startTask(taskCode) {
      const task = TASKS[taskCode];
      
      if (!task) {
        console.error('Task not found:', taskCode);
        return;
      }
      
      if (!state.taskData) {
        state.taskData = {};
      }
      
      state.taskData[taskCode] = {
        startTime: Date.now()
      };
      
      if (task.type === 'recording') {
        showRecordingTask();
      } else if (task.requiresUpload && taskCode === 'MRT') {
        showMRTTask();
      } else {
        showExternalTask(taskCode);
      }
      
      sendToSheets({
        action: 'task_started',
        sessionCode: state.sessionCode,
        task: task.name,
        timestamp: new Date().toISOString()
      });
    }

    function showExternalTask(taskCode) {
      const task = TASKS[taskCode];
      
      document.getElementById('task-title').textContent = task.name;
      document.getElementById('task-instructions').innerHTML = `
        <p>${task.description}</p>
        <div class="info-banner info">
          <strong>Instructions:</strong>
          <ol style="margin: 10px 0 0 20px; text-align: left;">
            <li>Click "Open Task" to launch in a new tab</li>
            <li>Complete the task as instructed</li>
            <li>Return to this tab when finished</li>
            <li>Click "Mark Complete" to continue</li>
          </ol>
        </div>
      `;
      
      const content = document.getElementById('task-content');
      content.innerHTML = `
        <div class="button-group">
          <button class="button" onclick="window.open('${task.url}', '_blank')">Open Task</button>
          <button class="button success" onclick="completeTask('${taskCode}')">Mark Complete</button>
        </div>
      `;
      
      if (task.canSkip) {
        content.innerHTML += `
          <button class="button secondary" onclick="skipTask('${taskCode}')" style="display: block; margin: 20px auto;">
            ${taskCode === 'ASLCT' ? 'Skip - I Do Not Know ASL' : 'Skip This Task'}
          </button>
        `;
      }
      
      showScreen('task-screen');
    }

    function showMRTTask() {
      showExternalTask('MRT');
      
      setTimeout(() => {
        const content = document.getElementById('task-content');
        content.innerHTML += `
          <div class="info-banner warning" style="margin-top: 20px;">
            <strong>After completing the task:</strong>
            <p>Upload your CSV results file or email it later</p>
            <button class="button" onclick="showScreen('mrt-upload-screen')" style="margin-top: 10px;">
              Upload Results
            </button>
          </div>
        `;
      }, 3000);
    }

    function showRecordingTask() {
      // Initialize recording state
      state.recording.currentImage = 0;
      state.recording.recordings = [];
      state.recording.currentBlob = null;
      
      // Check video consent
      if (!state.consentStatus.consent2 || state.consentStatus.videoDeclined) {
        document.getElementById('recording-consent-check').style.display = 'block';
        document.getElementById('recording-content').style.display = 'none';
      } else {
        document.getElementById('recording-consent-check').style.display = 'none';
        document.getElementById('recording-content').style.display = 'block';
        updateRecordingImage();
      }
      
      showScreen('recording-screen');
    }

    function revokeRecordedURL() {
      const recorded = document.getElementById('recorded-video');
      if (recorded && recorded.src) {
        try { URL.revokeObjectURL(recorded.src); } catch(e) {}
        recorded.removeAttribute('src');
        recorded.load();
      }
    }

    function updateRecordingImage() {
      const imageNum = state.recording.currentImage + 1;
      document.getElementById('image-number').textContent = imageNum;
      document.getElementById('current-image').src = 
        imageNum === 1 ? CONFIG.IMAGE_1 : CONFIG.IMAGE_2;
      
      // Reset UI
      const preview = document.getElementById('video-preview');
      const recorded = document.getElementById('recorded-video');
      preview.style.display = 'none';
      recorded.style.display = 'none';
      revokeRecordedURL();
      state.recording.currentBlob = null;

      document.getElementById('record-btn').style.display = 'inline-block';
      document.getElementById('rerecord-btn').style.display = 'none';
      document.getElementById('save-recording-btn').style.display = 'none';
      document.getElementById('recording-status').textContent = 'Ready to record';
      document.getElementById('recording-status').className = 'recording-status ready';
    }

    async function toggleRecording() {
      const btn = document.getElementById('record-btn');
      const status = document.getElementById('recording-status');
      const preview = document.getElementById('video-preview');
      
      if (!state.recording.active) {
        try {
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('Camera access not available in this environment');
          }
          
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480 },
            audio: true
          });
          
          state.recording.stream = stream;
          preview.srcObject = stream;
          preview.style.display = 'block';
          
          if (!window.MediaRecorder) {
            throw new Error('MediaRecorder not supported in this browser');
          }
          
          let options = {};
          if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')) {
            options.mimeType = 'video/webm;codecs=vp9,opus';
          } else if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus')) {
            options.mimeType = 'video/webm;codecs=vp8,opus';
          }
          
          state.recording.mediaRecorder = new MediaRecorder(stream, options);
          state.recording.chunks = [];
          
          state.recording.mediaRecorder.ondataavailable = e => {
            if (e.data && e.data.size > 0) state.recording.chunks.push(e.data);
          };
          
          state.recording.mediaRecorder.onstop = () => {
            try {
              const blob = new Blob(state.recording.chunks, { type: (options.mimeType || 'video/webm') });
              const url = URL.createObjectURL(blob);
              const recordedEl = document.getElementById('recorded-video');
              recordedEl.src = url;
              recordedEl.style.display = 'block';
              preview.style.display = 'none';
              
              document.getElementById('record-btn').style.display = 'none';
              document.getElementById('rerecord-btn').style.display = 'inline-block';
              document.getElementById('save-recording-btn').style.display = 'inline-block';
              
              status.textContent = 'Recording complete';
              status.className = 'recording-status recorded';
              
              state.recording.currentBlob = blob;
            } catch (e) {
              console.error('Error finalizing recording:', e);
              alert('There was an issue finalizing the recording.');
            }
          };
          
          state.recording.mediaRecorder.start();
          state.recording.active = true;
          
          btn.textContent = 'Stop Recording';
          btn.className = 'button danger';
          status.textContent = 'üî¥ Recording...';
          status.className = 'recording-status recording';
          
          startRecordingTimer();
          
        } catch (err) {
          console.error('Recording error:', err);
          
          let errorMsg = 'Could not access camera/microphone.\n\n';
          
          if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            errorMsg += 'Please allow camera and microphone access when prompted.\n';
            errorMsg += 'You may need to click the camera icon in your browser\'s address bar.';
          } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
            errorMsg += 'No camera or microphone found.\n';
            errorMsg += 'Please ensure your device has a camera and microphone connected.';
          } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
            errorMsg += 'Your camera or microphone is already in use.\n';
            errorMsg += 'Please close other applications using the camera.';
          } else if (err.message.includes('not available in this environment')) {
            errorMsg = 'Camera access is blocked in this preview environment.\n\n';
            errorMsg += 'This will work normally on your actual website.\n';
            errorMsg += 'The preview environment blocks camera access for security.';
            
            status.textContent = '‚ö†Ô∏è Preview Mode - Camera blocked';
            status.className = 'recording-status';
            status.style.color = 'var(--warning)';
            
            const demoNote = document.createElement('div');
            demoNote.className = 'info-banner warning';
            demoNote.style.marginTop = '20px';
            demoNote.setAttribute('data-demo', 'true');
            demoNote.innerHTML = `
              <strong>Preview Environment Limitation</strong>
              <p style="margin-top: 10px;">Camera access is blocked in this preview for security reasons.</p>
              <p>On your actual website, participants will be able to grant permissions and record normally.</p>
              <button class="button secondary" id="skip-demo-btn" style="margin-top: 10px;">Skip Task (Demo)</button>
            `;
            
            const container = document.getElementById('recording-content');
            if (!container.querySelector('#skip-demo-btn')) {
              container.insertBefore(demoNote, container.querySelector('.video-container'));
              document.getElementById('skip-demo-btn')?.addEventListener('click', skipRecording);
            }
            return;
          } else if (err.message && err.message.includes('MediaRecorder not supported')) {
            errorMsg += 'Your browser does not support in-browser recording. You may proceed by skipping this task.';
          } else {
            errorMsg += 'Error: ' + err.message;
          }
          
          alert(errorMsg);
        }
      } else {
        try {
          if (state.recording.mediaRecorder && state.recording.mediaRecorder.state !== 'inactive') {
            state.recording.mediaRecorder.stop();
          }
        } catch(e) {
          console.warn('Stop error:', e);
        } finally {
          if (state.recording.stream) {
            try { state.recording.stream.getTracks().forEach(track => track.stop()); } catch(e){}
          }
          state.recording.active = false;
          btn.textContent = 'Start Recording';
          btn.className = 'button danger';
          stopRecordingTimer();
        }
      }
    }

    function reRecord() {
      // Clean up any leftover stream, timer, and previous blob url
      cleanupRecording(true).finally(() => {
        updateRecordingImage();
      });
    }

    function saveRecording() {
      if (!state.recording.currentBlob) {
        alert('Please record a video first.');
        return;
      }
      state.recording.recordings.push({
        image: state.recording.currentImage + 1,
        blob: state.recording.currentBlob,
        timestamp: new Date().toISOString()
      });
      
      sendToSheets({
        action: 'image_recorded',
        sessionCode: state.sessionCode,
        imageNumber: state.recording.currentImage + 1,
        timestamp: new Date().toISOString()
      });
      
      if (state.recording.currentImage === 0) {
        state.recording.currentImage = 1;
        updateRecordingImage();
      } else {
        completeTask('ID');
      }
    }

    // New: robust cleanup for streams, recorder, timer, and URLs
    function cleanupRecording(keepPreviewUI = false) {
      return new Promise(resolve => {
        try {
          if (state.recording.mediaRecorder && state.recording.mediaRecorder.state !== 'inactive') {
            state.recording.mediaRecorder.addEventListener('stop', () => resolve(), { once: true });
            try { state.recording.mediaRecorder.stop(); } catch(e) { resolve(); }
          } else {
            resolve();
          }
        } catch(e) {
          resolve();
        }
      }).finally(() => {
        try {
          if (state.recording.stream) {
            state.recording.stream.getTracks().forEach(t => t.stop());
          }
        } catch(e){}
        state.recording.stream = null;
        state.recording.active = false;
        state.recording.chunks = [];
        stopRecordingTimer();
        if (!keepPreviewUI) {
          const preview = document.getElementById('video-preview');
          if (preview) {
            preview.pause?.();
            preview.removeAttribute('srcObject');
            preview.style.display = 'none';
          }
          revokeRecordedURL();
          const recorded = document.getElementById('recorded-video');
          if (recorded) recorded.style.display = 'none';
        }
      });
    }

    function ensureTaskPointer(taskCode) {
      if (!state.sequence || !state.sequence.length) return;
      if (state.sequence[state.currentTaskIndex] !== taskCode) {
        const idx = state.sequence.indexOf(taskCode);
        if (idx !== -1) state.currentTaskIndex = idx;
      }
    }

    async function skipRecording() {
      if (!confirm('Skip the image description task?')) return;
      try {
        await cleanupRecording();
      } catch(e) {
        console.warn('Cleanup on skip failed silently:', e);
      }
      ensureTaskPointer('ID');
      skipTask('ID');
    }

    let recordingTimer;
    function startRecordingTimer() {
      const timer = document.getElementById('recording-timer');
      timer.style.display = 'block';
      let seconds = 0;
      
      recordingTimer = setInterval(() => {
        seconds++;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        timer.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }, 1000);
    }

    function stopRecordingTimer() {
      clearInterval(recordingTimer);
      const timer = document.getElementById('recording-timer');
      if (timer) timer.style.display = 'none';
    }

    // File upload
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please upload a CSV file');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const uploadStatus = document.getElementById('upload-status');
        uploadStatus.innerHTML = `
          <div class="info-banner success">
            ‚úÖ File uploaded successfully!
            <br><small>${file.name}</small>
          </div>
        `;
        
        document.getElementById('mrt-continue').style.display = 'inline-block';
        
        sendToSheets({
          action: 'file_uploaded',
          sessionCode: state.sessionCode,
          filename: file.name,
          timestamp: new Date().toISOString()
        });
      };
      reader.readAsText(file);
    }

    function completeMRTUpload() {
      completeTask('MRT');
    }

    function skipMRTUpload() {
      if (confirm('Skip upload? You can email the file later.')) {
        completeTask('MRT');
      }
    }

    // Task completion
    function completeTask(taskCode) {
      const task = TASKS[taskCode];
      
      if (!task) {
        console.error('Task not found:', taskCode);
        return;
      }
      
      const startTime = state.taskData && state.taskData[taskCode]?.startTime || Date.now();
      const timeSpent = Date.now() - startTime;
      state.totalTimeSpent += timeSpent;
      
      if (!state.completedTasks.includes(taskCode)) {
        state.completedTasks.push(taskCode);
      }
      
      state.currentTaskIndex++;
      
      while (state.currentTaskIndex < state.sequence.length && 
             state.completedTasks.includes(state.sequence[state.currentTaskIndex])) {
        state.currentTaskIndex++;
      }
      
      saveState();
      
      sendToSheets({
        action: 'task_completed',
        sessionCode: state.sessionCode,
        task: task.name,
        duration: Math.round(timeSpent / 1000),
        timestamp: new Date().toISOString()
      });
      
      if (state.currentTaskIndex >= state.sequence.length) {
        showCompletionScreen();
      } else {
        showProgressScreen();
      }
    }

    function skipTask(taskCode) {
      const task = TASKS[taskCode];
      if (!task) {
        console.error('Task not found:', taskCode);
        return;
      }
      
      if (taskCode === 'ID') {
        // Extra defensive cleanup if skipping from recording
        if (state.recording && (state.recording.stream || state.recording.active)) {
          try { state.recording.stream?.getTracks().forEach(t => t.stop()); } catch(e){}
          state.recording.active = false;
          state.recording.chunks = [];
          stopRecordingTimer();
        }
      }
      
      if (!state.completedTasks.includes(taskCode)) {
        state.completedTasks.push(taskCode);
      }
      
      state.currentTaskIndex++;
      
      while (state.currentTaskIndex < state.sequence.length && 
             state.completedTasks.includes(state.sequence[state.currentTaskIndex])) {
        state.currentTaskIndex++;
      }
      
      saveState();
      
      sendToSheets({
        action: 'task_skipped',
        sessionCode: state.sessionCode,
        task: task.name,
        reason: taskCode === 'ASLCT' ? 'Does not know ASL' : 
                taskCode === 'ID' ? 
                  (state.consentStatus.videoDeclined ? 'Video consent declined' : 'User chose to skip') : 
                  'User chose to skip',
        timestamp: new Date().toISOString()
      });
      
      if (state.currentTaskIndex >= state.sequence.length) {
        showCompletionScreen();
      } else {
        showProgressScreen();
      }
    }

    // Completion
    function showCompletionScreen() {
      document.getElementById('final-code').textContent = state.sessionCode;
      document.getElementById('total-time').textContent = Math.round(state.totalTimeSpent / 60000);
      
      sendToSheets({
        action: 'study_completed',
        sessionCode: state.sessionCode,
        totalDuration: Math.round(state.totalTimeSpent / 60000),
        timestamp: new Date().toISOString()
      });
      
      showScreen('completion-screen');
      document.getElementById('pause-fab').classList.remove('active');
    }

    // Utilities
    function pauseSession() {
      saveState();
      document.getElementById('modal-code').textContent = state.sessionCode;
      document.getElementById('pause-modal').classList.add('active');
      
      sendToSheets({
        action: 'session_paused',
        sessionCode: state.sessionCode,
        timestamp: new Date().toISOString()
      });
    }

    function copyCode() {
      const code = document.getElementById('display-code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        const btn = event.target;
        const original = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => btn.textContent = original, 2000);
      });
    }

    function contactEEG() {
      if (!state.sessionCode) {
        const proceed = confirm('Would you like to create your session first? This will give you a code we can reference for the EEG scheduling.');
        if (proceed) {
          showScreen('new-participant');
          return;
        }
      }
      
      const modal = document.getElementById('eeg-modal');
      const codeEl = document.getElementById('eeg-session-code');
      if (codeEl) codeEl.textContent = state.sessionCode || 'TBD';
      if (modal) modal.classList.add('active');
      
      sendToSheets({
        action: 'eeg_interest_clicked',
        sessionCode: state.sessionCode || 'none',
        participantID: state.participantID || 'none',
        timestamp: new Date().toISOString()
      });
    }
    
    function tryMailto() {
      const code = state.sessionCode || 'TBD';
      const participantEmail = state.email ? `\nParticipant email: ${state.email}` : '';
      const subject = `Local EEG add-on interest - Session ${code}`;
      const body = [
        'Hello Action Brain Lab,',
        '',
        'I live in DC/MD/VA and would like to add the EEG visit for additional compensation.',
        '',
        `Session code: ${code}`,
        participantEmail,
        '',
        'Preferred days or times:',
        'Accessibility or communication preferences: ASL, spoken English, captions',
        '',
        'Thank you.'
      ].join('\n');
      
      try {
        window.location.href = `mailto:action.brain.lab@gallaudet.edu?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      } catch (e) {
        alert('Could not open email client. Please manually email: action.brain.lab@gallaudet.edu');
      }
    }
    
    function copyEmail() {
      navigator.clipboard.writeText('action.brain.lab@gallaudet.edu').then(() => {
        const btn = event.target;
        const original = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => btn.textContent = original, 2000);
      }).catch(() => {
        alert('Email: action.brain.lab@gallaudet.edu');
      });
    }
    
    function closeEEGModal() {
      document.getElementById('eeg-modal').classList.remove('active');
    }

    function hashCode(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash;
    }

    async function sendToSheets(data) {
      if (!CONFIG.SHEETS_URL || CONFIG.SHEETS_URL.includes('YOUR_')) {
        console.log('Sheets not configured:', data);
        return;
      }
      
      try {
        await fetch(CONFIG.SHEETS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } catch (error) {
        console.error('Error sending to sheets:', error);
      }
    }

    // Expose functions to global scope for onclick handlers
    window.showScreen = showScreen;
    window.createNewSession = createNewSession;
    window.resumeSession = resumeSession;
    window.proceedToConsent = proceedToConsent;
    window.openConsent = openConsent;
    window.markConsentDone = markConsentDone;
    window.declineVideo = declineVideo;
    window.proceedToTasks = proceedToTasks;
    window.continueToCurrentTask = continueToCurrentTask;
    window.pauseSession = pauseSession;
    window.copyCode = copyCode;
    window.contactEEG = contactEEG;
    window.tryMailto = tryMailto;
    window.copyEmail = copyEmail;
    window.closeEEGModal = closeEEGModal;
    window.completeTask = completeTask;
    window.skipTask = skipTask;
    window.toggleRecording = toggleRecording;
    window.reRecord = reRecord;
    window.saveRecording = saveRecording;
    window.completeMRTUpload = completeMRTUpload;
    window.skipMRTUpload = skipMRTUpload;
    window.skipRecording = skipRecording;
  </script>
</body>
</html>

