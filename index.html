<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Spatial Cognition & Sign Language Research Study</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }
    .header h1 { font-size: 32px; margin-bottom: 10px; }
    .header p { font-size: 18px; opacity: 0.95; }
    .content { padding: 40px; }

    .welcome-screen { text-align: center; padding: 30px; }
    .welcome-screen h2 { color: #333; margin-bottom: 20px; }
    .option-card {
      background: #f8f9fa; border-radius: 10px; padding: 30px; margin: 20px 0;
      border: 2px solid #e0e0e0; transition: all 0.3s;
    }
    .option-card:hover { border-color: #667eea; box-shadow: 0 5px 15px rgba(102,126,234,0.2); }
    .option-card h3 { color: #333; margin-bottom: 15px; }
    .option-card p { color: #666; margin-bottom: 20px; }

    .participant-setup, .resume-section, .progress-overview,
    .session-info, .task-display, .upload-section, .recording-section { display: none; }

    .participant-setup, .resume-section, .progress-overview,
    .session-info, .task-display, .upload-section, .recording-section {
      background: #f8f9fa; padding: 30px; border-radius: 10px; margin-bottom: 30px;
    }

    .participant-setup h2, .resume-section h2, .task-display h2 { color: #333; margin-bottom: 20px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
    .form-group input {
      width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;
    }
    .form-group input:focus { outline: none; border-color: #667eea; }

    .resume-code-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0;
    }
    .resume-code-display .code { font-size: 32px; font-weight: bold; letter-spacing: 2px; margin: 10px 0; font-family: monospace; }
    .save-instructions { background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 8px; margin: 20px 0; }

    .consent-status {
      background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: none;
    }
    .consent-item { display: flex; align-items: center; padding: 10px 0; }
    .consent-item .status { margin-right: 15px; font-size: 24px; }
    .consent-item.complete .status { color: #4caf50; }
    .consent-item.pending .status { color: #ff9800; }
    .consent-item.declined .status { color: #f44336; }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold;
      cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102,126,234,0.4); margin: 10px;
    }
    .button:hover:not(:disabled){ transform: translateY(-2px); box-shadow: 0 7px 20px rgba(102,126,234,0.5); }
    .button:disabled { opacity: 0.5; cursor: not-allowed; }
    .button-secondary { background: #6c757d; }
    .button-success { background: #28a745; }

    .progress-overview h3 { color: #333; margin-bottom: 20px; }
    .task-list { list-style: none; }
    .task-list li {
      padding: 15px; margin: 10px 0; background: white; border-radius: 8px; border-left: 4px solid #e0e0e0;
      display: flex; align-items: center; justify-content: space-between;
    }
    .task-list li.completed { border-left-color: #4caf50; background: #f1f8f4; }
    .task-list li.current { border-left-color: #ffc107; background: #fff3cd; font-weight: bold; }
    .task-list li.locked { opacity: 0.6; }
    .task-list .task-status { font-size: 20px; margin-left: 10px; }

    .session-info { background: #e8f4f8; border-radius: 10px; padding: 20px; margin-bottom: 20px; display: none; }
    .session-info h4 { color: #1565c0; margin-bottom: 10px; }
    .session-detail { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #d1e7f3; }
    .session-detail:last-child { border-bottom: none; }

    .task-instructions { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .task-button { background: #4caf50; color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 10px; transition: background 0.3s; }
    .task-button:hover { background: #45a049; }

    .pause-button {
      background: #ff9800; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 14px; font-weight: bold;
      cursor: pointer; position: fixed; top: 20px; right: 20px; z-index: 1000; display: none;
    }
    .pause-button:hover { background: #f57c00; }

    .file-upload {
      border: 2px dashed #667eea; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s;
    }
    .file-upload:hover { background: #f0f4ff; }
    .file-upload.drag-over { background: #e8ecff; border-color: #4a5fc4; }
    .file-upload input[type="file"] { display: none; }

    .video-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0; align-items: start; }
    .image-panel { text-align: center; }
    .image-panel img {
      width: 100%; max-width: 500px; height: auto; border-radius: 10px; border: 2px solid #e0e0e0; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .video-panel { text-align: center; }
    #video-preview {
      width: 100%; max-width: 500px; height: 375px; background: #000; border-radius: 10px; border: 2px solid #4caf50;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: scaleX(-1); display: none;
    }
    #recorded-video {
      width: 100%; max-width: 500px; height: 375px; border-radius: 10px; border: 2px solid #2196f3; display: none;
    }
    .recording-controls { margin-top: 20px; padding: 20px; background: white; border-radius: 10px; }
    .recording-status { margin: 15px 0; font-size: 18px; font-weight: bold; }
    .recording-status.ready { color: #666; }
    .recording-status.recording { color: #f44336; animation: pulse 1.5s infinite; }
    .recording-status.recorded { color: #4caf50; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
    .record-button { background: #f44336; color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 10px; transition: all 0.3s; }
    .record-button:hover { transform: scale(1.05); }
    .record-button.recording { background: #ff9800; animation: recordPulse 1.5s infinite; }
    .record-button.re-record { background: #9c27b0; }
    .save-button { background: #4caf50; color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 10px; display: none; }
    .save-button:hover { background: #45a049; }
    .image-counter { background: #2196f3; color: white; padding: 10px 20px; border-radius: 25px; display: inline-block; margin-bottom: 20px; font-weight: bold; }
    @keyframes recordPulse { 0%{box-shadow:0 0 0 0 rgba(255,152,0,0.7);} 70%{box-shadow:0 0 0 10px rgba(255,152,0,0);} 100%{box-shadow:0 0 0 0 rgba(255,152,0,0);} }

    @media (max-width: 768px) {
      .video-container { grid-template-columns: 1fr; }
      .container { border-radius: 0; margin: 0; }
    }

    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: white; margin: 10% auto; padding: 40px; border-radius: 15px; width: 90%; max-width: 500px; text-align: center; }
    .modal-content h3 { color: #333; margin-bottom: 20px; }
    .modal-content p { color: #666; margin-bottom: 30px; }

    .completion-screen { text-align: center; padding: 50px; }
    .completion-screen h2 { color: #4caf50; font-size: 36px; margin-bottom: 20px; }

    .footer { background: #f5f5f5; padding: 30px; text-align: center; color: #666; }
    .banner { background: #fff3cd; border: 1px solid #ffe08a; padding: 12px 14px; border-radius: 8px; margin-bottom: 15px; }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Spatial Cognition & Sign Language Research Study</h1>
      <p>Gallaudet University Research Project</p>
    </div>

    <div class="content">
      <div id="live-status" role="status" aria-live="polite" style="position:absolute;left:-9999px;"></div>

      <div class="welcome-screen" id="welcome-screen">
        <h2>Welcome to Our Research Study</h2>
        <p style="margin-bottom: 20px; color: #666;">
          This study can be completed at your own pace. You can pause and resume at any time using your unique code.
        </p>

        <!-- Local EEG reminder (nudges DC/MD/VA residents) -->
        <div style="background:#e8f5e9; border:1px solid #a5d6a7; padding:12px 14px; border-radius:8px; margin:16px 0;">
          <strong>üìç Live in DC, Maryland, or Northern Virginia?</strong>
          <p style="margin:8px 0 0; color:#1b5e20;">
            Add a quick in-lab EEG visit for <b>additional compensation</b>. It is non-invasive and takes about 30-45 minutes.
            Choosing the EEG portion boosts the scientific value, and we really appreciate it.
          </p>
          <ul style="margin:10px 0 0 18px; color:#2e7d32; text-align:left;">
            <li>Flexible scheduling on the Gallaudet campus in DC</li>
            <li>ASL or spoken English; captions available</li>
            <li>Do the online tasks first, then add the EEG visit</li>
          </ul>
          <div style="margin-top:10px;">
            <button id="btn-eeg-local" type="button" class="button button-success" onclick="contactEEGLocal()"
              aria-label="I am local, tell me more about the EEG visit">
              I am local, tell me more
            </button>
          </div>
        </div>

        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #4caf50;">
          <strong style="color: #2e7d32;">üìÖ Zoom task (15-20 minutes, required)</strong>
          <p style="margin: 10px 0; color: #333;">
            One short task must be done live on Zoom and cannot be completed asynchronously.
            Please use the Calendly link inside this portal. <b>You can start the other online tasks now</b>
            and choose a Zoom time that works for you.
          </p>
          <p style="margin: 6px 0 0; color: #333;">
            We can use <b>ASL</b> or <b>spoken English</b>, Zoom captions are available.
          </p>
          <p style="margin: 6px 0 0; color:#333; font-size: 14px;">
            Times are shown in your local time zone.
          </p>
        </div>

        <div id="device-note" style="background:#fff3cd;border:1px solid #ffe08a;padding:12px 16px;border-radius:8px;margin:20px 0;">
          <strong>üì± Kindly note:</strong>
          Please use a <strong>computer</strong> if possible. Two tasks
          (<em>Virtual Campus Navigation</em> and <em>Spatial Navigation</em>) will not work on a phone or iPad
          unless a mouse and keyboard are connected. We recommend using <strong>Chrome</strong> or <strong>Firefox</strong>.
        </div>

        <div class="option-card">
          <h3>üÜï New Participant</h3>
          <p>Start a new study session. You will receive a unique code to save your progress.</p>
          <button class="button" id="btn-start-new" type="button" onclick="showNewParticipant()">Start New Session (get your resume code)</button>
        </div>

        <div class="option-card">
          <h3>‚Ü©Ô∏è Returning Participant</h3>
          <p>Continue your study from where you left off using your resume code.</p>
          <button class="button button-secondary" id="btn-returning" type="button" onclick="showReturningParticipant()">Resume with Code</button>
        </div>
      </div>

      <div class="participant-setup" id="new-participant">
        <h2>New Participant Registration</h2>
        <p style="margin-bottom: 20px; color: #666;">Please enter your initials to create your unique session.</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="form-group">
            <label for="first-initial">First Name Initial:</label>
            <input type="text" id="first-initial" maxlength="1" placeholder="J" />
          </div>
          <div class="form-group">
            <label for="last-initial">Last Name Initial:</label>
            <input type="text" id="last-initial" maxlength="1" placeholder="D" />
          </div>
        </div>

        <div class="form-group">
          <label for="email">Email (optional, for a reminder if you pause):</label>
          <input type="email" id="email" placeholder="your.email@example.com" />
        </div>

        <button class="button" id="create-session-btn" type="button" onclick="createNewSession()" disabled>Create Session</button>
        <button class="button button-secondary" id="btn-back-from-new" type="button" onclick="backToWelcome()">Back</button>
      </div>

      <div class="resume-section" id="returning-participant">
        <h2>Resume Your Session</h2>
        <p style="margin-bottom: 20px; color: #666;">Enter your 8-character resume code to continue.</p>

        <div class="form-group">
          <label for="resume-code">Resume Code:</label>
          <input
            type="text"
            id="resume-code"
            maxlength="8"
            placeholder="ABC12345"
            style="text-transform: uppercase; font-family: monospace; font-size: 20px; letter-spacing: 2px;"
          />
        </div>

        <button class="button" id="btn-resume-session" type="button" onclick="resumeSession()">Resume Session</button>
        <button class="button button-secondary" id="btn-back-from-returning" type="button" onclick="backToWelcome()">Back</button>
      </div>

      <div class="resume-section" id="code-display" style="display: none;">
        <h2>Your Session Created!</h2>
        <div class="resume-code-display">
          <p>Your Resume Code:</p>
          <div class="code" id="session-code"></div>
          <button class="button button-secondary" style="margin-top:10px;" id="btn-copy-code" type="button" onclick="copyCode('#session-code', this)">Copy code</button>
          <p style="font-size: 14px; margin-top: 10px;">Save this code to resume your session later</p>
        </div>

        <div class="save-instructions">
          <h4>‚ö†Ô∏è Important: Save Your Code!</h4>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li>Write down or screenshot your resume code</li>
            <li>You can use this code to continue from any device</li>
            <li>Your progress is automatically saved after each task</li>
            <li>You can complete the study over multiple sessions</li>
          </ul>
        </div>

        <button class="button button-success" id="btn-saved-code-continue" type="button" onclick="startConsent()">I have saved my code, continue</button>
      </div>

      <div class="consent-status" id="consent-status">
        <h3>‚úÖ Zoom Meeting Scheduled, now complete consent forms</h3>
        <p style="margin: 8px 0 16px; color:#333;"><em>Recording is optional and used only for scoring.</em></p>
        <p style="margin-bottom: 20px; color: #666;">
          Now that you have scheduled your Zoom meeting, please complete the consent forms before we meet. If you have already completed these through the screener, please mark them as done here.
        </p>

        <div class="consent-item" id="consent-1">
          <span class="status">‚≠ï</span>
          <div>
            <strong>Research Consent Form</strong>
            <p style="font-size: 14px; color: #666;">General study participation consent</p>
          </div>
        </div>

        <div class="consent-item" id="consent-2">
          <span class="status">‚≠ï</span>
          <div>
            <strong>Video Consent Form</strong>
            <p style="font-size: 14px; color: #666;">Consent for video recording</p>
          </div>
        </div>

        <div id="consent-choices" style="text-align:center; margin-top:10px; display:none;">
          <button class="button button-secondary" id="decline-video-btn" type="button" onclick="declineVideoConsent()">I do not consent to video, continue</button>
        </div>

        <button class="button" id="consent-btn" type="button" onclick="proceedWithConsent()">Continue</button>
        <p style="margin-top: 15px; font-size: 14px; color: #666; text-align: center;">
          If you already completed both forms through the screener, click each form and then click "I have completed this task" to mark them as done.
        </p>
      </div>

      <div class="session-info" id="session-info">
        <h4>üìä Your Session</h4>
        <div class="session-detail"><span>Resume Code:</span><strong id="info-code"></strong></div>
        <div class="session-detail"><span>Progress:</span><strong id="info-progress"></strong></div>
        <div class="session-detail"><span>Time Spent:</span><strong id="info-time"></strong></div>
        <div class="session-detail"><span>Last Activity:</span><strong id="info-last"></strong></div>
      </div>

      <div class="progress-overview" id="progress-overview">
        <h3>Your Study Progress</h3>
        <ul class="task-list" id="task-list"></ul>
        <button class="button" id="continue-btn" type="button" onclick="continueToCurrentTask()">Continue to Current Task</button>
        <button class="button button-secondary" id="btn-save-exit" type="button" onclick="pauseAndSave()">Save & Exit</button>
      </div>

      <div class="task-display" id="task-display">
        <h2 id="task-title"></h2>
        <div class="task-instructions" id="task-instructions"></div>
        <div id="task-content"></div>
      </div>

      <div class="upload-section" id="mrt-upload">
        <h3>Upload MRT Data</h3>
        <p>After completing the Mental Rotation Task, please upload the CSV file you downloaded.</p>
        <div class="file-upload" id="file-upload">
          <div style="font-size: 48px; color: #667eea;">üìÅ</div>
          <p>Click to select your MRT data file</p>
          <p style="font-size: 14px; color: #666;">Or drag and drop the CSV file here</p>
          <input type="file" id="mrt-file" accept=".csv" />
        </div>
        <div id="upload-status" style="margin-top:12px;"></div>
        <button class="button button-success" id="mrt-continue" type="button" style="display: none;" onclick="completeCurrentTask()">Continue to Next Task</button>
      </div>

      <div class="recording-section" id="recording-section">
        <div class="banner" id="always-skip-banner" style="display:flex; align-items:center; justify-content:space-between;">
          <div><strong>This task is voluntary.</strong> You may skip it at any time.</div>
          <button class="button button-secondary" type="button" onclick="skipTask('ID')">Skip this task</button>
        </div>

        <h3>Image Description Task - Video Recording</h3>
        <div class="image-counter" id="image-counter">Image 1 of 2</div>

        <div id="video-consent-banner" class="banner" style="display:none;">
          <strong>Video consent not completed.</strong>
          <div style="margin-top:8px;">
            <button class="button" type="button" onclick="openExternalTask('CONSENT2')">Open Video Consent Form</button>
            <button class="button button-secondary" type="button" onclick="skipTask('ID')">Skip this task</button>
          </div>
        </div>

        <div id="video-declined-banner" class="banner" style="display:none;">
          <strong>You declined video consent.</strong> This task is optional. You can skip it now.
          <div style="margin-top:8px;">
            <button class="button button-secondary" type="button" onclick="skipTask('ID')">Skip this task</button>
          </div>
        </div>

        <div class="video-container" id="video-container">
          <div class="image-panel">
            <h3>Image to Describe</h3>
            <img
              id="current-image"
              loading="lazy"
              decoding="async"
              src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect width='400' height='300' fill='%23ddd'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999'%3EImage%3C/text%3E%3C/svg%3E"
              alt="Current Image"
            />
            <p style="margin-top: 15px; color: #666;">Look at this image carefully and describe what you see</p>
          </div>

          <div class="video-panel">
            <h3>Your Video</h3>
            <video id="video-preview" autoplay muted playsinline></video>
            <video id="recorded-video" controls playsinline></video>

            <div class="recording-controls">
              <div class="recording-status ready" id="recording-status">Ready to record</div>
              <div id="recording-timer" style="font-size: 24px; color: #f44336; margin: 10px 0; display: none;">00:00</div>
              <button class="record-button" id="record-button" type="button">Start Recording</button>
              <button class="record-button re-record" id="re-record-button" type="button" style="display: none;">Re-record Video</button>
              <button class="save-button" id="save-video-button" type="button">Save & Continue to Next Image</button>
              <div style="text-align:center; margin-top:8px;">
                <button class="button button-secondary" type="button" onclick="skipTask('ID')">Skip this task</button>
              </div>
            </div>
          </div>
        </div>

        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px;">
          <strong>What to describe (30-60 seconds):</strong>
          <ul style="margin: 10px 0 0 20px; text-align: left;">
            <li>Objects and people you see</li>
            <li>Where things are located (left, right, front, back, etc.)</li>
            <li>What is happening in the image</li>
            <li>Spatial relationships between objects</li>
          </ul>
        </div>
      </div>

      <button class="button button-success" id="general-continue" type="button" style="display: none;" onclick="completeCurrentTask()">I have completed this task, continue</button>
    </div>

    <div class="footer">
      <p>For technical support: <a href="mailto:action.brain.lab@gallaudet.edu">action.brain.lab@gallaudet.edu</a></p>
      <p style="margin-top: 10px; font-size: 14px;">Your progress is automatically saved after each task.</p>
    </div>
  </div>

  <button class="pause-button" id="pause-button" type="button" onclick="pauseAndSave()">‚è∏Ô∏è Save & Exit</button>

  <div class="modal" id="pause-modal">
    <div class="modal-content">
      <h3>Session Saved!</h3>
      <p>Your progress has been saved. Use this code to resume:</p>
      <div class="resume-code-display" style="margin: 20px 0;">
        <div class="code" id="modal-code"></div>
      </div>
      <p style="font-size: 14px; color: #666;">You can return at any time to complete the remaining tasks.</p>
      <button class="button" type="button" onclick="window.location.reload()">Exit Study</button>
    </div>
  </div>

  <script>
    // ===============================================
    // CONFIGURATION
    // ===============================================
    const CONFIG = {
      GOOGLE_SHEETS_URL: 'https://script.google.com/macros/s/AKfycbzDGf-cwvjmZuieeOKNleKLd38pLyWAw-k8nsTLYOX7RiSHSKJJmihOXo7u711oyD80nA/exec',
      IMAGE_1_URL: 'images/description1.jpg',
      IMAGE_2_URL: 'images/description2.jpg'
    };

    // ===============================================
    // TASK DEFINITIONS
    // ===============================================
    const TASKS = {
      'ZOOM': {
        name: 'Schedule Zoom Task (15-20 min, required)',
        url: 'https://calendly.com/melodyschwenk/spatialcognitionzoom',
        type: 'external',
        required: true,
        instructions: `
          <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #2e7d32;">üìÖ Book your Zoom task (15-20 minutes)</strong>
            <p style="margin:10px 0;">
              This brief assessment must be completed live on Zoom and cannot be done asynchronously.
              You may begin the other online tasks now and book a Zoom time that works for you using Calendly.
            </p>
            <ul style="margin: 5px 0 10px 20px; text-align: left;">
              <li>Live assessment (15-20 min), no prep needed</li>
              <li>We can use ASL or spoken English; Zoom captions available</li>
              <li>Calendly opens in a new tab; return here after booking</li>
            </ul>
            <p style="margin:6px 0 0; font-size:14px;">Times are shown in your local time zone.</p>
          </div>
        `
      },

      'CONSENT1': {
        name: 'Research Consent Form',
        url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_cGZEQDXQpUbGq1g',
        type: 'consent',
        instructions: 'Please complete the research consent form. This is required before participating in the study. If already done in the screener, click "I have completed this task".'
      },
      'CONSENT2': {
        name: 'Video Consent Form',
        url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_5j0XhME387Kii8u',
        type: 'consent',
        instructions: 'Please complete the video consent form for the video recording task. If you do not consent to video, you can decline and continue.'
      },
      'MRT': {
        name: 'Mental Rotation Task',
        url: 'https://psych.hanover.edu/javatest/cle/Cognition_js/exp/mentRot.html',
        type: 'external',
        requiresUpload: true,
        uploadOptional: true,
        instructions: `
          <strong>Important Instructions:</strong>
          <ol style="text-align: left; margin: 15px 0;">
            <li>Click "Open Task"</li>
            <li>Scroll to the bottom and click "Begin Experiment"</li>
            <li>Do not change any settings</li>
            <li>Complete all trials</li>
            <li>Download your results as a CSV</li>
            <li>Return to this tab</li>
          </ol>
          <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <strong>üìÅ About the CSV File:</strong>
            You can upload it now or continue without uploading.
          </div>
        `
      },
      'ASLCT': {
        name: 'ASL Comprehension Test',
        url: 'https://vl2portal.gallaudet.edu/assessment/login.php',
        type: 'external',
        accessCode: 'NWMTLYMTP',
        canSkip: true,
        instructions: `
          <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #2e7d32;">üìå Who should complete this task:</strong>
            This is for people who know ASL at any level. If you do not know ASL, you can skip this task.
          </div>
        `
      },
      'VCN': {
        name: 'Virtual Campus Navigation',
        url: 'http://www.virtualsilcton.com/study/753798747',
        type: 'external',
        instructions: `
          <strong>Instructions:</strong>
          <ol style="text-align: left; margin: 15px 0;">
            <li>Click "Open Task"</li>
            <li>Wait for the virtual environment to load</li>
            <li>Follow the on-screen navigation instructions</li>
            <li>Complete all navigation trials</li>
            <li>Return to this tab</li>
          </ol>
        `
      },
      'SN': {
        name: 'Spatial Navigation Task',
        url: 'https://melodyfschwenk.github.io/spatial-navigation-web/',
        type: 'external',
        instructions: `
          <strong>Instructions:</strong>
          <ol style="text-align: left; margin: 15px 0;">
            <li>Click "Open Task"</li>
            <li>Read the instructions carefully</li>
            <li>Complete the maze navigation exercises</li>
            <li>Return to this tab</li>
          </ol>
        `
      },
      'ID': {
        name: 'Image Description',
        type: 'recording',
        canSkip: true,
        instructions: `
          <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #6a1b9a;">Language for your descriptions:</strong>
            If you know ASL, please use ASL. If not, spoken English is fine. This task is voluntary.
          </div>
        `
      },
      'DEMO': {
        name: 'Demographics & Language Background',
        url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_8GJcoF3hkHoP8BU',
        type: 'external',
        instructions: 'Complete the demographics survey. This will also provide payment information.'
      }
    };

    // ===============================================
    // SEQUENCES
    // ===============================================
    const SEQUENCES = [
      ['ZOOM', 'CONSENT1', 'CONSENT2', 'MRT', 'ASLCT', 'VCN', 'SN', 'ID', 'DEMO'],
      ['ZOOM', 'CONSENT1', 'CONSENT2', 'ASLCT', 'VCN', 'SN', 'ID', 'MRT', 'DEMO'],
      ['ZOOM', 'CONSENT1', 'CONSENT2', 'VCN', 'SN', 'ID', 'MRT', 'ASLCT', 'DEMO'],
      ['ZOOM', 'CONSENT1', 'CONSENT2', 'SN', 'ID', 'MRT', 'ASLCT', 'VCN', 'DEMO'],
      ['ZOOM', 'CONSENT1', 'CONSENT2', 'ID', 'MRT', 'ASLCT', 'VCN', 'SN', 'DEMO']
    ];

    // ===============================================
    // STATE MANAGEMENT
    // ===============================================
    let state = {
      sessionCode: '',
      participantID: '',
      email: '',
      sequenceIndex: -1,
      sequence: [],
      currentTaskIndex: 0,
      completedTasks: [],
      startTime: null,
      totalTimeSpent: 0,
      lastActivity: null,
      taskData: {},
      consentCompleted: { consent1: false, consent2: false },
      videoConsentDeclined: false,
      recording: false,
      mediaRecorder: null,
      videoChunks: [],
      currentImageIndex: 0,
      imageRecordings: [],
      recordingStartTime: null,
      recordingTimer: null,
      currentStream: null
    };

    // ===============================================
    // ACCESSIBILITY HELPERS
    // ===============================================
    function announce(msg) {
      const n = document.getElementById('live-status');
      if (!n) return;
      n.textContent = '';
      setTimeout(() => n.textContent = msg, 50);
    }

    window.addEventListener('beforeunload', (e) => {
      if (state.recording) { e.preventDefault(); e.returnValue = ''; }
    });
    window.addEventListener('pagehide', () => {
      if (state.currentStream) state.currentStream.getTracks().forEach(t => t.stop());
    });

    // ===============================================
    // INITIALIZATION
    // ===============================================
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      const titleEl = document.getElementById('task-title');
      if (titleEl) titleEl.setAttribute('tabindex', '-1');
      checkForSavedSession();
    });

    function setupEventListeners() {
      const firstEl = document.getElementById('first-initial');
      const lastEl = document.getElementById('last-initial');
      const resumeEl = document.getElementById('resume-code');

      if (firstEl) firstEl.addEventListener('input', handleInitialInput);
      if (lastEl) lastEl.addEventListener('input', handleInitialInput);
      if (resumeEl) resumeEl.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });

      // Fallback bindings in case inline onclick is blocked by CSP
      const map = [
        ['btn-start-new', showNewParticipant],
        ['btn-returning', showReturningParticipant],
        ['btn-back-from-new', backToWelcome],
        ['btn-back-from-returning', backToWelcome],
        ['create-session-btn', createNewSession],
        ['btn-saved-code-continue', startConsent],
        ['consent-btn', proceedWithConsent],
        ['continue-btn', continueToCurrentTask],
        ['btn-save-exit', pauseAndSave],
        ['btn-eeg-local', contactEEGLocal],
        ['btn-resume-session', resumeSession],       // <-- add
        ['decline-video-btn', declineVideoConsent],  // <-- add (exists in the DOM)
      ];

      for (const [id, fn] of map) {
        const el = document.getElementById(id);
        if (el && typeof fn === 'function') el.addEventListener('click', fn);
      }

      const fileUpload = document.getElementById('file-upload');
      const fileInput = document.getElementById('mrt-file');
      if (fileUpload && fileInput) {
        fileUpload.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleMRTUpload);
        fileUpload.addEventListener('dragover', (e) => { e.preventDefault(); fileUpload.classList.add('drag-over'); });
        fileUpload.addEventListener('dragleave', () => { fileUpload.classList.remove('drag-over'); });
        fileUpload.addEventListener('drop', (e) => {
          e.preventDefault(); fileUpload.classList.remove('drag-over');
          if (e.dataTransfer.files.length > 0) {
            handleMRTUpload({ target: { files: e.dataTransfer.files } });
          }
        });
      }
    }

    function handleInitialInput(e) {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g,'').slice(0,1);
      const first = (document.getElementById('first-initial')?.value || '').trim();
      const last = (document.getElementById('last-initial')?.value || '').trim();
      const btn = document.getElementById('create-session-btn');
      if (btn) btn.disabled = !(first && last);
    }

    // ===============================================
    // SESSION MANAGEMENT
    // ===============================================
    function generateSessionCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
      return code;
    }

    function createNewSession() {
      const first = (document.getElementById('first-initial')?.value || '').trim().toUpperCase();
      const last = (document.getElementById('last-initial')?.value || '').trim().toUpperCase();
      const email = (document.getElementById('email')?.value || '').trim();

      if (!first || !last) {
        alert('Please enter your initials.');
        return;
      }

      state.sessionCode = generateSessionCode();
      state.participantID = `${first}${last}_${Date.now().toString().slice(-4)}`;
      state.email = email;
      state.sequenceIndex = Math.abs(hashCode(state.sessionCode)) % SEQUENCES.length;
      state.sequence = SEQUENCES[state.sequenceIndex].slice();
      state.startTime = Date.now();
      state.lastActivity = new Date().toISOString();

      saveState();
      sendToGoogleSheets({
        action: 'session_created',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        email: state.email,
        sequenceIndex: state.sequenceIndex,
        totalTasks: state.sequence.length,
        timestamp: new Date().toISOString()
      });

      const np = document.getElementById('new-participant');
      const cd = document.getElementById('code-display');
      if (np) np.style.display = 'none';
      if (cd) cd.style.display = 'block';
      const sc = document.getElementById('session-code');
      if (sc) sc.textContent = state.sessionCode;
    }

    async function resumeSession() {
      const code = (document.getElementById('resume-code')?.value || '').toUpperCase();
      if (code.length !== 8) { alert('Please enter your 8-character resume code.'); return; }
      try {
        const savedState = localStorage.getItem(`study_session_${code}`);
        if (savedState) {
          state = JSON.parse(savedState);
          proceedToStudy();
        } else {
          alert('Session not found locally. In production, this would check the server.');
        }
      } catch (err) {
        console.error(err);
        alert('Unable to load your saved session on this device.');
      }
    }

    function checkForSavedSession() {
      try {
        const recentCode = localStorage.getItem('recent_session_code');
        if (!recentCode) return;
        const savedState = localStorage.getItem(`study_session_${recentCode}`);
        if (!savedState) return;
        const saved = JSON.parse(savedState);
        const daysSinceActivity = (Date.now() - new Date(saved.lastActivity).getTime()) / (1000 * 60 * 60 * 24);
        if (daysSinceActivity < 30) {
          if (confirm(`Welcome back! You have an incomplete session (Code: ${recentCode}). Would you like to continue?`)) {
            state = saved; proceedToStudy();
          }
        }
      } catch (e) {
        console.warn('Saved session check failed', e);
      }
    }

    function saveState() {
      try {
        state.lastActivity = new Date().toISOString();
        const sessionKey = `study_session_${state.sessionCode}`;
        localStorage.setItem(sessionKey, JSON.stringify(state));
        localStorage.setItem('recent_session_code', state.sessionCode);
      } catch (e) {
        console.warn('Could not save progress', e);
        announce('Warning: progress could not be saved locally.');
      }
    }

    // ===============================================
    // NAVIGATION
    // ===============================================
    function showNewParticipant() {
      const w = document.getElementById('welcome-screen');
      const n = document.getElementById('new-participant');
      if (w) w.style.display = 'none';
      if (n) n.style.display = 'block';
    }
    function showReturningParticipant() {
      const w = document.getElementById('welcome-screen');
      const r = document.getElementById('returning-participant');
      if (w) w.style.display = 'none';
      if (r) r.style.display = 'block';
    }
    function backToWelcome() {
      const w = document.getElementById('welcome-screen');
      const n = document.getElementById('new-participant');
      const r = document.getElementById('returning-participant');
      if (w) w.style.display = 'block';
      if (n) n.style.display = 'none';
      if (r) r.style.display = 'none';
    }
    function startConsent() {
      const cd = document.getElementById('code-display');
      if (cd) cd.style.display = 'none';
      proceedToStudy();
    }

    function proceedToStudy() {
      ['welcome-screen','new-participant','returning-participant','code-display'].forEach(id => {
        const el = document.getElementById(id); if (el) el.style.display = 'none';
      });

      if (!state.consentCompleted.consent1) {
        showConsentStatus();
        return;
      }
      setNextTaskIndex();
      showProgressOverview();
    }

    function showConsentStatus() {
      const box = document.getElementById('consent-status');
      if (!box) return;
      box.style.display = 'block';
      const c1 = document.getElementById('consent-1');
      const c2 = document.getElementById('consent-2');

      if (c1) {
        c1.className = 'consent-item ' + (state.consentCompleted.consent1 ? 'complete' : 'pending');
        const s = c1.querySelector('.status'); if (s) s.textContent = state.consentCompleted.consent1 ? '‚úÖ' : '‚≠ï';
      }
      if (c2) {
        c2.className = 'consent-item ' + (state.videoConsentDeclined ? 'declined' : (state.consentCompleted.consent2 ? 'complete' : 'pending'));
        const s = c2.querySelector('.status'); if (s) s.textContent = state.videoConsentDeclined ? 'üö´' : (state.consentCompleted.consent2 ? '‚úÖ' : '‚≠ï');
        const p = c2.querySelector('p'); if (p) p.textContent = state.videoConsentDeclined ? 'Video consent declined' : 'Consent for video recording';
      }

      const choices = document.getElementById('consent-choices');
      if (choices) choices.style.display = (state.consentCompleted.consent1 && !state.consentCompleted.consent2 && !state.videoConsentDeclined) ? 'block' : 'none';

      const btn = document.getElementById('consent-btn');
      if (btn) {
        if (!state.consentCompleted.consent1) btn.textContent = 'Continue to Research Consent Form';
        else if (!state.consentCompleted.consent2 && !state.videoConsentDeclined) btn.textContent = 'Continue to Video Consent Form';
        else btn.textContent = 'Continue to Study Tasks';
      }
    }

    function proceedWithConsent() {
      if (!state.consentCompleted.consent1) startTask('CONSENT1');
      else if (!state.consentCompleted.consent2 && !state.videoConsentDeclined) startTask('CONSENT2');
      else showProgressOverview();
    }

    function declineVideoConsent() {
      state.videoConsentDeclined = true;
      state.consentCompleted.consent2 = true;
      saveState();
      sendToGoogleSheets({
        action: 'video_consent_declined',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        timestamp: new Date().toISOString()
      });
      showProgressOverview();
    }

    function showProgressOverview() {
      const cs = document.getElementById('consent-status');
      if (cs) cs.style.display = 'none';
      const si = document.getElementById('session-info');
      const po = document.getElementById('progress-overview');
      if (si) si.style.display = 'block';
      if (po) po.style.display = 'block';

      const iCode = document.getElementById('info-code');
      const iProg = document.getElementById('info-progress');
      const iTime = document.getElementById('info-time');
      const iLast = document.getElementById('info-last');
      if (iCode) iCode.textContent = state.sessionCode;
      if (iProg) iProg.textContent = `${state.completedTasks.length} of ${state.sequence.length} tasks`;
      if (iTime) iTime.textContent = `${Math.round(state.totalTimeSpent / 60000)} minutes`;
      if (iLast) iLast.textContent = new Date(state.lastActivity).toLocaleDateString();

      const taskList = document.getElementById('task-list');
      if (taskList) {
        taskList.innerHTML = '';
        state.sequence.forEach((taskCode, index) => {
          const task = TASKS[taskCode];
          const li = document.createElement('li');
          if (state.completedTasks.includes(taskCode)) {
            li.classList.add('completed');
            li.innerHTML = `<span>${task.name}</span><span class="task-status">‚úÖ</span>`;
          } else if (index === state.currentTaskIndex) {
            li.classList.add('current');
            li.innerHTML = `<span>${task.name} (Current)</span><span class="task-status">‚ñ∂Ô∏è</span>`;
          } else {
            li.classList.add('locked');
            li.innerHTML = `<span>${task.name}</span><span class="task-status">‚≠ï</span>`;
          }
          taskList.appendChild(li);
        });
      }

      const cont = document.getElementById('continue-btn');
      if (cont) {
        if (state.currentTaskIndex >= state.sequence.length) {
          cont.textContent = 'Study Complete!';
          cont.disabled = true;
        } else {
          cont.disabled = false;
          cont.textContent = 'Continue to Current Task';
        }
      }
      announce('Progress overview loaded');
    }

    function continueToCurrentTask() {
      if (state.currentTaskIndex < state.sequence.length) {
        const taskCode = state.sequence[state.currentTaskIndex];
        startTask(taskCode);
      }
    }

    // ===============================================
    // TASK MANAGEMENT
    // ===============================================
    function startTask(taskCode) {
      const task = TASKS[taskCode];
      if (!task) return;

      ['consent-status','progress-overview','session-info'].forEach(id => {
        const el = document.getElementById(id); if (el) el.style.display = 'none';
      });
      const pauseBtn = document.getElementById('pause-button');
      if (pauseBtn) pauseBtn.style.display = 'block';

      const taskStartTime = Date.now();
      state.taskData[taskCode] = { startTime: new Date().toISOString(), startTimestamp: taskStartTime };
      displayTask(taskCode, task);

      sendToGoogleSheets({
        action: 'task_started',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        task: task.name,
        timestamp: new Date().toISOString()
      });
      announce(`Task "${task.name}" opened`);
    }

    function displayTask(taskCode, task) {
  const taskDisplay = document.getElementById('task-display');
  const taskTitle = document.getElementById('task-title');
  const taskInstructions = document.getElementById('task-instructions');
  const taskContent = document.getElementById('task-content');

  const mrtUp = document.getElementById('mrt-upload');
  const recSec = document.getElementById('recording-section');
  const genCont = document.getElementById('general-continue');

  if (mrtUp) mrtUp.style.display = 'none';
  if (recSec) recSec.style.display = 'none';
  if (genCont) genCont.style.display = 'none';

  if (taskDisplay) taskDisplay.style.display = 'block';
  if (taskTitle) { taskTitle.textContent = task.name; taskTitle.focus(); }
  if (taskInstructions) taskInstructions.innerHTML = task.instructions || '';
  if (taskContent) taskContent.innerHTML = '';

  // helper to add a button
  const addBtn = (text, className, onClick) => {
    const b = document.createElement('button');
    b.type = 'button';
    b.className = className || 'button';
    b.textContent = text;
    b.addEventListener('click', onClick);
    taskContent.appendChild(b);
    return b;
  };

  // helper: small note under buttons
  const addNote = (html) => {
    const p = document.createElement('p');
    p.style.marginTop = '15px';
    p.style.color = '#666';
    p.innerHTML = html;
    taskContent.appendChild(p);
  };

  if (task.type === 'external' || task.type === 'consent') {
    // Open task / consent (no inline onclick)
    addBtn(
      taskCode === 'ZOOM'
        ? 'Schedule Zoom Task (15-20 min)'
        : (task.type === 'consent' ? 'Open Consent Form' : 'Open Task'),
      'task-button',
      () => openExternalTask(taskCode)
    );

    // Optional ASLCT skip button
    if (taskCode === 'ASLCT') {
      const skip = addBtn('Skip This Task - I Do Not Know ASL', 'button button-secondary', skipASLCT);
      skip.style.marginTop = '20px';
      skip.style.display = 'block';
      skip.style.marginLeft = 'auto';
      skip.style.marginRight = 'auto';
    }

    // Video consent decline option
    if (taskCode === 'CONSENT2' && !state.videoConsentDeclined && !state.consentCompleted.consent2) {
      const wrap = document.createElement('div');
      wrap.style.marginTop = '10px';
      wrap.style.textAlign = 'center';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'button button-secondary';
      btn.textContent = 'I do not consent to video, continue';
      btn.addEventListener('click', declineVideoConsent);
      wrap.appendChild(btn);
      taskContent.appendChild(wrap);
    }

    // Info note
    addNote(
      taskCode === 'ZOOM'
        ? 'Calendly will open in a new tab. Schedule the Zoom task, then return here.'
        : 'The task will open in a new tab. Return here when complete.'
    );

    // Upload or continue
    if (task.requiresUpload) {
      setTimeout(() => {
        const up = document.getElementById('mrt-upload');
        if (up) up.style.display = 'block';
        const existingButton = document.getElementById('mrt-continue');
        if (existingButton) { existingButton.textContent = 'Continue to Next Task'; existingButton.style.display = 'block'; }
        const uploadStatus = document.getElementById('upload-status');
        if (uploadStatus && !uploadStatus.classList.contains('success')) {
          uploadStatus.innerHTML = `
            <div style="background:#e3f2fd; padding:10px; border-radius:5px;">
              üìå <strong>Optional:</strong> You can upload your CSV file now or email it later.
              <br>Click "Continue to Next Task" when ready.
            </div>
          `;
          uploadStatus.style.display = 'block';
        }
      }, 300);
    } else {
      const continueBtn = document.getElementById('general-continue');
      if (continueBtn) {
        continueBtn.textContent = taskCode === 'ZOOM'
          ? 'I have scheduled my meeting, continue'
          : 'I have completed this task, continue';
        continueBtn.style.display = 'block';
      }
    }
  } else if (task.type === 'recording') {
    showRecordingTask();
  }

  if (task.canSkip && taskContent) {
    const skipWrap = document.createElement('div');
    skipWrap.style.textAlign = 'center';
    skipWrap.style.marginTop = '10px';
    const skipBtn = document.createElement('button');
    skipBtn.type = 'button';
    skipBtn.className = 'button button-secondary';
    skipBtn.textContent = 'Skip this task';
    skipBtn.addEventListener('click', () => skipTask(taskCode));
    skipWrap.appendChild(skipBtn);
    taskContent.appendChild(skipWrap);
  }
}


    function setNextTaskIndex() {
      const uncompleted = state.sequence.filter(code => !state.completedTasks.includes(code));
      const nonZoom = uncompleted.find(code => code !== 'ZOOM');
      state.currentTaskIndex = nonZoom
        ? state.sequence.indexOf(nonZoom)
        : (uncompleted[0] ? state.sequence.indexOf(uncompleted[0]) : state.sequence.length);
    }

    function skipASLCT() {
      if (!confirm("Skip ASL Comprehension Test?")) return;
      state.taskData.ASLCT = { skipped: true, reason: "Does not know ASL", timestamp: new Date().toISOString() };
      sendToGoogleSheets({
        action: 'task_skipped',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        task: 'ASL Comprehension Test',
        reason: 'Does not know ASL',
        timestamp: new Date().toISOString()
      });
      completeCurrentTask();
    }

    function skipTask(taskCode) {
      const task = TASKS[taskCode];
      const reason = taskCode === 'ID'
        ? (state.videoConsentDeclined ? 'Video consent declined' : 'Participant chose not to record')
        : 'Participant chose to skip';
      if (!confirm(`Skip "${task.name}"?`)) return;

      state.taskData[taskCode] = state.taskData[taskCode] || {};
      state.taskData[taskCode].skipped = true;
      state.taskData[taskCode].reason = reason;
      state.taskData[taskCode].timestamp = new Date().toISOString();

      sendToGoogleSheets({
        action: 'task_skipped',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        task: task.name,
        reason,
        timestamp: new Date().toISOString()
      });
      completeCurrentTask();
    }

    // Expose for inline handlers and external environments
    window.showNewParticipant = showNewParticipant;
    window.showReturningParticipant = showReturningParticipant;
    window.backToWelcome = backToWelcome;
    window.createNewSession = createNewSession;
    window.resumeSession = resumeSession;
    window.startConsent = startConsent;
    window.proceedWithConsent = proceedWithConsent;
    window.continueToCurrentTask = continueToCurrentTask;
    window.pauseAndSave = pauseAndSave;
    window.skipASLCT = skipASLCT;
    window.openExternalTask = openExternalTask;
    window.completeCurrentTask = completeCurrentTask;
    window.declineVideoConsent = declineVideoConsent;
    window.skipTask = skipTask;

    // New: Local EEG contact helper (prefills email with session code)
    function contactEEGLocal() {
      // Encourage creating a session so we can include their code
      if (!state.sessionCode) {
        const go = confirm('We can include your session code in the email. Create your session now?');
        if (go && typeof showNewParticipant === 'function') {
          showNewParticipant();
          return;
        }
      }
      const code = state.sessionCode || 'TBD';
      const emailInput = document.getElementById('email');
      const participantEmail = emailInput && emailInput.value ? `Participant email: ${emailInput.value}\n` : '';
      const subject = `Local EEG add-on interest - Session ${code}`;
      const body = [
        'Hello Action Brain Lab,',
        '',
        'I live in DC/MD/VA and would like to add the EEG visit for additional compensation.',
        '',
        `Session code: ${code}`,
        participantEmail ? participantEmail.trim() : '',
        'Preferred days or times:',
        'Accessibility or communication preferences: ASL, spoken English, captions',
        '',
        'Thank you.'
      ].join('\n');

      // Log click (optional analytics)
      try {
        sendToGoogleSheets({
          action: 'eeg_interest_clicked',
          sessionCode: state.sessionCode || 'none',
          participantID: state.participantID || 'none',
          timestamp: new Date().toISOString()
        });
      } catch (_) {}

      const mailto = `mailto:action.brain.lab@gallaudet.edu?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;
    }
    window.contactEEGLocal = contactEEGLocal;

    function openExternalTask(taskCode) {
      const task = TASKS[taskCode];
      if (!task) return;
      const win = window.open(task.url, '_blank', 'noopener,noreferrer');
      if (win) win.opener = null;
      if (taskCode === 'ZOOM') {
        sendToGoogleSheets({ action: 'calendly_opened', sessionCode: state.sessionCode, participantID: state.participantID, timestamp: new Date().toISOString() });
      }
    }

    function showRecordingTask() {
      const section = document.getElementById('recording-section');
      const bannerNoConsent = document.getElementById('video-consent-banner');
      const bannerDeclined = document.getElementById('video-declined-banner');
      const videoContainer = document.getElementById('video-container');
      const counter = document.getElementById('image-counter');
      if (!section) return;
      section.style.display = 'block';

      if (videoContainer) videoContainer.style.display = 'none';
      if (counter) counter.style.display = 'none';
      if (bannerNoConsent) bannerNoConsent.style.display = 'none';
      if (bannerDeclined) bannerDeclined.style.display = 'none';

      if (state.videoConsentDeclined) {
        if (bannerDeclined) bannerDeclined.style.display = 'block';
        return;
      }
      if (!state.consentCompleted.consent2) {
        if (bannerNoConsent) bannerNoConsent.style.display = 'block';
        return;
      }

      if (videoContainer) videoContainer.style.display = 'grid';
      if (counter) counter.style.display = 'inline-block';

      state.currentImageIndex = 0;
      state.imageRecordings = [];
      updateCurrentImage();

      const rb = document.getElementById('record-button');
      const rr = document.getElementById('re-record-button');
      const sv = document.getElementById('save-video-button');
      if (rb) rb.onclick = toggleRecording;
      if (rr) rr.onclick = reRecord;
      if (sv) sv.onclick = saveAndContinue;
    }

    function updateCurrentImage() {
      const imageUrl = state.currentImageIndex === 0 ? CONFIG.IMAGE_1_URL : CONFIG.IMAGE_2_URL;
      const img = document.getElementById('current-image');
      const counter = document.getElementById('image-counter');
      const vp = document.getElementById('video-preview');
      const rv = document.getElementById('recorded-video');
      const rb = document.getElementById('record-button');
      const rrb = document.getElementById('re-record-button');
      const sb = document.getElementById('save-video-button');
      const rs = document.getElementById('recording-status');
      const rt = document.getElementById('recording-timer');

      if (img) img.src = imageUrl;
      if (counter) counter.textContent = `Image ${state.currentImageIndex + 1} of 2`;

      if (vp) vp.style.display = 'none';
      if (rv) rv.style.display = 'none';
      if (rb) { rb.style.display = 'block'; rb.textContent = 'Start Recording'; rb.classList.remove('recording'); }
      if (rrb) rrb.style.display = 'none';
      if (sb) sb.style.display = 'none';
      if (rs) { rs.textContent = 'Ready to record'; rs.className = 'recording-status ready'; }
      if (rt) rt.style.display = 'none';
    }

    async function toggleRecording() {
      const button = document.getElementById('record-button');
      const status = document.getElementById('recording-status');
      const timer = document.getElementById('recording-timer');
      const videoPreview = document.getElementById('video-preview');

      if (!state.recording) {
        try {
          const stream = state.currentStream || await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' }, audio: true
          });
          state.currentStream = stream;
          if (videoPreview) {
            videoPreview.srcObject = stream;
            videoPreview.style.display = 'block';
          }

          state.mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
          state.videoChunks = [];
          state.mediaRecorder.ondataavailable = e => { if (e.data.size > 0) state.videoChunks.push(e.data); };
          state.mediaRecorder.onstop = () => {
            const blob = new Blob(state.videoChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const recordedVideo = document.getElementById('recorded-video');
            if (recordedVideo) {
              recordedVideo.src = url;
              recordedVideo.style.display = 'block';
            }
            if (videoPreview) videoPreview.style.display = 'none';
            if (button) button.style.display = 'none';
            const rrb = document.getElementById('re-record-button'); if (rrb) rrb.style.display = 'block';
            const sb = document.getElementById('save-video-button'); if (sb) sb.style.display = 'block';
            if (status) { status.textContent = '‚úÖ Recording complete! Review your video below.'; status.className = 'recording-status recorded'; }
            state.currentRecording = blob;
            state.currentRecordingURL = url;
          };

          state.mediaRecorder.start();
          state.recording = true;
          state.recordingStartTime = Date.now();
          if (button) { button.textContent = 'Stop Recording'; button.classList.add('recording'); }
          if (status) { status.textContent = 'üî¥ Recording in progress...'; status.className = 'recording-status recording'; }
          if (timer) { timer.style.display = 'block'; }
          state.recordingTimer = setInterval(updateRecordingTimer, 1000);
        } catch (err) {
          alert('Could not start recording. Please ensure you have granted camera and microphone permissions.');
          console.error('Recording error:', err);
        }
      } else {
        state.mediaRecorder.stop();
        state.recording = false;
        if (button) { button.textContent = 'Start Recording'; button.classList.remove('recording'); }
        clearInterval(state.recordingTimer);
        if (timer) timer.style.display = 'none';
      }
    }

    function updateRecordingTimer() {
      const elapsed = Math.floor((Date.now() - state.recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      const el = document.getElementById('recording-timer');
      if (el) el.textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function reRecord() {
      const vp = document.getElementById('video-preview');
      const rv = document.getElementById('recorded-video');
      const rb = document.getElementById('record-button');
      const rrb = document.getElementById('re-record-button');
      const sb = document.getElementById('save-video-button');
      const rs = document.getElementById('recording-status');
      if (vp) vp.style.display = 'block';
      if (rv) rv.style.display = 'none';
      if (rb) { rb.style.display = 'block'; rb.textContent = 'Start Recording'; rb.classList.remove('recording'); }
      if (rrb) rrb.style.display = 'none';
      if (sb) sb.style.display = 'none';
      if (rs) { rs.textContent = 'Ready to record'; rs.className = 'recording-status ready'; }
      if (state.currentRecordingURL) URL.revokeObjectURL(state.currentRecordingURL);
    }

    function saveAndContinue() {
      state.imageRecordings.push({
        imageNumber: state.currentImageIndex + 1,
        blob: state.currentRecording,
        url: state.currentRecordingURL,
        timestamp: new Date().toISOString()
      });
      sendToGoogleSheets({
        action: 'video_recorded',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        imageNumber: state.currentImageIndex + 1,
        timestamp: new Date().toISOString()
      });
      if (state.currentImageIndex === 0) {
        state.currentImageIndex = 1;
        updateCurrentImage();
        const sb = document.getElementById('save-video-button');
        if (sb) sb.textContent = 'Save & Complete Task';
      } else {
        cleanupVideoRecording();
        completeCurrentTask();
      }
    }

    function cleanupVideoRecording() {
      if (state.currentStream) {
        state.currentStream.getTracks().forEach(track => track.stop());
        state.currentStream = null;
      }
      if (state.recordingTimer) { clearInterval(state.recordingTimer); state.recordingTimer = null; }
      state.taskData.ID = state.taskData.ID || {};
      state.taskData.ID.recordings = state.imageRecordings;
      state.taskData.ID.recordingComplete = true;
    }

    function handleMRTUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const looksCSV = (file.type && file.type === 'text/csv') || file.name.toLowerCase().endsWith('.csv');
      if (!looksCSV) { alert('Please upload a CSV file.'); return; }

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result || '';
        const firstLine = (text.split('\n')[0] || '').toLowerCase();
        if (!firstLine.includes('rt') && !firstLine.includes('reaction')) {
          if (!confirm('This file may not be the MRT results. Continue anyway?')) return;
        }
        state.taskData.MRT = state.taskData.MRT || {};
        state.taskData.MRT.fileContent = text;
        state.taskData.MRT.fileName = file.name;

        const uploadStatus = document.getElementById('upload-status');
        if (uploadStatus) {
          uploadStatus.className = 'upload-status success';
          uploadStatus.innerHTML = `‚úÖ File uploaded successfully!<br><small>File: ${file.name}</small>`;
        }
        const continueBtn = document.getElementById('mrt-continue');
        if (continueBtn) continueBtn.textContent = 'Continue to Next Task ‚úì';
        sendToGoogleSheets({
          action: 'mrt_uploaded',
          sessionCode: state.sessionCode,
          participantID: state.participantID,
          fileName: file.name,
          timestamp: new Date().toISOString()
        });
      };
      reader.readAsText(file);
    }

    function completeCurrentTask() {
      const taskCode = state.sequence[state.currentTaskIndex];
      const task = TASKS[taskCode];
      const td = state.taskData[taskCode] || {};
      const startStamp = td.startTimestamp || Date.now();
      const timeSpent = Math.max(0, Date.now() - startStamp);

      td.endTime = new Date().toISOString();
      td.duration = timeSpent;
      state.taskData[taskCode] = td;

      state.totalTimeSpent += timeSpent;
      if (!state.completedTasks.includes(taskCode)) state.completedTasks.push(taskCode);
      if (taskCode === 'CONSENT1') state.consentCompleted.consent1 = true;
      else if (taskCode === 'CONSENT2' && !state.videoConsentDeclined) state.consentCompleted.consent2 = true;

      saveState();
      sendToGoogleSheets({
        action: 'task_completed',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        task: task.name,
        duration: Math.round(timeSpent / 1000),
        timestamp: new Date().toISOString()
      });

      state.currentTaskIndex++;
      ['task-display','mrt-upload','recording-section','general-continue','pause-button'].forEach(id => {
        const el = document.getElementById(id); if (el) el.style.display = 'none';
      });

      if (taskCode === 'ZOOM') {
        showConsentStatus();
      } else if (taskCode === 'CONSENT1' && !state.consentCompleted.consent2 && !state.videoConsentDeclined) {
        showConsentStatus();
      } else {
        setNextTaskIndex();
        if (state.currentTaskIndex >= state.sequence.length) completeStudy();
        else showProgressOverview();
      }
    }

    function completeStudy() {
      sendToGoogleSheets({
        action: 'study_completed',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        totalDuration: Math.round(state.totalTimeSpent / 60000),
        timestamp: new Date().toISOString()
      });
      const content = document.querySelector('.content');
      if (content) {
        content.innerHTML = `
          <div class="completion-screen">
            <h2>üéâ Study Complete!</h2>
            <p style="font-size: 20px; margin: 20px 0;">Thank you for participating in our research!</p>
            <p>Your session code was: <strong>${state.sessionCode}</strong></p>
            <p>Total time: ${Math.round(state.totalTimeSpent / 60000)} minutes</p>
            <p style="margin-top: 30px; color: #666;">You may now close this window.</p>
          </div>
        `;
      }
      announce('Study complete');
    }

    function pauseAndSave() {
      saveState();
      const mc = document.getElementById('modal-code');
      if (mc) mc.textContent = state.sessionCode;
      const pm = document.getElementById('pause-modal');
      if (pm) pm.style.display = 'block';
      const btn = document.querySelector('#pause-modal .button');
      if (btn) btn.focus();

      sendToGoogleSheets({
        action: 'session_paused',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        progress: `${state.completedTasks.length}/${state.sequence.length}`,
        timestamp: new Date().toISOString()
      });
      announce('Session saved');
    }

    // ===============================================
    // UTILITIES
    // ===============================================
    function hashCode(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash = hash & hash; }
      return hash;
    }

    async function sendToGoogleSheets(data) {
      if (!CONFIG.GOOGLE_SHEETS_URL || CONFIG.GOOGLE_SHEETS_URL === 'YOUR_GOOGLE_SHEETS_WEB_APP_URL_HERE') {
        console.log('Google Sheets not configured:', data); return;
      }
      try {
        await fetch(CONFIG.GOOGLE_SHEETS_URL, {
          method: 'POST', mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
      } catch (error) {
        console.error('Error sending to Google Sheets:', error);
      }
    }

    function copyCode(selector, btnEl) {
      const el = document.querySelector(selector);
      if (!el) return;
      const text = el.textContent.trim();
      const done = () => {
        if (btnEl) {
          const orig = btnEl.textContent;
          btnEl.textContent = 'Copied ‚úì';
          setTimeout(() => btnEl.textContent = orig, 1200);
        }
      };
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(done, done);
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        done();
      }
    }
    window.copyCode = copyCode;
  </script>
</body>
</html>

