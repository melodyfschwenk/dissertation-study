<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spatial Cognition & Sign Language Research Study</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
      --gray-light: #f8f9fa;
      --gray-border: #e0e0e0;
      --text-dark: #333;
      --text-muted: #666;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--primary-gradient);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header { background: var(--primary-gradient); color: white; padding: 40px; text-align: center; }
    .header h1 { font-size: 32px; margin-bottom: 10px; }
    .header p { font-size: 18px; opacity: 0.95; }

    .content { padding: 40px; }

    /* Screens */
    .screen { display: none; animation: fadeIn 0.3s ease-in; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Cards / banners */
    .card { background: var(--gray-light); border-radius: 10px; padding: 30px; margin: 20px 0; border: 2px solid var(--gray-border); transition: all 0.3s; }
    .card:hover { border-color: #667eea; box-shadow: 0 5px 15px rgba(102,126,234,0.2); }

    .info-banner { padding: 15px 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid; }
    .info-banner.success { background: #e8f5e9; border-left-color: var(--success); color: #1b5e20; }
    .info-banner.warning { background: #fff3cd; border-left-color: var(--warning); color: #856404; }
    .info-banner.info { background: #e3f2fd; border-left-color: var(--info); color: #0d47a1; }

    /* Forms */
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; }
    .form-group input { width: 100%; padding: 12px; border: 2px solid var(--gray-border); border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
    .form-group input:focus { outline: none; border-color: #667eea; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    /* Buttons */
    .button { background: var(--primary-gradient); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102,126,234,0.4); margin: 5px; display: inline-block; }
    .button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 7px 20px rgba(102,126,234,0.5); }
    .button:disabled { opacity: 0.5; cursor: not-allowed; }
    .button.secondary { background: #6c757d; }
    .button.success { background: var(--success); }
    .button.danger { background: var(--danger); }
    .button.outline { background: white; color: #667eea; border: 2px solid #667eea; }
    .button.outline:hover { background: #667eea; color: white; }
    .button-group { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; justify-content: center; }

    /* Session widget */
    .session-widget { background: linear-gradient(135deg, #667eea20, #764ba220); border-radius: 10px; padding: 20px; margin-bottom: 30px; display: none; }
    .session-widget.active { display: block; }
    .session-widget h3 { color: #667eea; margin-bottom: 15px; font-size: 18px; }
    .session-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .session-detail { background: white; padding: 10px 15px; border-radius: 8px; border-left: 3px solid #667eea; }
    .session-detail label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .session-detail .value { font-size: 16px; font-weight: bold; color: #333; margin-top: 3px; }

    /* Code display */
    .code-display { background: var(--primary-gradient); color: white; padding: 30px; border-radius: 10px; text-align: center; margin: 20px 0; }
    .code-display .code { font-size: 36px; font-weight: bold; letter-spacing: 3px; margin: 15px 0; font-family: monospace; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }

    /* Consent grid */
    .consent-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    .consent-card { background: white; border: 2px solid var(--gray-border); border-radius: 10px; padding: 20px; text-align: center; transition: all 0.3s; position: relative; }
    .consent-card.completed { border-color: var(--success); background: #f1f8f4; }
    .consent-card.declined { border-color: var(--warning); background: #fff9e6; }
    .consent-card .status-icon { font-size: 48px; margin-bottom: 15px; }
    .consent-card h4 { color: var(--text-dark); margin-bottom: 10px; }
    .consent-card p { color: var(--text-muted); font-size: 14px; margin-bottom: 15px; }

    /* Tasks list */
    .task-list { list-style: none; margin: 20px 0; }
    .task-item { padding: 20px; margin: 10px 0; background: white; border-radius: 10px; border-left: 4px solid var(--gray-border); display: flex; align-items: center; justify-content: space-between; transition: all 0.3s; }
    .task-item:hover { box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    .task-item.completed { border-left-color: var(--success); background: #f9fdf9; }
    .task-item.current { border-left-color: var(--warning); background: #fffbf5; font-weight: bold; box-shadow: 0 3px 10px rgba(255,152,0,0.2); }
    .task-item.locked { opacity: 0.6; }
    .task-info { flex: 1; }
    .task-name { font-size: 16px; color: var(--text-dark); margin-bottom: 5px; }
    .task-description { font-size: 13px; color: var(--text-muted); }
    .task-status { font-size: 24px; margin-left: 20px; }

    /* Progress bar */
    .progress-bar { background: var(--gray-light); height: 30px; border-radius: 15px; overflow: hidden; margin: 20px 0; position: relative; }
    .progress-fill { background: var(--primary-gradient); height: 100%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; }

    /* Video section */
    .video-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0; }
    .video-panel { text-align: center; }
    .video-panel h3 { color: var(--text-dark); margin-bottom: 15px; }
    #video-preview, #recorded-video { width: 100%; max-width: 500px; height: 375px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); background: #000; }
    #video-preview { border: 2px solid var(--success); transform: scaleX(-1); }
    #recorded-video { border: 2px solid var(--info); }
    .recording-controls { margin-top: 20px; padding: 20px; background: var(--gray-light); border-radius: 10px; }
    .recording-status { margin: 15px 0; font-size: 18px; font-weight: bold; }
    .recording-status.ready { color: var(--text-muted); }
    .recording-status.recording { color: var(--danger); animation: pulse 1.5s infinite; }
    .recording-status.recorded { color: var(--success); }
    @keyframes pulse { 0%,100% {opacity:1} 50% {opacity:.5} }

    /* Upload progress indicator */
    #upload-progress { margin: 15px 0; padding: 15px; background: #f0f0f0; border-radius: 8px; display: none; }
    .upload-progress-bar { background: #ddd; height: 8px; border-radius: 4px; overflow: hidden; margin: 10px 0; }
    #upload-progress-fill { background: #667eea; height: 100%; width: 0%; transition: width 0.3s; }

    /* Modals */
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background-color: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 500px; text-align: center; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Footer */
    .footer { background: var(--gray-light); padding: 30px; text-align: center; color: var(--text-muted); }

    /* FAB */
    .fab { position: fixed; bottom: 30px; right: 30px; z-index: 1000; background: var(--warning); color: white; border: none; padding: 15px 25px; border-radius: 50px; font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: none; transition: all 0.3s; }
    .fab.active { display: block; }
    .fab:hover { transform: scale(1.05); }

    /* Embed shells */
    .embed-shell { background: #0b0b0b; border: 2px solid var(--gray-border); border-radius: 12px; overflow: hidden; margin-top: 16px; }
    .fs-toolbar { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; background:#111827; color:#e5e7eb; font-size:14px; }
    .fs-toolbar .actions { display:flex; gap:8px; }
    .embed-frame { width: 100%; height: 75vh; border: none; display: block; background: #000; }
    .embed-note { color: #6b7280; font-size: 12px; padding: 8px 12px; background: #0f172a; }
    .fs-shell:fullscreen .embed-frame { height: calc(100vh - 52px); }
    .fs-shell:-webkit-full-screen .embed-frame { height: calc(100vh - 52px); }

    /* Distraction-free fallback */
    html.df-mode, html.df-mode body { height:100%; }
    html.df-mode body { overflow:hidden; position:fixed; left:0; right:0; }
    html.df-mode .container { width:100vw; height:100vh; border-radius:0; box-shadow:none; }
    html.df-mode .header, html.df-mode .footer, html.df-mode #task-instructions { display:none !important; }
    html.df-mode .embed-frame { height: calc(100vh - 52px); }

    /* Responsive */
    @media (max-width: 768px) {
      .container { border-radius: 0; margin: 0; }
      .form-row, .consent-grid, .video-container { grid-template-columns: 1fr; }
      .session-details { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
      .button { width: 100%; }
      .embed-frame { height: 70vh; }
    }

    /* Accessibility */
    .sr-only { position: absolute; left: -9999px; }
    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Spatial Cognition & Sign Language Research Study</h1>
      <p>Gallaudet University Research Project</p>
    </div>

    <div class="content">
      <div id="live-status" role="status" aria-live="polite" class="sr-only"></div>

      <!-- Session Widget -->
      <div class="session-widget" id="session-widget">
        <h3>📊 Your Session</h3>
        <div class="session-details">
          <div class="session-detail">
            <label>Resume Code</label>
            <div class="value" id="widget-code">-</div>
          </div>
          <div class="session-detail">
            <label>Progress</label>
            <div class="value" id="widget-progress">0/7</div>
          </div>
          <div class="session-detail">
            <label>Time Spent</label>
            <div class="value" id="widget-time">0 min</div>
          </div>
          <div class="session-detail">
            <label>Current Task</label>
            <div class="value" id="widget-current">-</div>
          </div>
        </div>
      </div>

      <!-- Welcome -->
      <div class="screen active" id="welcome-screen">
        <h2 style="text-align: center; margin-bottom: 30px;">Welcome to Our Research Study</h2>

        <div class="info-banner info">
          <strong>📅 Important: Zoom Task Required</strong>
          <p style="margin-top: 10px;">One task (15–20 minutes) must be completed live on Zoom. You can start other tasks now and schedule the Zoom meeting at your convenience. We support ASL or spoken English with captions.</p>
        </div>

        <div class="info-banner info" id="eeg-banner">
          <strong>EEG temporarily unavailable</strong>
          <p style="margin-top: 10px;">
            You can complete the full study online now for $25 per hour. If you are local and want the optional in-person EEG visit later
            (about 30–45 minutes), choose Online now + in-person later in the screener and we will contact you when sessions resume.
          </p>
          <ul style="margin: 10px 0 0 20px; text-align: left;">
            <li>Same hourly rate for all modes, $25 minimum even if under 1 hour</li>
            <li>We will email to schedule the EEG visit when equipment is ready</li>
            <li>ASL or spoken English with captions available</li>
          </ul>
        </div>

        <div class="info-banner warning" id="device-warning">
          <strong>Device tip</strong>
          <p style="margin-top: 10px;">
            A computer is preferred for the best experience. A tablet or iPhone is ok if that's what you have today.
            You can pause anytime and return later on a computer using your resume code.
          </p>
          <ul style="margin: 10px 0 0 20px; text-align: left;">
            <li>Keyboard and mouse work best for some tasks</li>
            <li>Chrome or Firefox recommended</li>
            <li>Progress saves after each task</li>
          </ul>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
          <div class="card">
            <h3>🆕 New Participant</h3>
            <p>Start a new study session and receive your unique resume code.</p>
            <button class="button" onclick="showScreen('new-participant')">Start New Session</button>
          </div>
          <div class="card">
            <h3>↩️ Returning Participant</h3>
            <p>Continue from where you left off using your resume code.</p>
            <button class="button secondary" onclick="showScreen('returning-participant')">Resume Session</button>
          </div>
        </div>
      </div>

      <!-- New Participant -->
      <div class="screen" id="new-participant">
        <h2>New Participant Registration</h2>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Create your unique session to track your progress</p>

        <div class="form-row">
          <div class="form-group">
            <label for="first-initial">First Name Initial</label>
            <input type="text" id="first-initial" maxlength="1" placeholder="J" />
          </div>
          <div class="form-group">
            <label for="last-initial">Last Name Initial</label>
            <input type="text" id="last-initial" maxlength="1" placeholder="D" />
          </div>
        </div>

        <div class="form-group">
          <label for="email">Email (optional - for reminders if you pause)</label>
          <input type="email" id="email" placeholder="your.email@example.com" />
        </div>

        <div class="button-group">
          <button class="button" id="create-session-btn" onclick="createNewSession()" disabled>Create Session</button>
          <button class="button secondary" onclick="showScreen('welcome-screen')">Back</button>
        </div>
      </div>

      <!-- Returning Participant -->
      <div class="screen" id="returning-participant">
        <h2>Resume Your Session</h2>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Enter your 8-character code to continue</p>

        <div class="form-group">
          <label for="resume-code">Resume Code</label>
          <input type="text" id="resume-code" maxlength="8" placeholder="ABC12345" style="text-transform: uppercase; font-family: monospace; font-size: 24px; letter-spacing: 2px; text-align: center;" />
        </div>

        <div class="button-group">
          <button class="button" onclick="resumeSession()">Resume Session</button>
          <button class="button secondary" onclick="showScreen('welcome-screen')">Back</button>
        </div>
      </div>

      <!-- Session Created -->
      <div class="screen" id="session-created">
        <h2>✅ Session Created Successfully!</h2>
        <div class="code-display">
          <p>Your Resume Code:</p>
          <div class="code" id="display-code">ABC12345</div>
          <button class="button outline" onclick="copyCode(this)">📋 Copy Code</button>
          <p style="font-size: 14px; margin-top: 15px;">Save this code to resume anytime</p>
        </div>

        <div class="info-banner warning">
          <strong>⚠️ Important: Save Your Code!</strong>
          <ul style="margin: 10px 0 0 20px; text-align: left;">
            <li>Write down or screenshot your code</li>
            <li>Use this code to continue from any device</li>
            <li>Progress saves automatically after each task</li>
          </ul>
        </div>

        <button class="button success" onclick="proceedToConsent()" style="display: block; margin: 20px auto;">
          I've Saved My Code - Continue
        </button>
      </div>

      <!-- Consent Screen -->
      <div class="screen" id="consent-screen">
        <h2>📋 Consent Forms</h2>
        <p style="color: var(--text-muted); margin-bottom: 20px;">Please complete both consent forms to participate. If you've already completed these through the screener, mark them as done.</p>

        <div class="consent-grid">
          <div class="consent-card" id="consent1-card">
            <div class="status-icon">📄</div>
            <h4>Research Consent</h4>
            <p>General study participation consent (required)</p>
            <button class="button" onclick="openConsent('CONSENT1')">Open Form</button>
            <button class="button outline" onclick="markConsentDone('consent1')" style="margin-top: 10px;">Mark as Done</button>
          </div>

          <div class="consent-card" id="consent2-card">
            <div class="status-icon">🎥</div>
            <h4>Video Consent</h4>
            <p>For video recording task (optional)</p>
            <button class="button" onclick="openConsent('CONSENT2')">Open Form</button>
            <div class="button-group" style="margin-top: 10px;">
              <button class="button outline" onclick="markConsentDone('consent2')">Mark as Done</button>
              <button class="button secondary" onclick="declineVideo()">Decline Video</button>
            </div>
          </div>
        </div>

        <div class="info-banner info">
          <strong>Already completed these forms?</strong>
          <p style="margin-top: 5px;">If you completed the consent forms through the screener, click "Mark as Done" on each form above.</p>
        </div>

        <button class="button success" id="continue-from-consent" onclick="proceedToTasks()" disabled style="display: block; margin: 20px auto;">
          Continue to Study Tasks
        </button>
      </div>

      <!-- Progress -->
      <div class="screen" id="progress-screen">
        <h2>Your Study Progress</h2>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"><span id="progress-text">0%</span></div>
        </div>
        <ul class="task-list" id="task-list"></ul>
        <div class="button-group">
          <button class="button" id="continue-task-btn" onclick="continueToCurrentTask()">Continue to Current Task</button>
          <button class="button secondary" onclick="pauseSession()">Save & Exit</button>
        </div>
      </div>

      <!-- Task Host -->
      <div class="screen" id="task-screen">
        <h2 id="task-title">Task Title</h2>
        <div id="task-instructions" style="margin: 20px 0;"></div>
        <div id="task-content"></div>
      </div>

      <!-- Recording -->
      <div class="screen" id="recording-screen">
        <h2>Image Description Task</h2>

        <div class="info-banner info" id="recording-consent-check" style="display: none;">
          <strong>Video consent required</strong>
          <p>Please complete the video consent form to proceed with this task.</p>
          <div class="button-group" style="margin-top: 10px;">
            <button class="button" onclick="openConsent('CONSENT2')">Open Video Consent</button>
            <button class="button secondary" id="skip-recording-consent-btn">Skip Task</button>
          </div>
        </div>

        <div id="recording-content" style="display: none;">
          <div class="info-banner warning">
            <strong>Language for descriptions:</strong>
            <p>If you know ASL, please use ASL. Otherwise, spoken English is fine.</p>
          </div>

          <div style="text-align: center; margin: 20px 0;">
            <span style="background: var(--info); color: white; padding: 10px 20px; border-radius: 25px; font-weight: bold;">
              Image <span id="image-number">1</span> of 2
            </span>
          </div>

          <div class="video-container">
            <div class="video-panel">
              <h3>Image to Describe</h3>
              <img id="current-image" src="" alt="Image to describe" style="width: 100%; border-radius: 10px;" />
            </div>

            <div class="video-panel">
              <h3>Your Video</h3>
              <video id="video-preview" autoplay muted playsinline style="display: none;"></video>
              <video id="recorded-video" controls playsinline style="display: none;"></video>

              <div class="recording-controls">
                <div class="recording-status ready" id="recording-status">Ready to record</div>
                <div id="recording-timer" style="font-size: 24px; color: var(--danger); margin: 10px 0; display: none;">00:00</div>

                <!-- Upload Progress Indicator -->
                <div id="upload-progress">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="flex: 1;">
                      <div style="font-weight: bold; margin-bottom: 5px;">Uploading video to secure storage...</div>
                      <div class="upload-progress-bar">
                        <div id="upload-progress-fill"></div>
                      </div>
                    </div>
                    <div id="upload-status">0%</div>
                  </div>
                </div>

                <div class="button-group">
                  <button class="button danger" id="record-btn" onclick="toggleRecording()">Start Recording</button>
                  <button class="button secondary" id="rerecord-btn" onclick="reRecord()" style="display: none;">Re-record</button>
                  <button class="button success" id="save-recording-btn" onclick="saveRecording()" style="display: none;">Save & Continue</button>
                </div>
              </div>
            </div>
          </div>

          <div class="info-banner info">
            <strong>What to describe (30–60 seconds):</strong>
            <ul style="margin: 10px 0 0 20px; text-align: left;">
              <li>Objects and people you see</li>
              <li>Where things are located</li>
              <li>What is happening in the image</li>
              <li>Spatial relationships between objects</li>
            </ul>
          </div>

          <div id="recording-error" class="info-banner warning" style="display:none; margin-top: 15px;"></div>

          <div class="card" id="video-upload-fallback" style="margin-top: 15px; display:none;">
            <h3>Upload a short video instead</h3>
            <p>Record 30–60 seconds describing the image on your device, then upload the file here.</p>
            <input type="file" id="video-file-input" accept="video/*" />
            <div class="button-group">
              <button class="button success" id="upload-save-btn" style="display:none;">Use this upload</button>
            </div>
          </div>

          <button class="button secondary" id="skip-recording-btn" style="display: block; margin: 20px auto;">Skip This Task</button>
        </div>
      </div>

      <!-- Completion -->
      <div class="screen" id="completion-screen">
        <div style="text-align: center; padding: 50px;">
          <h2 style="color: var(--success); font-size: 36px; margin-bottom: 20px;">🎉 Study Complete!</h2>
          <p style="font-size: 20px; margin: 20px 0;">Thank you for participating in our research!</p>
          <div class="code-display">
            <p>Your session code was:</p>
            <div class="code" id="final-code">ABC12345</div>
          </div>
          <p style="margin-top: 20px;">Total time: <strong id="total-time">0</strong> minutes</p>
          <div class="button-group" style="margin-top:30px;">
            <button class="button success" id="mark-complete-btn" onclick="markComplete()">Mark Me Complete</button>
          </div>
          <p id="completion-message" style="display:none; margin-top:20px; color: var(--text-muted);">
            ✅ Your participation has been recorded. You may now close this window.
          </p>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>For technical support: <a href="mailto:action.brain.lab@gallaudet.edu">action.brain.lab@gallaudet.edu</a></p>
      <p style="margin-top: 10px; font-size: 14px;">Your progress is automatically saved after each task.</p>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" id="pause-fab" onclick="pauseSession()">⏸️ Save & Exit</button>

  <!-- Pause Modal -->
  <div class="modal" id="pause-modal">
    <div class="modal-content">
      <h3>Session Saved!</h3>
      <p>Your progress has been saved.</p>
      <div class="code-display">
        <div class="code" id="modal-code">ABC12345</div>
      </div>
      <p style="font-size: 14px; color: var(--text-muted); margin-top: 20px;">Return anytime to complete remaining tasks.</p>
      <button class="button" onclick="location.reload()">Exit Study</button>
    </div>
  </div>

  <!-- EEG Modal -->
  <div class="modal" id="eeg-modal">
    <div class="modal-content">
      <h3>📍 Local EEG Add-On Information</h3>
      <div class="info-banner info" style="margin: 20px 0;">
        <strong>Contact the Action Brain Lab:</strong>
        <p style="margin-top: 10px;">
          Email: <strong>action.brain.lab@gallaudet.edu</strong>
          <button class="button outline" onclick="copyEmail(this)" style="margin-left: 10px;">Copy Email</button>
        </p>
      </div>

      <div style="text-align: left; background: var(--gray-light); padding: 20px; border-radius: 10px; margin: 20px 0;">
        <strong>Include in your email:</strong>
        <ul style="margin: 10px 0 0 20px;">
          <li>Your session code: <strong id="eeg-session-code">TBD</strong></li>
          <li>That you're interested in the local EEG add-on</li>
          <li>Your preferred days/times for the visit</li>
          <li>Communication preference (ASL or English)</li>
        </ul>
      </div>

      <div class="button-group">
        <button class="button" onclick="tryMailto()">Open Email Client</button>
        <button class="button secondary" onclick="closeEEGModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ----- Configuration -----
    const CONFIG = {
      SHEETS_URL: 'https://script.google.com/macros/s/AKfycbxT4jpPNG6hTDbmpeo6utlOwHLPTrxBna_YjcG0yLNI9pO5hcI7yIJcTwgesvocSYSG4A/exec',
      IMAGE_1: 'images/description1.jpg',
      IMAGE_2: 'images/description2.jpg',
    ASLCT_ACCESS_CODE: 'DVCWHNABJ'

    };

    // ----- Tasks -----
    const TASKS = {
      'RC': {
        name: 'Reading Comprehension Task',
        description: 'Read passages and answer questions',
        type: 'embed',
        embedUrl: 'https://melodyfschwenk.github.io/readingcomp/',
        canSkip: true
      },
      'MRT': {
        name: 'Mental Rotation Task',
        description: 'Decide if two images are the same or not',
        type: 'embed',
        embedUrl: 'https://melodyfschwenk.github.io/mrt/',
        canSkip: true
      },
      'ASLCT': {
        name: 'ASL Comprehension Test',
        description: 'For ASL users only',
        url: 'https://vl2portal.gallaudet.edu/assessment/',
        type: 'external',
        canSkip: true
      },
      'VCN': {
        name: 'Virtual Campus Navigation',
        description: 'Virtual SILC Test of Navigation (SILCton)',
        url: 'http://www.virtualsilcton.com/study/753798747',
        type: 'external',
        canSkip: true
      },
      'SN': {
        name: 'Spatial Navigation',
        description: 'Choose the first step from the player to the stop sign (embedded below)',
        type: 'embed',
        embedUrl: 'https://melodyfschwenk.github.io/spatial-navigation-web/',
        canSkip: true
      },
      'ID': {
        name: 'Image Description',
        description: 'Describe images (video recording)',
        type: 'recording',
        canSkip: true
      },
      'DEMO': {
        name: 'Demographics Survey',
        description: 'Background information & payment',
        url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_8GJcoF3hkHoP8BU',
        type: 'external'
      }
    };

    // ----- Consents -----
    const CONSENTS = {
      'CONSENT1': { name: 'Research Consent', url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_cGZEQDXQpUbGq1g' },
      'CONSENT2': { name: 'Video Consent', url: 'https://gallaudet.iad1.qualtrics.com/jfe/form/SV_5j0XhME387Kii8u' }
    };

    // ----- Task sequencing -----
    const DESKTOP_TASKS = ['RC', 'MRT', 'ASLCT', 'VCN', 'SN', 'ID'];
    const MOBILE_TASKS = ['RC', 'MRT', 'ASLCT', 'SN', 'ID'];

    function mulberry32(a) {
      return function() {
        a |= 0; a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t ^= t + Math.imul(t ^ t >>> 7, 61 | t);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }

    function shuffleWithSeed(array, seed) {
      const rng = mulberry32(seed);
      const a = array.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // Detect if mobile/tablet
    function isMobileDevice() {
      const hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);
      const mobileUA = /Android|webOS|iPhone|iPad|iPod|Mobile|Tablet/i.test(navigator.userAgent);
      const isSmallScreen = window.innerWidth <= 1024;
      return hasTouch && (mobileUA || isSmallScreen);
    }

    // ----- State -----
    let state = {
      sessionCode: '',
      participantID: '',
      email: '',
      sequenceIndex: -1,
      sequence: [],
      currentTaskIndex: 0,
      completedTasks: [],
      startTime: null,
      totalTimeSpent: 0,
      lastActivity: null,
      consentStatus: { consent1: false, consent2: false, videoDeclined: false },
      recording: {
        active: false, mediaRecorder: null, chunks: [], currentImage: 0, recordings: [],
        stream: null, currentBlob: null
      }
    };

    // ----- Init (single handler) -----
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      // Secure-context guard: disable inline recording if not https
if (!window.isSecureContext) {
  // Hide the record button if the recording screen gets opened
  const style = document.createElement('style');
  style.textContent = `#record-btn { display: none !important; }`;
  document.head.appendChild(style);
}

      checkSavedSession();

      // Gentle mobile notice content swap
      if (isMobileDevice()) {
        const warning = document.getElementById('device-warning');
        if (warning) {
          warning.className = 'info-banner warning';
          warning.innerHTML = `
            <strong>Mobile or tablet detected</strong>
            <p style="margin-top: 10px;">
              A computer is preferred, but you can continue on this device. You can also pause now and resume later on a computer using your resume code.
            </p>
            <ul style="margin: 10px 0 0 20px; text-align: left;">
              <li>Some tasks are simpler on mobile</li>
              <li>Use Chrome or Safari, allow camera and mic if asked</li>
              <li>Your progress will save automatically</li>
            </ul>
          `;
        }
      }
    });

    function setupEventListeners() {
      document.getElementById('first-initial').addEventListener('input', validateInitials);
      document.getElementById('last-initial').addEventListener('input', validateInitials);
      document.getElementById('resume-code').addEventListener('input', e => { e.target.value = e.target.value.toUpperCase(); });
      bindRecordingSkips();
      bindUploadFallback();
    }

    function validateInitials(e) {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 1);
      const first = document.getElementById('first-initial').value;
      const last = document.getElementById('last-initial').value;
      document.getElementById('create-session-btn').disabled = !(first && last);
    }

    // ----- Screens -----
   // === REPLACE your existing showScreen with this ===
function showScreen(screenId) {
  // Hide all screens, show target
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screen = document.getElementById(screenId);
  if (screen) screen.classList.add('active');

  // Show/hide session widget + FAB
  const widget = document.getElementById('session-widget');
  const showWidget = ['progress-screen','task-screen','consent-screen','recording-screen'].includes(screenId);
  if (widget) widget.classList.toggle('active', showWidget && state.sessionCode);
  const fab = document.getElementById('pause-fab');
  if (fab) fab.classList.toggle('active', showWidget && state.sessionCode);

  // Accessibility: move focus to the screen heading and announce
  const heading = screen?.querySelector('h2, h1, h3');
  if (heading) {
    heading.setAttribute('tabindex', '-1');
    heading.focus({ preventScroll: false });
    // Clean up tabindex after focus so it doesn't stay in tab order
    setTimeout(() => heading.removeAttribute('tabindex'), 500);
    // Live region update
    const live = document.getElementById('live-status');
    if (live) live.textContent = `Section changed: ${heading.textContent}`;
  }
}


    // ----- Session -----
    function generateCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
      return code;
    }

    function createNewSession() {
      const first = document.getElementById('first-initial').value.trim().toUpperCase();
      const last = document.getElementById('last-initial').value.trim().toUpperCase();
      const email = document.getElementById('email').value.trim();
      if (!first || !last) { alert('Please enter your initials'); return; }

      if (isMobileDevice()) {
        const proceed = confirm(
          'You are on a phone or tablet.\n\n' +
          'A computer is preferred for the best experience, but you can continue now.\n' +
          'You can also pause and resume later on a computer using your resume code.\n\n' +
          'Continue on this device?'
        );
        if (!proceed) return;
      }

      state.sessionCode = generateCode();
      state.participantID = `${first}${last}_${Date.now().toString().slice(-4)}`;
      state.email = email;

      // Choose sequence (mobile vs desktop)
      const seed = Math.abs(hashCode(state.sessionCode));
      state.sequenceIndex = seed;
      if (isMobileDevice()) {
        state.sequence = shuffleWithSeed(MOBILE_TASKS, seed);
        state.isMobile = true;
      } else {
        state.sequence = shuffleWithSeed(DESKTOP_TASKS, seed);
        state.isMobile = false;
      }
      state.sequence.push('DEMO');

      state.startTime = Date.now();
      state.lastActivity = new Date().toISOString();

      saveState();
      sendToSheets({
        action: 'session_created',
        sessionCode: state.sessionCode,
        participantID: state.participantID,
        email: state.email,
        sequenceIndex: state.sequenceIndex,
        deviceType: state.isMobile ? 'mobile/tablet' : 'desktop',
        timestamp: new Date().toISOString()
      });

      document.getElementById('display-code').textContent = state.sessionCode;
      showScreen('session-created');
    }

    function resumeSession() {
      const code = document.getElementById('resume-code').value.toUpperCase();
      if (code.length !== 8) { alert('Please enter your 8-character resume code'); return; }
      try {
        const saved = localStorage.getItem(`study_${code}`);
        if (saved) {
          state = JSON.parse(saved);
          updateSessionWidget();
          if (!state.consentStatus.consent1) showScreen('consent-screen'); else showProgressScreen();
        } else {
          alert('Session not found. Please check your code.');
        }
      } catch (err) { console.error(err); alert('Error loading session'); }
    }

    // === REPLACE the body of checkSavedSession with this ===
function checkSavedSession() {
  try {
    const recentCode = localStorage.getItem('recent_session');
    if (!recentCode) return;

    const saved = localStorage.getItem(`study_${recentCode}`);
    if (!saved) return;

    const data = JSON.parse(saved);
    const daysSince = (Date.now() - new Date(data.lastActivity).getTime()) / (1000*60*60*24);
    if (daysSince < 30) {
      // Delay so it doesn’t clash with initial UI
      setTimeout(() => {
        if (confirm(`Welcome back! Resume session ${recentCode}?`)) {
          state = data; updateSessionWidget(); showProgressScreen();
        }
      }, 700); // ~0.7s feels smooth with your animations
    }
  } catch (e) {
    console.warn('Could not check saved session', e);
  }
}


    function saveState() {
      try {
        state.lastActivity = new Date().toISOString();
        localStorage.setItem(`study_${state.sessionCode}`, JSON.stringify(state));
        localStorage.setItem('recent_session', state.sessionCode);
      } catch (e) { console.warn('Could not save state', e); }
    }

    // ----- Consent -----
    function proceedToConsent() { showScreen('consent-screen'); updateConsentDisplay(); }
    function openConsent(type) {
      const consent = CONSENTS[type];
      if (consent) {
        window.open(consent.url, '_blank', 'noopener');
        sendToSheets({ action: 'consent_opened', sessionCode: state.sessionCode, type, timestamp: new Date().toISOString() });
      }
    }
    function markConsentDone(type) {
      if (type === 'consent1') {
        state.consentStatus.consent1 = true;
        document.getElementById('consent1-card').classList.add('completed');
        document.querySelector('#consent1-card .status-icon').textContent = '✅';
      } else if (type === 'consent2') {
        state.consentStatus.consent2 = true;
        document.getElementById('consent2-card').classList.add('completed');
        document.querySelector('#consent2-card .status-icon').textContent = '✅';
      }
      saveState(); updateConsentDisplay();
      sendToSheets({ action: 'consent_completed', sessionCode: state.sessionCode, type, timestamp: new Date().toISOString() });
    }
    function declineVideo() {
      if (confirm('Decline video consent? You can still participate in other tasks.')) {
        state.consentStatus.videoDeclined = true;
        state.consentStatus.consent2 = true;
        document.getElementById('consent2-card').classList.add('declined');
        document.querySelector('#consent2-card .status-icon').textContent = '⚠️';
        saveState(); updateConsentDisplay();
        sendToSheets({ action: 'video_declined', sessionCode: state.sessionCode, timestamp: new Date().toISOString() });
      }
    }
    function updateConsentDisplay() {
      const ready = state.consentStatus.consent1 && (state.consentStatus.consent2 || state.consentStatus.videoDeclined);
      document.getElementById('continue-from-consent').disabled = !ready;
      if (state.consentStatus.consent1) {
        document.getElementById('consent1-card').classList.add('completed');
        document.querySelector('#consent1-card .status-icon').textContent = '✅';
      }
      if (state.consentStatus.consent2 || state.consentStatus.videoDeclined) {
        const card = document.getElementById('consent2-card');
        card.classList.add(state.consentStatus.videoDeclined ? 'declined' : 'completed');
        document.querySelector('#consent2-card .status-icon').textContent = state.consentStatus.videoDeclined ? '⚠️' : '✅';
      }
    }
    function proceedToTasks() {
      if (!state.consentStatus.consent1) { alert('Please complete the research consent form'); return; }
      showProgressScreen();
    }

    // ----- Progress -----
    function showProgressScreen() { updateTaskList(); updateProgressBar(); updateSessionWidget(); showScreen('progress-screen'); }
    function updateTaskList() {
      const list = document.getElementById('task-list');
      list.innerHTML = '';
      state.sequence.forEach((taskCode, index) => {
        const task = TASKS[taskCode];
        const li = document.createElement('li');
        li.className = 'task-item';
        const isCompleted = state.completedTasks.includes(taskCode);
        const isCurrent = index === state.currentTaskIndex && !isCompleted;
        if (isCompleted) li.classList.add('completed');
        else if (isCurrent) li.classList.add('current');
        else li.classList.add('locked');
        li.innerHTML = `
          <div class="task-info">
            <div class="task-name">${task.name}</div>
            <div class="task-description">${task.description}</div>
          </div>
          <div class="task-status">${isCompleted ? '✅' : (isCurrent ? '▶️' : '⭕')}</div>
        `;
        list.appendChild(li);
      });
    }
    function updateProgressBar() {
      const progress = (state.completedTasks.length / state.sequence.length) * 100;
      document.getElementById('progress-fill').style.width = `${progress}%`;
      document.getElementById('progress-text').textContent = `${Math.round(progress)}%`;
    }
    function updateSessionWidget() {
      if (!state.sessionCode) return;
      document.getElementById('widget-code').textContent = state.sessionCode + (state.isMobile ? ' (Mobile)' : '');
      document.getElementById('widget-progress').textContent = `${state.completedTasks.length}/${state.sequence.length}`;
      document.getElementById('widget-time').textContent = `${Math.round(state.totalTimeSpent / 60000)} min`;
      const currentTask = state.sequence[state.currentTaskIndex];
      document.getElementById('widget-current').textContent = currentTask ? TASKS[currentTask].name : 'Complete';
    }

    // ----- Task flow -----
    function continueToCurrentTask() {
      if (state.currentTaskIndex >= state.sequence.length) { showCompletionScreen(); return; }
      startTask(state.sequence[state.currentTaskIndex]);
    }
    function startTask(taskCode) {
      const task = TASKS[taskCode];
      if (!task) return;

      if (!state.taskData) state.taskData = {};
      state.taskData[taskCode] = { startTime: Date.now() };

      if (task.type === 'recording') showRecordingTask();
      else if (task.type === 'embed') showEmbeddedTask(taskCode);
      else showExternalTask(taskCode);

      sendToSheets({ action: 'task_started', sessionCode: state.sessionCode, task: task.name, timestamp: new Date().toISOString() });
    }

    // ----- Distraction-free fallback -----
    function enterDistractionFree() {
      document.documentElement.classList.add('df-mode');
      document.body.dataset.scrollY = window.scrollY;
      document.body.style.top = `-${window.scrollY}px`;
    }
    function exitDistractionFree() {
      document.documentElement.classList.remove('df-mode');
      const y = parseInt(document.body.dataset.scrollY || '0', 10);
      document.body.style.top = '';
      window.scrollTo(0, y);
    }

    // PostMessage completion hook
    window.addEventListener('message', (ev) => {
      const allowedOrigin = 'https://melodyfschwenk.github.io';
      if (ev.origin !== allowedOrigin) return;
      const data = ev.data || {};
      if (data.type === 'task-complete' && data.taskCode && TASKS[data.taskCode]) {
        completeTask(data.taskCode);
      }
    });

    // ----- Embedded tasks -----
    function showEmbeddedTask(taskCode) {
      const task = TASKS[taskCode];
      const url  = task.embedUrl;
      const iframeId = `embed-${taskCode.toLowerCase()}`;

      let extra = '';
      if (taskCode === 'SN') {
        extra = `
          <div class="info-banner info" style="margin-top:10px;">
            <strong>What you'll do</strong>
            <p style="margin-top:6px;">Press <em>one</em> arrow key for the <em>first</em> step from the gray player to the red stop sign.</p>
          </div>`;
      } else if (taskCode === 'MRT') {
        extra = `
          <div class="info-banner warning" style="margin-top:10px;">
            <strong>Heads up:</strong>
            <p style="margin-top:6px;">Takes about <strong>5–6 minutes</strong>. Work steadily from start to finish.</p>
          </div>`;
      }

      document.getElementById('task-title').textContent = task.name;
      document.getElementById('task-instructions').innerHTML = `
        <p>${task.description}</p>
        ${extra}
        <details style="margin-top:10px;"><summary style="cursor:pointer;">More info / troubleshooting</summary>
          <ul style="margin:8px 0 0 20px; text-align:left;">
            <li>If the game doesn't respond, click inside it once to give it keyboard focus.</li>
            <li>If fullscreen doesn't work on your device, we'll switch to a distraction-free view.</li>
          </ul>
        </details>
      `;

      const content = document.getElementById('task-content');
      content.innerHTML = `
        <div class="card" id="prestart">
          <p>When you click <strong>Continue</strong>, the task will open in fullscreen. When you're finished, click <em>I'm finished — Continue</em>.</p>
          <div class="button-group" style="margin-top:12px;">
            <button class="button" id="start-embed">Continue</button>
            ${task.canSkip ? `<button class="button secondary" onclick="skipTask('${taskCode}')">Skip This Task</button>` : ''}
          </div>
        </div>

        <div class="embed-shell fs-shell" id="fs-shell" style="display:none;">
          <div class="fs-toolbar" id="fs-toolbar">
            <div>${task.name}</div>
            <div class="actions">
              <button class="button success" id="finish-btn" disabled>I'm finished — Continue</button>
              <button class="button secondary" id="exit-btn">Exit fullscreen</button>
            </div>
          </div>
          <iframe id="${iframeId}" class="embed-frame" src="${url}" allow="fullscreen; gamepad; xr-spatial-tracking" allowfullscreen></iframe>
          <div class="embed-note">Tip: click once inside the game to give it keyboard focus.</div>
        </div>
      `;

      showScreen('task-screen');

      const fsShell = document.getElementById('fs-shell');
      const finishBtn = document.getElementById('finish-btn');
      const exitBtn = document.getElementById('exit-btn');
      const prestart = document.getElementById('prestart');
      const iframe = document.getElementById(iframeId);

      const enableFinish = () => { finishBtn.disabled = false; };

      async function goFullscreen() {
        prestart.style.display = 'none';
        fsShell.style.display = 'block';

        setTimeout(() => { try { iframe.focus(); } catch(e) {} }, 50);

        try {
          if (fsShell.requestFullscreen) { await fsShell.requestFullscreen({ navigationUI: 'hide' }).catch(() => {}); }
          else if (fsShell.webkitRequestFullscreen) { fsShell.webkitRequestFullscreen(); }
          setTimeout(() => {
            const inFS = document.fullscreenElement || document.webkitFullscreenElement;
            if (!inFS) enterDistractionFree();
          }, 250);
        } catch (e) { enterDistractionFree(); }

        setTimeout(enableFinish, 6000);
      }

      function leaveFullscreenModes() {
        if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
        if (document.webkitFullscreenElement) document.webkitExitFullscreen?.();
        exitDistractionFree();
      }

      document.getElementById('start-embed').onclick = goFullscreen;
      finishBtn.onclick = () => { leaveFullscreenModes(); completeTask(taskCode); };
      exitBtn.onclick = () => { leaveFullscreenModes(); fsShell.scrollIntoView({ behavior: 'smooth', block: 'start' }); enableFinish(); };

      const loadTimeout = setTimeout(() => {
        const note = document.createElement('div');
        note.className = 'embed-note';
        note.textContent = 'Still loading… if nothing appears soon, try exiting fullscreen and re-entering.';
        fsShell.appendChild(note);
      }, 7000);
      iframe.addEventListener('load', () => clearTimeout(loadTimeout), { once:true });

      document.addEventListener('keydown', function escHandler(ev) {
        if (ev.key === 'Escape') {
          setTimeout(leaveFullscreenModes, 0);
          document.removeEventListener('keydown', escHandler);
        }
      });
    }

    // ----- External tasks -----
    
    // === REPLACE your existing showExternalTask with this ===
function showExternalTask(taskCode) {
  const task = TASKS[taskCode];
  let extra = '';

  if (taskCode === 'ASLCT') {
    // Use ONE access code consistently. If you have an official one, put it here:
    const ASLCT_CODE = CONFIG.ASLCT_ACCESS_CODE;


    extra = `
      <div class="info-banner success" style="margin-top: 10px;">
        <strong>ASLCT Access Code</strong>
        <p style="margin-top: 6px;">
          On the login page, enter access code:
          <span class="code" style="font-size:22px; background:#fff; color:#333; padding:4px 8px; border-radius:6px; display:inline-block;">${ASLCT_CODE}</span>
        </p>
        <button class="button outline" onclick="navigator.clipboard.writeText('${ASLCT_CODE}').then(()=>{ this.textContent='✅ Copied!'; setTimeout(()=>this.textContent='Copy Access Code',1500); })">Copy Access Code</button>
      </div>
      <div class="info-banner info" style="margin-top: 10px;">
        <strong>Instructions:</strong>
        <ol style="margin: 10px 0 0 20px; text-align: left;">
          <li>Click "Open Task".</li>
          <li>On the ASLCT portal, paste the access code <em>${ASLCT_CODE}</em> and follow the prompts.</li>
          <li>Return here when finished and click "Mark Complete".</li>
        </ol>
      </div>
      <div style="margin-top: 10px; text-align: left;">
        <p>If you encounter any problems with the ASLCT, please describe them below and click Send.</p>
        <textarea id="aslct-issue-text" style="width: 100%; height: 80px; margin-top: 6px;"></textarea>
        <button class="button secondary" style="margin-top: 10px;" onclick="submitASLCTIssue()">Send</button>
      </div>`;
  } else if (taskCode === 'VCN') {
    extra = `
      <div class="info-banner info" style="margin-top: 10px;">
        <strong>Virtual SILC Test of Navigation (SILCton) — What you'll do</strong>
        <p style="margin-top: 6px;">Learn a small virtual campus (Learning phase), then answer quick questions (Test phase).</p>
        <ul style="margin: 10px 0 0 20px; text-align: left;">
          <li><strong>Controls:</strong> Move with WASD/arrow keys; look around with the mouse.</li>
          <li>Desktop/laptop recommended (Chrome/Firefox). Keep this page open.</li>
        </ul>
      </div>`;
  }

  document.getElementById('task-title').textContent = task.name;
  document.getElementById('task-instructions').innerHTML = `
    <p>${task.description}</p>
    ${extra}
    <div class="info-banner info" style="margin-top: 10px;">
      <strong>Instructions:</strong>
      <ol style="margin: 10px 0 0 20px; text-align: left;">
        <li>Click "Open Task" to launch in a new tab.</li>
        <li>Complete the task as instructed.</li>
        <li>Return to this tab when finished.</li>
        <li>Click "Mark Complete" to continue.</li>
      </ol>
    </div>
  `;

  const content = document.getElementById('task-content');
  // Use a real <a> for opening the task (more semantic, keyboard-friendly)
  content.innerHTML = `
    <div class="button-group">
      <a class="button"
         href="${task.url}"
         target="_blank"
         rel="noopener"
         aria-label="Open Task (opens in new tab)"
         onclick="sendToSheets({ action: 'task_opened', sessionCode: state.sessionCode || 'none', timestamp: new Date().toISOString(), userAgent: navigator.userAgent });">
         Open Task
      </a>
      <button class="button success" onclick="completeTask('${taskCode}')">Mark Complete</button>
    </div>
  `;

  if (task.canSkip) {
    content.innerHTML += `
      <button class="button secondary" onclick="skipTask('${taskCode}')" style="display: block; margin: 20px auto;">
        ${taskCode === 'ASLCT' ? 'Skip - I Do Not Know ASL' : 'Skip This Task'}
      </button>
    `;
  }

  showScreen('task-screen');
}

function openExternalTask(taskCode) {
  const task = TASKS[taskCode];
  if (!task || !task.url) return;
  window.open(task.url, '_blank', 'noopener');
}

    // ----- Recording task -----
    function showRecordingTask() {
      state.recording.currentImage = 0;
      state.recording.recordings = [];
      state.recording.currentBlob = null;
      if (!state.consentStatus.consent2 || state.consentStatus.videoDeclined) {
        document.getElementById('recording-consent-check').style.display = 'block';
        document.getElementById('recording-content').style.display = 'none';
      } else {
        document.getElementById('recording-consent-check').style.display = 'none';
        document.getElementById('recording-content').style.display = 'block';
        updateRecordingImage();
      }
      // NEW: if page not secure, skip recorder UI and show upload UI
if (!window.isSecureContext) {
  document.getElementById('recording-consent-check').style.display = 'none';
  document.getElementById('recording-content').style.display = 'block';
  document.getElementById('video-upload-fallback').style.display = 'block';
  const status = document.getElementById('recording-status');
  status.textContent = 'Recording disabled (requires https). Please use the upload option below.';
  status.className = 'recording-status warning';
}

      showScreen('recording-screen');
    }

    function revokeRecordedURL() {
      const recorded = document.getElementById('recorded-video');
      if (recorded && recorded.src) {
        try { URL.revokeObjectURL(recorded.src); } catch(e) {}
        recorded.removeAttribute('src');
        recorded.load?.();
      }
    }

    function updateRecordingImage() {
      const imageNum = state.recording.currentImage + 1;
      document.getElementById('image-number').textContent = imageNum;
      document.getElementById('current-image').src = imageNum === 1 ? CONFIG.IMAGE_1 : CONFIG.IMAGE_2;
      
      const preview = document.getElementById('video-preview');
      const recorded = document.getElementById('recorded-video');
      preview.style.display = 'none';
      recorded.style.display = 'none';
      
      // Clean up previous recording blob URL
      revokeRecordedURL();
      state.recording.currentBlob = null;
      
      // Reset UI elements
      document.getElementById('record-btn').style.display = 'inline-block';
      document.getElementById('rerecord-btn').style.display = 'none';
      document.getElementById('save-recording-btn').style.display = 'none';
      
      const status = document.getElementById('recording-status');
      status.textContent = 'Ready to record';
      status.className = 'recording-status ready';
      
      // Clear any previous errors
      document.getElementById('recording-error').style.display = 'none';
      document.getElementById('video-upload-fallback').style.display = 'none';
      document.getElementById('upload-progress').style.display = 'none';
      
      // Clear file input
      const fileInput = document.getElementById('video-file-input');
      if (fileInput) fileInput.value = '';
      
      const uploadBtn = document.getElementById('upload-save-btn');
      if (uploadBtn) {
        uploadBtn.style.display = 'none';
        uploadBtn.textContent = 'Use this upload';
      }
    }

    function isIOS() { return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }

    async function checkSecureAndPermissions() {
      if (!window.isSecureContext) {
        const hint = location.protocol === 'http:' ? 'This page must be served over https.' : 'This page cannot run from a local file.';
        throw { code: 'NOT_SECURE', message: hint };
      }
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw { code: 'NO_MEDIADEVICES', message: 'This browser does not support in-page recording.' };
      }
      let cam = 'unknown', mic = 'unknown';
      try {
        const camPerm = await navigator.permissions.query({ name: 'camera' });
        const micPerm = await navigator.permissions.query({ name: 'microphone' });
        cam = camPerm?.state || 'unknown';
        mic = micPerm?.state || 'unknown';
      } catch(e) {}
      return { cam, mic };
    }

    function showRecordingError(html, showFallback = true) {
      const box = document.getElementById('recording-error');
      if (!box) return;
      box.style.display = 'block';
      box.innerHTML = html;
      if (showFallback) {
        const fb = document.getElementById('video-upload-fallback');
        if (fb) fb.style.display = 'block';
      }
    }

    // Enhanced file upload handling for the fallback option
    function bindUploadFallback() {
  const input = document.getElementById('video-file-input');
  const btn = document.getElementById('upload-save-btn');
  if (!input || !btn) return;
  
  input.addEventListener('change', () => {
    const f = input.files && input.files[0];
    if (!f) return;
    if (!f.type.startsWith('video/')) { 
      alert('Please select a video file'); 
      input.value = ''; 
      return; 
    }
    
    // Warn for very large files but allow them
    if (f.size > 100 * 1024 * 1024) { // 100MB warning
      if (!confirm(`Large file (${Math.round(f.size/1024/1024)}MB). This may take longer to upload. Continue?`)) {
        input.value = '';
        return;
      }
    }
    
    state.recording.currentBlob = f;
    btn.style.display = 'inline-block';
    btn.textContent = `Upload & Continue (${Math.round(f.size/1024)}KB)`;
  });
  
  btn.addEventListener('click', saveRecording);
}

    function bindRecordingSkips() {
      document.getElementById('skip-recording-btn')?.addEventListener('click', skipRecording);
      document.getElementById('skip-recording-consent-btn')?.addEventListener('click', skipRecording);
    }

    async function toggleRecording() {
      const btn = document.getElementById('record-btn');
      const status = document.getElementById('recording-status');
      const preview = document.getElementById('video-preview');

      if (!state.recording.active) {
        try {
          const perm = await checkSecureAndPermissions();
          if (perm.cam === 'denied' || perm.mic === 'denied') {
            const how = isIOS()
              ? 'Settings → Safari → Camera/Microphone → Allow for this site, then reload.'
              : 'Click the camera icon in the address bar and allow camera and microphone, then reload.';
            showRecordingError(`<strong>Camera or microphone is blocked</strong><p style="margin-top: 6px;">Please allow access for this site. ${how}</p>`);
            return;
          }

          const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: true });
          state.recording.stream = stream; preview.srcObject = stream; preview.style.display = 'block';

          if (!window.MediaRecorder) {
            showRecordingError(`<strong>Recording not supported in this browser</strong><p style="margin-top: 6px;">Please use Chrome, Edge, or Firefox, or upload a short video below.</p>`);
            return;
          }

          let options = {};
          if (MediaRecorder.isTypeSupported?.('video/webm;codecs=vp9,opus')) options.mimeType = 'video/webm;codecs=vp9,opus';
          else if (MediaRecorder.isTypeSupported?.('video/webm;codecs=vp8,opus')) options.mimeType = 'video/webm;codecs=vp8,opus';

          state.recording.mediaRecorder = new MediaRecorder(stream, options);
          state.recording.chunks = [];
          state.recording.mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) state.recording.chunks.push(e.data); };
          state.recording.mediaRecorder.onstop = () => {
            try {
              revokeRecordedURL();
              const blob = new Blob(state.recording.chunks, { type: options.mimeType || 'video/webm' });
              const url = URL.createObjectURL(blob);
              const recordedEl = document.getElementById('recorded-video');
              recordedEl.src = url;
              recordedEl.style.display = 'block';
              preview.style.display = 'none';

              document.getElementById('record-btn').style.display = 'none';
              document.getElementById('rerecord-btn').style.display = 'inline-block';
              document.getElementById('save-recording-btn').style.display = 'inline-block';
              status.textContent = 'Recording complete';
              status.className = 'recording-status recorded';
              state.recording.currentBlob = blob;
            } catch (e) {
              console.error('Finalize error:', e);
              alert('There was an issue finalizing the recording.');
            }
          };

          state.recording.mediaRecorder.start();
          state.recording.active = true;
          btn.textContent = 'Stop Recording';
          btn.className = 'button danger';
          status.textContent = '🔴 Recording...';
          status.className = 'recording-status recording';
          startRecordingTimer();

        } catch (err) {
          console.error('Recording error:', err);
          const name = err?.name || err?.code || 'Unknown';
          if (name === 'NOT_SECURE') {
            const suggest = location.protocol === 'http:' ? `Please reload over https: ${location.href.replace('http:', 'https:')}` : 'This page cannot run from a local file. Please host it or use a local https server.';
            showRecordingError(`<strong>Secure context required</strong><p style="margin-top: 6px;">${suggest}</p>`);
          } else if (name === 'NotAllowedError' || name === 'PermissionDeniedError') {
            const how = isIOS()
              ? 'Settings → Safari → Camera/Microphone → Allow for this site, then reload.'
              : 'Click the camera icon in the address bar and allow camera and microphone, then reload.';
            showRecordingError(`<strong>Permission not granted</strong><p style="margin-top: 6px;">Please allow camera and microphone access for this site. ${how}</p>`);
          } else if (name === 'NotFoundError' || name === 'DevicesNotFoundError') {
            showRecordingError(`<strong>No camera or microphone found</strong><p style="margin-top: 6px;">Please connect a camera and microphone or use the upload option below.</p>`);
          } else if (name === 'NotReadableError' || name === 'TrackStartError') {
            showRecordingError(`<strong>Camera or microphone in use</strong><p style="margin-top: 6px;">Please close other apps using the camera, then try again. You can also upload a video below.</p>`);
          } else {
            showRecordingError(`<strong>Could not access camera</strong><p style="margin-top: 6px;">${err?.message || 'Unknown error'}</p>`);
          }
        }
      } else {
        try {
          if (state.recording.mediaRecorder && state.recording.mediaRecorder.state !== 'inactive') {
            state.recording.mediaRecorder.stop();
          }
        } catch(e) { console.warn('Stop error:', e); }
        finally {
          if (state.recording.stream) { try { state.recording.stream.getTracks().forEach(track => track.stop()); } catch(e){} }
          state.recording.active = false;
          btn.textContent = 'Start Recording';
          btn.className = 'button danger';
          stopRecordingTimer();
        }
      }
    }

    function reRecord() { cleanupRecording(true).finally(() => updateRecordingImage()); }

    // Updated saveRecording function with Google Drive upload
    async function saveRecording() {
      if (!state.recording.currentBlob) { 
        alert('Please record or upload a video first.'); 
        return; 
      }

      // Show uploading status
      // Show uploading status
const saveBtn = document.getElementById('save-recording-btn');
const originalText = saveBtn.textContent;
saveBtn.disabled = true;
saveBtn.textContent = 'Processing...';

// Update status and show progress
const status = document.getElementById('recording-status');
status.textContent = '⚙️ Processing video...';
status.className = 'recording-status recording';

const uploadProgress = document.getElementById('upload-progress');
uploadProgress.style.display = 'block';

      try {
        // Upload to Google Drive
        const uploadResult = await uploadVideoToDrive(
          state.recording.currentBlob, 
          state.sessionCode, 
          state.recording.currentImage + 1
        );

        if (uploadResult.success) {
          // Store the upload info
          state.recording.recordings.push({ 
            image: state.recording.currentImage + 1, 
            blob: state.recording.currentBlob, 
            timestamp: new Date().toISOString(),
            driveFileId: uploadResult.fileId,
            driveFileUrl: uploadResult.fileUrl,
            filename: uploadResult.filename
          });

          // Log the successful recording and upload
          sendToSheets({ 
            action: 'image_recorded_and_uploaded', 
            sessionCode: state.sessionCode, 
            imageNumber: state.recording.currentImage + 1,
            driveFileId: uploadResult.fileId,
            filename: uploadResult.filename,
            timestamp: new Date().toISOString() 
          });

          // Update status to success
          status.textContent = '✅ Upload complete!';
          status.className = 'recording-status recorded';
          uploadProgress.style.display = 'none';

          // Continue to next image or complete task
          setTimeout(() => {
            if (state.recording.currentImage === 0) { 
              state.recording.currentImage = 1; 
              updateRecordingImage(); 
            } else { 
              completeTask('ID'); 
            }
          }, 1000);

        } else {
          throw new Error(uploadResult.error || 'Upload failed');
        }

      } catch (error) {
        console.error('Upload error:', error);
        
        // Hide progress and show error message
        uploadProgress.style.display = 'none';
        const errorDiv = document.getElementById('recording-error');
        errorDiv.style.display = 'block';
        errorDiv.innerHTML = `
          <strong>Upload failed</strong>
          <p style="margin-top: 6px;">
            Error: ${error.message}. You can try again or continue without uploading. 
            The video is saved locally in your browser.
          </p>
          <div class="button-group" style="margin-top: 10px;">
            <button class="button" onclick="retryVideoUpload()">Try Again</button>
            <button class="button secondary" onclick="continueWithoutUpload()">Continue Without Upload</button>
          </div>
        `;

        // Reset status
        status.textContent = '❌ Upload failed';
        status.className = 'recording-status ready';
      } finally {
        // Reset button
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      }
    }

    // New function to upload video to Google Drive
    // === REPLACE your existing uploadVideoToDrive with this ===
async function uploadVideoToDrive(videoBlob, sessionCode, imageNumber) {
  try {
    // Show staged progress that reflects real phases
    updateUploadProgress(10, 'Preparing upload...');
    
    // Convert blob -> base64 (no data: prefix)
    const base64DataUrl = await blobToBase64(videoBlob);
    const base64VideoData = base64DataUrl.split(',')[1];
    updateUploadProgress(30, 'Encoding complete...');

    // Build payload (with optional auth added below in step 4)
    let uploadData = {
      action: 'upload_video',
      sessionCode: sessionCode,
      imageNumber: imageNumber,
      videoData: base64VideoData,
      fileSize: videoBlob.size,
      timestamp: new Date().toISOString()
    };

    // (Optional security) Attach HMAC auth if you added Step 4
    if (window.addAuthFields) {
      uploadData = await addAuthFields(uploadData);
    }

    updateUploadProgress(60, 'Sending to server...');

    const response = await fetch(CONFIG.SHEETS_URL, {
      method: 'POST',
      // IMPORTANT: "simple" request -> no preflight; server returns JSON we can read
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(uploadData)
    });

    if (!response.ok) {
      const errText = await response.text().catch(() => '');
      throw new Error(`Upload request failed (${response.status}). ${errText}`);
    }

    // Read JSON result from Apps Script
    let result;
    try {
      result = await response.json();
    } catch {
      // Fallback (rare) if returned as text
      const text = await response.text();
      result = JSON.parse(text);
    }

    if (!result.success) {
      throw new Error(result.error || 'Upload failed');
    }

    // Only now mark 100% and success
    updateUploadProgress(100, 'Upload complete!');

    return {
      success: true,
      filename: result.filename,
      fileId: result.fileId,
      fileUrl: result.fileUrl
    };

  } catch (error) {
    return { success: false, error: error.message || String(error) };
  }
}

    // Add this NEW function after uploadVideoToDrive
function updateUploadProgress(percent, message) {
  const progressDiv = document.getElementById('upload-progress');
  const progressFill = document.getElementById('upload-progress-fill');
  const status = document.getElementById('upload-status');
  
  if (progressDiv) progressDiv.style.display = 'block';
  if (progressFill) progressFill.style.width = `${percent}%`;
  if (status) status.textContent = `${percent}%`;
  
  // Update the progress message
  const progressText = progressDiv?.querySelector('div[style*="font-weight: bold"]');
  if (progressText && message) {
    progressText.textContent = message;
  }
}

    // Helper function to convert blob to base64
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // Retry upload function
    async function retryVideoUpload() {
      document.getElementById('recording-error').style.display = 'none';
      await saveRecording();
    }

    // Continue without upload function
    function continueWithoutUpload() {
      if (confirm('Continue without uploading the video? The recording will only be saved locally in your browser.')) {
        // Store the recording info without Drive details
        state.recording.recordings.push({ 
          image: state.recording.currentImage + 1, 
          blob: state.recording.currentBlob, 
          timestamp: new Date().toISOString(),
          uploadSkipped: true
        });

        // Log that recording was saved but not uploaded
        sendToSheets({ 
          action: 'image_recorded_no_upload', 
          sessionCode: state.sessionCode, 
          imageNumber: state.recording.currentImage + 1,
          reason: 'Upload failed - continued locally',
          timestamp: new Date().toISOString() 
        });

        // Continue to next image or complete task
        if (state.recording.currentImage === 0) { 
          state.recording.currentImage = 1; 
          updateRecordingImage(); 
        } else { 
          completeTask('ID'); 
        }
        
        document.getElementById('recording-error').style.display = 'none';
      }
    }

    function cleanupRecording(keepPreviewUI = false) {
      return new Promise(resolve => {
        try {
          if (state.recording.mediaRecorder && state.recording.mediaRecorder.state !== 'inactive') {
            state.recording.mediaRecorder.addEventListener('stop', () => resolve(), { once: true });
            try { state.recording.mediaRecorder.stop(); } catch(e) { resolve(); }
          } else { resolve(); }
        } catch(e) { resolve(); }
      }).finally(() => {
        try { if (state.recording.stream) state.recording.stream.getTracks().forEach(t => t.stop()); } catch(e){}
        state.recording.stream = null;
        state.recording.active = false;
        state.recording.chunks = [];
        stopRecordingTimer();

        if (!keepPreviewUI) {
          const preview = document.getElementById('video-preview');
          if (preview) { preview.pause?.(); preview.srcObject = null; preview.style.display = 'none'; }
          const recorded = document.getElementById('recorded-video');
          if (recorded) { revokeRecordedURL(); recorded.style.display = 'none'; }
          state.recording.mediaRecorder = null;
        }
      });
    }

    function ensureTaskPointer(taskCode) {
      if (!state.sequence || !state.sequence.length) return;
      if (state.sequence[state.currentTaskIndex] !== taskCode) {
        const idx = state.sequence.indexOf(taskCode);
        if (idx !== -1) state.currentTaskIndex = idx;
      }
    }

    async function skipRecording() {
      if (!confirm('Skip the image description task?')) return;
      try { await cleanupRecording(); } catch(e) { console.warn('Cleanup on skip failed silently:', e); }
      ensureTaskPointer('ID'); skipTask('ID');
    }

    let recordingTimer;
    function startRecordingTimer() {
      const timer = document.getElementById('recording-timer'); timer.style.display = 'block';
      let seconds = 0;
      recordingTimer = setInterval(() => {
        seconds++; const mins = Math.floor(seconds/60); const secs = seconds % 60;
        timer.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
      }, 1000);
    }
    function stopRecordingTimer() { clearInterval(recordingTimer); const t = document.getElementById('recording-timer'); if (t) t.style.display = 'none'; }

    // ----- Complete/Skip -----
    function completeTask(taskCode) {
      const task = TASKS[taskCode]; if (!task) { console.error('Task not found:', taskCode); return; }
      const startTime = state.taskData && state.taskData[taskCode]?.startTime || Date.now();
      const timeSpent = Date.now() - startTime; state.totalTimeSpent += timeSpent;
      if (!state.completedTasks.includes(taskCode)) state.completedTasks.push(taskCode);
      state.currentTaskIndex++;
      while (state.currentTaskIndex < state.sequence.length && state.completedTasks.includes(state.sequence[state.currentTaskIndex])) state.currentTaskIndex++;
      saveState();
      sendToSheets({ action: 'task_completed', sessionCode: state.sessionCode, task: task.name, duration: Math.round(timeSpent/1000), timestamp: new Date().toISOString() });
      if (state.currentTaskIndex >= state.sequence.length) showCompletionScreen(); else showProgressScreen();
    }

    function skipTask(taskCode) {
      const task = TASKS[taskCode]; if (!task) { console.error('Task not found:', taskCode); return; }
      if (taskCode === 'ID') {
        if (state.recording && (state.recording.stream || state.recording.active)) {
          try { state.recording.stream?.getTracks().forEach(t => t.stop()); } catch(e){}
          state.recording.active = false; state.recording.chunks = []; stopRecordingTimer();
        }
      }
      if (!state.completedTasks.includes(taskCode)) state.completedTasks.push(taskCode);
      state.currentTaskIndex++;
      while (state.currentTaskIndex < state.sequence.length && state.completedTasks.includes(state.sequence[state.currentTaskIndex])) state.currentTaskIndex++;
      saveState();
      sendToSheets({
        action: 'task_skipped',
        sessionCode: state.sessionCode,
        task: task.name,
        reason: taskCode === 'ASLCT' ? 'Does not know ASL' : taskCode === 'ID' ? (state.consentStatus.videoDeclined ? 'Video consent declined' : 'User chose to skip') : 'User chose to skip',
        timestamp: new Date().toISOString()
      });
      if (state.currentTaskIndex >= state.sequence.length) showCompletionScreen(); else showProgressScreen();
    }

    // ----- Completion -----
    function showCompletionScreen() {
      document.getElementById('final-code').textContent = state.sessionCode;
      document.getElementById('total-time').textContent = Math.round(state.totalTimeSpent / 60000);
      showScreen('completion-screen');
      document.getElementById('pause-fab').classList.remove('active');
    }

    async function markComplete() {
      const btn = document.getElementById('mark-complete-btn');
      btn.disabled = true;
      await sendToSheets({
        action: 'study_completed',
        sessionCode: state.sessionCode,
        totalDuration: Math.round(state.totalTimeSpent / 60000),
        deviceType: state.isMobile ? 'mobile/tablet' : 'desktop',
        timestamp: new Date().toISOString()
      });
      document.getElementById('completion-message').style.display = 'block';
    }

    // ----- Utilities -----
    function pauseSession() {
      saveState();
      document.getElementById('modal-code').textContent = state.sessionCode;
      document.getElementById('pause-modal').classList.add('active');
      sendToSheets({ action: 'session_paused', sessionCode: state.sessionCode, timestamp: new Date().toISOString() });
    }
    function copyCode(btnEl) {
      const code = document.getElementById('display-code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        if (btnEl) { const original = btnEl.textContent; btnEl.textContent = '✅ Copied!'; setTimeout(() => btnEl.textContent = original, 2000); }
      });
    }
    function copyASLCTCode(btnEl) {
  navigator.clipboard.writeText(CONFIG.ASLCT_ACCESS_CODE)
    .then(() => { if (btnEl) { const o=btnEl.textContent; btnEl.textContent='✅ Copied!'; setTimeout(()=>btnEl.textContent=o,2000);} })
    .catch(() => { alert('Access code: ' + CONFIG.ASLCT_ACCESS_CODE); });
}

    function openEmbedInNewTab(taskCode) {
      const task = TASKS[taskCode];
      if (task?.embedUrl) window.open(task.embedUrl, '_blank', 'noopener');
    }
    function reloadEmbed(iframeId) {
      const f = document.getElementById(iframeId);
      if (f) f.src = f.src;
    }

    function contactEEG() {
      if (!state.sessionCode) {
        const proceed = confirm('Would you like to create your session first? This will give you a code we can reference for the EEG scheduling.');
        if (proceed) { showScreen('new-participant'); return; }
      }
      const modal = document.getElementById('eeg-modal');
      const codeEl = document.getElementById('eeg-session-code');
      if (codeEl) codeEl.textContent = state.sessionCode || 'TBD';
      if (modal) modal.classList.add('active');
      sendToSheets({ action: 'eeg_interest_clicked', sessionCode: state.sessionCode || 'none', participantID: state.participantID || 'none', timestamp: new Date().toISOString() });
    }
    function tryMailto() {
      const code = state.sessionCode || 'TBD';
      const participantEmail = state.email ? `\nParticipant email: ${state.email}` : '';
      const subject = `Local EEG add-on interest - Session ${code}`;
      const body = [
        'Hello Action Brain Lab,',
        '',
        'I live in DC/MD/VA and would like to add the EEG visit for additional compensation.',
        '',
        `Session code: ${code}`,
        participantEmail,
        '',
        'Preferred days or times:',
        'Accessibility or communication preferences: ASL, spoken English, captions',
        '',
        'Thank you.'
      ].join('\n');
      try { window.location.href = `mailto:action.brain.lab@gallaudet.edu?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; }
      catch (e) { alert('Could not open email client. Please manually email: action.brain.lab@gallaudet.edu'); }
    }
    function copyEmail(btnEl) {
      navigator.clipboard.writeText('action.brain.lab@gallaudet.edu').then(() => {
        if (btnEl) { const original = btnEl.textContent; btnEl.textContent = '✅ Copied!'; setTimeout(() => btnEl.textContent = original, 2000); }
      }).catch(() => { alert('Email: action.brain.lab@gallaudet.edu'); });
    }
    function closeEEGModal() { document.getElementById('eeg-modal').classList.remove('active'); }

    function hashCode(str) { let hash = 0; for (let i=0;i<str.length;i++){const c=str.charCodeAt(i); hash=((hash<<5)-hash)+c; hash|=0;} return hash; }

    function submitASLCTIssue() {
      const el = document.getElementById('aslct-issue-text');
      if (!el) return;
      const message = el.value.trim();
      if (!message) return;
      sendToSheets({
        action: 'aslct_issue',
        sessionCode: state.sessionCode || 'none',
        participantID: state.participantID || 'none',
        message,
        timestamp: new Date().toISOString()
      });
      el.value = '';
      alert('Issue submitted. Thank you!');
    }

    // === REPLACE sendToSheets with this ===
async function sendToSheets(payload) {
  if (!CONFIG.SHEETS_URL) return;

  // Add UA + HMAC (if helpers are present/enabled)
  let body = { ...payload, userAgent: navigator.userAgent };
  if (window.addAuthFields) body = await addAuthFields(body);

  try {
    await fetch(CONFIG.SHEETS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // simple request, no preflight
      body: JSON.stringify(body)
    });
    // If you want to verify responses during dev, you can parse here:
    // const out = await res.json().catch(()=>null); console.debug(out);
  } catch (error) {
    console.error('Error sending to sheets:', error);
  }
}


    // ---------- OPTIONAL AUTH HELPERS (frontend) ----------
const SECURITY = {
  ENABLED: true,
  // IMPORTANT: replace with your own long random string and also set it
  // as WEBAPP_SECRET in your Apps Script (step 4B).
  SHARED_SECRET: 'CHANGE_ME_TO_A_LONG_RANDOM_STRING'
};

// Compute HMAC-SHA256(message) with WebCrypto, return base64 string
async function hmacBase64(secret, message) {
  const enc = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw', enc.encode(secret), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
  );
  const sig = await crypto.subtle.sign('HMAC', key, enc.encode(message));
  // base64 encode
  const bytes = new Uint8Array(sig);
  let bin = '';
  for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin);
}

// Attach ts+sig to any payload
async function addAuthFields(payload) {
  if (!SECURITY.ENABLED) return payload;
  const ts = Date.now();
  const who = payload.sessionCode || 'anon';
  const message = `${ts}:${who}`;
  const sig = await hmacBase64(SECURITY.SHARED_SECRET, message);
  return { ...payload, ts, sig };
}

    // DEBUG FUNCTION - Add this before "// Expose to window"
    async function debugVideoUpload() {
      console.log('🔍 Starting video upload debug...');
      
      // Test 1: Check configuration
      console.log('1. Configuration check:');
      console.log('SHEETS_URL:', CONFIG.SHEETS_URL);
      console.log('Is valid URL:', CONFIG.SHEETS_URL.includes('script.google.com'));
      
      // Test 2: Test basic connection
      console.log('2. Testing basic connection...');
      try {
        const testResponse = await fetch(CONFIG.SHEETS_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'test_connection',
            timestamp: new Date().toISOString()
          })
        });
        
        console.log('✅ Connection response:', {
          status: testResponse.status,
          ok: testResponse.ok,
          statusText: testResponse.statusText
        });
        
        if (testResponse.ok) {
          const testResult = await testResponse.json();
          console.log('✅ Connection result:', testResult);
        }
      } catch (error) {
        console.error('❌ Connection failed:', error);
      }
      
      // Test 3: Create a tiny test video blob
      console.log('3. Creating test video blob...');
      try {
        // Create a minimal test "video" (just some bytes)
        const testData = 'test video data for debugging';
        const testBlob = new Blob([testData], { type: 'video/webm' });
        
        console.log('Test blob created:', {
          size: testBlob.size,
          type: testBlob.type
        });
        
        // Test 4: Test base64 conversion
        console.log('4. Testing base64 conversion...');
        const base64Data = await blobToBase64(testBlob);
        const base64VideoData = base64Data.split(',')[1];
        
        console.log('✅ Base64 conversion successful:', {
          originalSize: testBlob.size,
          base64Length: base64VideoData.length
        });
        
        // Test 5: Test actual upload
        console.log('5. Testing upload with tiny file...');
        const uploadData = await addAuthFields({
  action: 'upload_video',
  sessionCode: 'DEBUG123',
  imageNumber: 1,
  videoData: base64VideoData,
  timestamp: new Date().toISOString()
});
const uploadResponse = await fetch(CONFIG.SHEETS_URL, {
  method: 'POST',
  headers: { 'Content-Type': 'text/plain;charset=utf-8' },
  body: JSON.stringify(uploadData)
});

        
        console.log('Upload response:', {
          status: uploadResponse.status,
          ok: uploadResponse.ok,
          statusText: uploadResponse.statusText
        });
        
        if (uploadResponse.ok) {
          const uploadResult = await uploadResponse.json();
          console.log('✅ Upload successful:', uploadResult);
          
          // Clean up test file if it was created
          if (uploadResult.success && uploadResult.fileId) {
            console.log('🧹 Test file created with ID:', uploadResult.fileId);
            console.log('Note: You may want to delete this test file from Google Drive');
          }
        } else {
          const errorText = await uploadResponse.text();
          console.error('❌ Upload failed:', errorText);
        }
        
      } catch (error) {
        console.error('❌ Debug test failed:', error);
      }
      
      console.log('🔍 Debug complete! Check the console messages above.');
    }

    console.log('Debug function loaded! Open browser console and run: debugVideoUpload()');

    // Expose to window
    window.showScreen = showScreen;
    window.createNewSession = createNewSession;
    window.resumeSession = resumeSession;
    window.proceedToConsent = proceedToConsent;
    window.openConsent = openConsent;
    window.markConsentDone = markConsentDone;
    window.declineVideo = declineVideo;
    window.proceedToTasks = proceedToTasks;
    window.continueToCurrentTask = continueToCurrentTask;
    window.pauseSession = pauseSession;
    window.copyCode = copyCode;
    window.copyASLCTCode = copyASLCTCode;
    window.contactEEG = contactEEG;
    window.tryMailto = tryMailto;
    window.copyEmail = copyEmail;
    window.closeEEGModal = closeEEGModal;
    window.completeTask = completeTask;
    window.skipTask = skipTask;
    window.openEmbedInNewTab = openEmbedInNewTab;
    window.reloadEmbed = reloadEmbed;
    // Video upload functions
    window.retryVideoUpload = retryVideoUpload;
    window.continueWithoutUpload = continueWithoutUpload;
     window.debugVideoUpload = debugVideoUpload;
    window.submitASLCTIssue = submitASLCTIssue;
    window.markComplete = markComplete;
  </script>
</body>
</html>





